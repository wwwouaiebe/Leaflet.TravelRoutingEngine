/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 2.2.0
 * Build 00721 - 2021-02-10T21:38:00+0100 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const e=Object.freeze({notSaved:"🔴",modified:"🟡",saved:"🟢"}),t=Object.freeze({fixed:2,invalid:-1,defaultValue:0,metersInKm:1e3}),o=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2}),a=Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"}),n=Object.freeze({fixed:2,defaultValue:0}),r=Object.freeze({defaultValue:0,fixed:6,maxLat:90,minLat:-90,maxLng:180,minLng:-180}),i=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),l=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),s=Object.freeze({width:40,height:40,svgViewboxDim:200}),d=Object.freeze({d0:0,d90:90,d180:180,d270:270,d360:360,d540:540,toRadians:Math.PI/180,fromRadians:180/Math.PI}),c=[.3,10,1],u="http://www.w3.org/2000/svg",g=window.location.protocol,v=new DOMParser;let h=new Map;function m(e){return e.replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;").replaceAll(/"/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}function p(e,t="href"){let o=v.parseFromString("<div>"+e+"</div>","text/html");if(!o||"#document"!==o.nodeName)return{url:"",errorsString:"Parsing error"};let a=o.querySelector("body").firstChild,n="";for(let e=0;e<a.childNodes.length;e++){if("#text"!==a.childNodes[e].nodeName)return{url:"",errorsString:"Invalid characters found in the url"};n+=a.childNodes[e].nodeValue}if(n=n.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),n!==e)return{url:"",errorsString:"Invalid characters found in the url"};let r=["https:"];if("http:"!==g&&"href"!==t||r.push("http:"),"href"===t){r.push("mailto:"),r.push("sms:"),r.push("tel:");let e=n.match(/^#\w*/);if(e&&n===e[0])return{url:n,errorsString:""}}"src"===t&&r.push("data:");let i=null;try{i=new URL(n)}catch(e){return{url:"",errorsString:"Invalid url string"}}if(-1===r.indexOf(i.protocol))return{url:"",errorsString:"Invalid protocol "+i.protocol};if(-1!==["sms:","tel:"].indexOf(i.protocol)&&i.pathname.match(/^\+[0-9,*,#]*$/))return{url:n,errorsString:""};try{encodeURIComponent(i.href)}catch(e){return{url:"",errorsString:"Invalid character in url"}}return{url:n,errorsString:""}}h.set("a",["href","target"]),h.set("div",[]),h.set("del",[]),h.set("em",[]),h.set("figcaption",[]),h.set("figure",[]),h.set("h1",[]),h.set("h2",[]),h.set("h3",[]),h.set("h4",[]),h.set("h5",[]),h.set("h6",[]),h.set("hr",[]),h.set("img",["src","alt","width","height"]),h.set("ins",[]),h.set("li",[]),h.set("mark",[]),h.set("ol",[]),h.set("p",[]),h.set("s",[]),h.set("small",[]),h.set("strong",[]),h.set("span",[]),h.set("sub",[]),h.set("sup",[]),h.set("ul",[]),h.set("svg",["xmlns","viewBox","class"]),h.set("text",["x","y","text-anchor"]),h.set("polyline",["points","class","transform"]);const f=Object.freeze(new class{sanitizeToColor(e){let t=e.match(/^#[0-9,A-F,a-f]{6}$/);return t?t[0]:null}sanitizeToUrl(e,t){return p(e,t)}sanitizeToJsString(e){return function(e){let t=v.parseFromString("<div>"+e+"</div>","text/html");if(!t||"#document"!==t.nodeName)return"";let o=t.querySelector("body").firstChild,a="";for(let e=0;e<o.childNodes.length;e++){if("#text"!==o.childNodes[e].nodeName)return"";a+=o.childNodes[e].nodeValue}return a=a.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),a}(e)}sanitizeToHtmlElement(e,t){!function(e,t){let o=v.parseFromString("<div>"+e+"</div>","text/html");o&&"#document"===o.nodeName?function e(t,o){let a=t.childNodes;for(let n=0;n<a.length;n++){let a=t.childNodes[n],r=a.nodeName.toLowerCase(),i=h.get(r);if(i){i=i.concat(["id","class","dir","title","tanwidth","tanheight"]);let t="svg"===r||"text"===r||"polyline"===r,n=t?document.createElementNS(u,r):document.createElement(r);if(i.forEach(e=>{if(t)a.hasAttributeNS(null,e)&&(n.setAttributeNS(null,e,a.getAttribute(e)),a.removeAttributeNS(null,e));else if(a.hasAttribute(e))if("href"===e||"src"===e){let t=p(a.getAttribute(e),e).url;""!==t&&n.setAttribute(e,t)}else n.setAttribute(e,a.getAttribute(e))}),a.hasAttribute("style")){a.getAttribute("style").split(";").forEach(e=>{let t=e.split(":");2!==t.length||"width"!==t[0].trim()&&"height"!==t[0].trim()||(n.style[t[0].trim()]=t[1].trim())})}o.appendChild(n),e(a,n)}else"#text"===r&&o.appendChild(document.createTextNode(a.nodeValue))}}(o.querySelector("body").firstChild,t):t.textContent=""}(e,t)}sanitizeToHtmlString(e){return function(e){let t="",o="",a=v.parseFromString("<div>"+e.replace("&nbsp;","਀")+"</div>","text/html");return a&&"#document"===a.nodeName?(function e(a){let n=a.childNodes;for(let r=0;r<n.length;r++){let n=a.childNodes[r],i=n.nodeName.toLowerCase(),l=h.get(i);if(l){l=l.concat(["id","class","dir","title","tanwidth","tanheight"]);let a="svg"===i||"text"===i||"polyline"===i;t+="<"+i,l.forEach(e=>{if(a)n.hasAttributeNS(null,e)&&(t+=" "+e+'="'+m(n.getAttribute(e))+'"',n.removeAttribute(e));else if(n.hasAttribute(e))if("href"===e||"src"===e){let a=p(n.getAttribute(e),e).url;""===a?o+="\nAn invalid url ("+n.getAttribute(e)+") was removed from a "+e+" attribute":t+=" "+e+'="'+a+'"',n.removeAttribute(e)}else t+=" "+e+'="'+m(n.getAttribute(e))+'"',n.removeAttribute(e)}),t+=">",e(n),t+="</"+i+">"}else"#text"===i?t+=m(n.nodeValue):o+="\nAn invalid tag "+i+" was removed";if(n.hasAttributes)for(let e=0;e<n.attributes.length;e++)o+="\nAn unsecure attribute "+n.attributes[e].name+'="'+n.attributes[e].value+'" was removed.'}}(a.querySelector("body").firstChild),{htmlString:t,errorsString:o}):{htmlString:"",errorsString:"Parsing error"}}(e)}});let b={autoLoad:!1,map:{center:{lat:50.50923,lng:5.49542},zoom:12},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"}},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},mouseUI:{haveMouseUI:!0},errorUI:{timeOut:1e4,helpTimeOut:3e4,showError:!0,showWarning:!0,showInfo:!0,showHelp:!0},geoLocation:{color:"#ff0000",radius:11,zoomToPosition:!0,zoomFactor:17,options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0}},APIKeys:{showDialogButton:!0,saveToSessionStorage:!0,showAPIKeysInDialog:!0,dialogHaveUnsecureButtons:!0},contextMenu:{timeout:1500},language:"fr",itineraryPointMarker:{color:"#ff0000",weight:2,radius:7,fill:!1},searchPointMarker:{color:"#006400",weight:4,radius:20,fill:!1},searchPointPolyline:{color:"#006400",weight:4,radius:20,fill:!1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},wayPoint:{reverseGeocoding:!1},route:{color:"#ff0000",width:3,dashArray:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3},note:{osmSearchNoteDialog:!1,reverseGeocoding:!1,grip:{size:10,opacity:0,moveOpacity:1},polyline:{color:"#808080",weight:1},haveBackground:!1,svgRoadbookDimCoef:2,svgAnleMaxDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},svgZoom:17,svgRcnRefDistance:20,svgAngleDistance:10,osmCityAdminLevel:{GB:"10",DEFAULT:"8"},svgHamletDistance:200,svgVillageDistance:400,svgCityDistance:1200,svgTownDistance:1500,svgTimeOut:40,maxManeuversNotes:100},noteDialog:{theDevil:{addButton:!1,noteZoom:17},toggleIconDimension:!0,toggleIconTextArea:!1,toggleTooltip:!1,togglePopupContent:!1,toggleAddress:!1,toggleLink:!1,togglePhone:!0,iconAreaHeight:2,popupAreaHeigth:8},itineraryPointZoom:17,routeEditor:{displayEditionInHTMLPage:!0},travelEditor:{clearAfterSave:!0,startMinimized:!0,timeout:1e3,startupRouteEdition:!0},haveBeforeUnloadWarning:!0,overpassApi:{url:"https://lz4.overpass-api.de/api/interpreter"},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},itineraryPane:{showNotes:!0,showManeuvers:!1},colorDialog:{haveSlider:!0,initialRed:0}};let y=new class{get autoLoad(){return b.autoLoad}get map(){return b.map}get travelNotesToolbarUI(){return b.travelNotesToolbarUI}get layersToolbarUI(){return b.layersToolbarUI}get mouseUI(){return b.mouseUI}get errorUI(){return b.errorUI}get APIKeys(){return b.APIKeys}get contextMenu(){return b.contextMenu}get language(){return b.language}get itineraryPointMarker(){return b.itineraryPointMarker}get searchPointMarker(){return b.searchPointMarker}get searchPointPolyline(){return b.searchPointPolyline}get previousSearchLimit(){return b.previousSearchLimit}get nextSearchLimit(){return b.nextSearchLimit}get wayPoint(){return b.wayPoint}get route(){return b.route}get note(){return b.note}get noteDialog(){return b.noteDialog}get itineraryPointZoom(){return b.itineraryPointZoom}get routeEditor(){return b.routeEditor}get travelEditor(){return b.travelEditor}get haveBeforeUnloadWarning(){return b.haveBeforeUnloadWarning}get overpassApi(){return b.overpassApi}get nominatim(){return b.nominatim}get geoLocation(){return b.geoLocation}get printRouteMap(){return b.printRouteMap}get itineraryPane(){return b.itineraryPane}get colorDialog(){return b.colorDialog}overload(e){!function e(t,o){if("object"==typeof t&&"object"==typeof o)try{for(let a in o)"object"==typeof o[a]?e(t[a],o[a]):typeof t[a]==typeof o[a]&&("string"==typeof o[a]?o[a]="color"===a?f.sanitizeToColor(t[a])||o[a]:"url"===a?f.sanitizeToUrl(t[a]).url:f.sanitizeToJsString(t[a]):o[a]=t[a]||o[a]);for(let a in t)"object"==typeof t[a]?("[object Array]"===Object.prototype.toString.call(t[a])?o[a]=o[a]||[]:o[a]=o[a]||{},e(t[a],o[a])):"string"==typeof o.property?o[a]=f.sanitizeToHtmlString(t[a],[]).htmlString:o[a]=t[a]}catch(e){e instanceof Error&&console.error(e)}}(e,b),b=function e(t){for(let o in t)"object"==typeof t[o]&&(t[o]=e(t[o]));return Object.freeze(t)}(b)}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const w=new class{constructor(){Object.freeze(this)}create(e,t,o){let a=null;return"text"===e.toLowerCase()?a=document.createTextNode(t.value||""):(a=document.createElement(e),t&&function(e,t){for(let o in t)try{e[o]=t[o]}catch(e){e instanceof Error&&console.error(e)}}(a,t)),o&&o.appendChild(a),a}};let T=0;function N(){return++T,T}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function x(e){const t=e;return new class{constructor(){Object.freeze(this)}get name(){return t}get version(){return"2.2.0"}get jsonObject(){return{name:t,version:"2.2.0"}}validate(e){if(!Object.getOwnPropertyNames(e).includes("name"))throw new Error("No name for "+t);if(t!==e.name)throw new Error("Invalid name for "+t);if(!Object.getOwnPropertyNames(e).includes("version"))throw new Error("No version for "+t)}}}function L(e){const t=e;let o=[];const a=function(){let e=t();if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");return e.objType.name}();function n(e){if(!e.objType||!e.objType.name||e.objType.name!==a)throw new Error("invalid object name for add function");o.push(e)}function r(){let e=-1;return Object.freeze({get value(){return e<o.length?o[e]:null},get previous(){return 0>=e?null:o[e-1]},get next(){return e<o.length-1?o[e+1]:null},get done(){return++e>=o.length},get first(){return 0===e},get last(){return e>=o.length-1},get index(){return e}})}function i(e){return o.findIndex(t=>t.objId===e)}function l(e,t,a){let n=i(e);if(-1===n)throw new Error("invalid objId for next or previous function");if(1!==a&&-1!==a)throw new Error("invalid direction");let r=t;for(r||(r=()=>!0),n+=a;-1<n&&n<o.length&&!r(o[n]);)n+=a;return-1===n||o.length===n?null:o[n]}return new class{constructor(){Object.freeze(this)}add(e){n(e)}forEach(e){let t=null,o=r();for(;!o.done;)t=e(o.value,t);return t}getAt(e){let t=i(e);return-1===t?null:o[t]}moveTo(e,t,a){let n=i(e),r=i(t);if(-1===n||-1===r)throw new Error("invalid objId for function  myMoveTo");a||r++,o.splice(r,0,o[n]),r<n&&n++,o.splice(n,1)}next(e,t){return l(e,t,1)}previous(e,t){return l(e,t,-1)}remove(e){if(-1===i(e))throw new Error("invalid objId for remove function");o.splice(i(e),1)}removeAll(e){e?o.splice(1,o.length-2):o.length=0}replace(e,t){let n=i(e);if(-1===n)throw new Error("invalid objId for replace function");if(!t.objType||!t.objType.name||t.objType.name!==a)throw new Error("invalid object name for replace function");o[n]=t}reverse(){o.reverse()}sort(e){o.sort(e)}swap(e,t){let a=i(e);if(-1===a||0===a&&t||o.length-1===a&&!t)throw new Error("invalid objId for swap function");let n=o[a];o[a]=o[a+(t?-1:1)],o[a+(t?-1:1)]=n}get first(){return o[0]}get iterator(){return r()}get last(){return o[o.length-1]}get length(){return o.length}get jsonObject(){let e=[],t=r();for(;!t.done;)e.push(t.value.jsonObject);return e}set jsonObject(e){o.length=0;let a=null;e.forEach(e=>{a=t(),a.jsonObject=e,n(a)})}}}let I=new Map;const E=new class{constructor(){Object.freeze(this)}setTranslations(e){e.forEach(e=>I.set(e.msgid,f.sanitizeToJsString(e.msgstr)))}getText(e,t){let o=I.get(e);return t&&o&&Object.getOwnPropertyNames(t).forEach(e=>o=o.replace("{"+e+"}",t[e])),o||e}};const j=new class{constructor(){Object.freeze(this)}get UUID(){let e=new Uint16Array(8);const t=["","-","-","-","-","","",""];window.crypto.getRandomValues(e);let o="";for(let a=0;a<8;a++)o+=e[a].toString(16).padStart(4,"0")+t[a];return o}storageAvailable(e){try{let t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(e){return!1}}saveFile(e,t,o){try{let a=window.URL.createObjectURL(new File([t],e,{type:o||"text/plain"})),n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",e),n.click(),window.URL.revokeObjectURL(a)}catch(e){e instanceof Error&&console.error(e)}}formatTime(e){let t=Math.floor(e);if(0===t)return"";let o=Math.floor(t/86400),a=Math.floor(t%86400/3600),n=Math.floor(t%3600/60),r=Math.floor(t%60);return 0<o?o+" "+E.getText("Utilities - Day")+" "+a+" "+E.getText("Utilities - Hour"):0<a?a+" "+E.getText("Utilities - Hour")+" "+n+" "+E.getText("Utilities - Minute"):0<n?n+" "+E.getText("Utilities - Minute"):r+" "+E.getText("Utilities - Second")}formatDistance(e){let o=Math.floor(e);return 0>=o?"0 km":Math.floor(o/t.metersInKm)+","+Math.floor(o%t.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}formatLat(e){return e>0?e.toFixed(r.fixed)+" N":(-e).toFixed(r.fixed)+" S"}formatLng(e){return e>0?e.toFixed(r.fixed)+" E":(-e).toFixed(r.fixed)+" W"}formatLatLng(e){return 0===e[0]&&0===e[1]?"":this.formatLat(e[0])+" - "+this.formatLng(e[1])}},P=x("WayPoint"),D=new WeakMap;function C(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+P.name);P.validate(e.objType),P.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.address=e.name,e.name="";case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+P.name)}}(e);let t=Object.getOwnPropertyNames(e);return["address","name","lat","lng","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+P.name)}),e}class R{constructor(){this.name="",this.address="",this.lat=r.defaultValue,this.lng=r.defaultValue,D.set(this,N()),Object.seal(this)}get fullName(){let e=""===this.name?this.address:this.name+", "+this.address;return""===e&&(e=j.formatLatLng([this.lat,this.lng])),e}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objId(){return D.get(this)}get objType(){return P}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),objId:D.get(this),objType:P.jsonObject}}set jsonObject(e){let t=C(e);this.address=t.address||"",this.name=t.name||"",this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,D.set(this,N()),this.validateData()}validateData(){"string"==typeof this.address?this.address=f.sanitizeToJsString(this.address):this.address="","string"==typeof this.name?this.name=f.sanitizeToJsString(this.name):this.name="","number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue)}}function M(){return new R}const S=x("ItineraryPoint"),A=new WeakMap;function O(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+S.name);S.validate(e.objType),S.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.elev=n.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+S.name)}}(e);let t=Object.getOwnPropertyNames(e);return["lat","lng","distance","elev","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+S.name)}),e}class k{constructor(){this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=t.defaultValue,this.elev=n.defaultValue,A.set(this,N()),Object.seal(this)}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return S}get objId(){return A.get(this)}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(t.fixed)),elev:parseFloat(this.elev.toFixed(n.fixed)),objId:A.get(this),objType:S.jsonObject}}set jsonObject(e){let o=O(e);this.lat=o.lat||r.defaultValue,this.lng=o.lng||r.defaultValue,this.distance=o.distance||t.defaultValue,this.elev=o.elev||n.defaultValue,A.set(this,N()),this.validateData()}validateData(){"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.elev&&(this.elev=n.defaultValue)}}function U(){return new k}const B=x("Maneuver"),H=new WeakMap;function z(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+B.name);B.validate(e.objType),B.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===e.iconName&&(e.distance=t.defaultValue);case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+B.name)}}(e);let o=Object.getOwnPropertyNames(e);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach(e=>{if(!o.includes(e))throw new Error("No "+e+" for "+B.name)}),e}class V{constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=-1,this.distance=t.defaultValue,this.duration=t.defaultValue,H.set(this,N()),Object.seal(this)}get objType(){return B}get objId(){return H.get(this)}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(t.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:H.get(this),objType:B.jsonObject}}set jsonObject(e){let o=z(e);this.iconName=o.iconName||"",this.instruction=o.instruction||"",this.distance=o.distance||t.defaultValue,this.duration=o.duration||t.defaultValue,this.itineraryPointObjId=o.itineraryPointObjId||-1,H.set(this,N()),this.validateData()}validateData(){"string"==typeof this.iconName?this.iconName=f.sanitizeToJsString(this.iconName):this.iconName="","string"==typeof this.instruction?this.instruction=f.sanitizeToJsString(this.instruction):this.instruction="","number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.duration&&(this.duration=t.defaultValue),"number"!=typeof this.itineraryPointObjId&&(this.itineraryPointObjId=-1)}}function F(){return new V}const W=x("Itinerary"),K=new WeakMap;function _(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+W.name);W.validate(e.objType),W.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.hasProfile=!1,e.ascent=0,e.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+W.name)}}(e);let t=Object.getOwnPropertyNames(e);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+W.name)}),e}class Z{constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=L(U),this.maneuvers=L(F),K.set(this,N()),Object.seal(this)}get objType(){return W}get objId(){return K.get(this)}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:K.get(this),objType:W.jsonObject}}set jsonObject(e){let t=_(e);this.hasProfile=t.hasProfile||!1,this.ascent=t.ascent||0,this.descent=t.descent||0,this.itineraryPoints.jsonObject=t.itineraryPoints||[],this.maneuvers.jsonObject=t.maneuvers||[],this.provider=t.provider||"",this.transitMode=t.transitMode||"",K.set(this,N());let o=new Map,a=0,n=this.itineraryPoints.iterator;for(;!n.done;)o.set(t.itineraryPoints[a].objId,n.value.objId),a++;let r=this.maneuvers.iterator;for(;!r.done;)r.value.itineraryPointObjId=o.get(r.value.itineraryPointObjId);this.validateData()}validateData(){"boolean"!=typeof this.hasProfile&&(this.hasProfile=!1),"number"!=typeof this.ascent&&(this.ascent=0),"number"!=typeof this.descent&&(this.descent=0),"string"==typeof this.provider?this.provider=f.sanitizeToJsString(this.provider):this.provider="","string"==typeof this.transitMode?this.transitMode=f.sanitizeToJsString(this.transitMode):this.transitMode=""}}function X(){return new Z}const q=x("Note"),G=new WeakMap;function J(e){return e.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}function Y(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+q.name);q.validate(e.objType),q.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":"string"==typeof e.iconHeight&&(e.iconHeight=Number.parseInt(e.iconHeight)),"string"==typeof e.iconWidth&&(e.iconWidth=Number.parseInt(e.iconWidth)),e.iconContent=J(e.iconContent),e.popupContent=J(e.popupContent),e.tooltipContent=J(e.tooltipContent),e.phone=J(e.phone),e.address=J(e.address);case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+q.name)}}(e);let t=Object.getOwnPropertyNames(e);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+q.name)}),e}class ${constructor(){this.iconHeight=0,this.iconWidth=0,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=r.defaultValue,this.iconLng=r.defaultValue,this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=t.invalid,this.chainedDistance=t.defaultValue,G.set(this,N()),Object.seal(this)}get isRouteNote(){return this.distance!==t.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(e){this.iconLat=e[0],this.iconLng=e[1]}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return q}get objId(){return G.get(this)}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(r.fixed)),iconLng:parseFloat(this.iconLng.toFixed(r.fixed)),lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(t.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(t.fixed)),objId:G.get(this),objType:q.jsonObject}}set jsonObject(e){let o=Y(e);this.iconHeight=o.iconHeight||0,this.iconWidth=o.iconWidth||0,this.iconContent=o.iconContent||"",this.popupContent=o.popupContent||"",this.tooltipContent=o.tooltipContent||"",this.phone=o.phone||"",this.url=o.url||"",this.address=o.address||"",this.iconLat=o.iconLat||r.defaultValue,this.iconLng=o.iconLng||r.defaultValue,this.lat=o.lat||r.defaultValue,this.lng=o.lng||r.defaultValue,this.distance=o.distance||t.invalid,this.chainedDistance=o.chainedDistance||t.defaultValue,G.set(this,N()),this.validateData(!0)}validateData(e){if("number"!=typeof this.iconHeight&&(this.iconHeight=0),"number"!=typeof this.iconWidth&&(this.iconWidth=0),"string"==typeof this.iconContent){let t=f.sanitizeToHtmlString(this.iconContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.iconContent+")"),this.iconContent=t.htmlString}else this.iconContent="";if("string"==typeof this.popupContent){let t=f.sanitizeToHtmlString(this.popupContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.popupContent+")"),this.popupContent=t.htmlString}else this.popupContent="";if("string"==typeof this.tooltipContent){let t=f.sanitizeToHtmlString(this.tooltipContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.tooltipContent+")"),this.tooltipContent=t.htmlString}else this.tooltipContent="";if("string"==typeof this.phone){let t=f.sanitizeToHtmlString(this.phone);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.phone+")"),this.phone=t.htmlString}else this.phone="";if("string"==typeof this.url&&""!==this.url){let t=f.sanitizeToUrl(this.url);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.url+")"),this.url=encodeURI(t.url)}else this.url="";"string"==typeof this.address?this.address=f.sanitizeToHtmlString(this.address).htmlString:this.address="","number"!=typeof this.iconLat&&(this.iconLat=r.defaultValue),"number"!=typeof this.iconLng&&(this.iconLng=r.defaultValue),"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=t.invalid),"number"!=typeof this.chainedDistance&&(this.chainedDistance=t.defaultValue)}}function Q(){return new $}const ee=x("Route"),te=new WeakMap;function oe(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+ee.name);ee.validate(e.objType),ee.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":e.dashArray=0,e.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.edited=i.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.editionStatus=e.edited;case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+ee.name)}}(e);let t=Object.getOwnPropertyNames(e);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+ee.name)}),e}class ae{constructor(){this.name="",this.wayPoints=L(M),this.wayPoints.add(M()),this.wayPoints.add(M()),this.notes=L(Q),this.itinerary=X(),this.width=y.route.width,this.color=y.route.color,this.dashArray=y.route.dashArray,this.chain=!0,this.chainedDistance=t.defaultValue,this.distance=t.defaultValue,this.duration=t.defaultValue,this.editionStatus=i.notEdited,this.hidden=!1,te.set(this,N()),Object.seal(this)}get computedName(){let e=this.name;return""===e&&(e=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),e}get objId(){return te.get(this)}get objType(){return ee}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(t.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(t.fixed)),objId:te.get(this),objType:ee.jsonObject}}set jsonObject(e){let t=oe(e);this.name=t.name||"",this.wayPoints.jsonObject=t.wayPoints||[],this.notes.jsonObject=t.notes||[],this.itinerary.jsonObject=t.itinerary||X().jsonObject,this.width=t.width||y.route.width,this.color=t.color||"#000000",this.dashArray=t.dashArray||0,this.chain=t.chain||!1,this.distance=t.distance,this.duration=t.duration,this.editionStatus=t.editionStatus||i.notEdited,this.hidden=t.hidden||!1,this.chainedDistance=t.chainedDistance,te.set(this,N()),this.validateData()}validateData(){"string"==typeof this.name?this.name=f.sanitizeToJsString(this.name):this.name="","number"!=typeof this.width&&(this.width=y.route.width),"string"==typeof this.color?this.color=f.sanitizeToColor(this.color)||y.route.color:this.color=y.route.color,"number"!=typeof this.dashArray&&(this.dashArray=0),this.dashArray>=y.route.dashChoices.length&&(this.dashArray=0),"boolean"!=typeof this.chain&&(this.chain=!1),"number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.duration&&(this.duration=t.defaultValue),"number"!=typeof this.editionStatus&&(this.editionStatus=i.notEdited),"boolean"!=typeof this.hidden&&(this.hidden=!1),"number"!=typeof this.chainedDistance&&(this.chainedDistance=t.defaultValue)}}function ne(){return new ae}const re=x("Travel"),ie=new WeakMap;function le(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+re.name);re.validate(e.objType),re.version!==e.objType.version&&function(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.editedRoute=ne();case"1.5.0":if(e.userData.layerId){let t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find(t=>t.layerId===e.userData.layerId);e.layerName=t?t.layerName:"OSM - Color"}else e.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":e.objType.version="2.2.0";break;default:throw new Error("invalid version for "+re.name)}}(e);let t=Object.getOwnPropertyNames(e);return["name","editedRoute","routes","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+re.name)}),e}class se{constructor(){this.editedRoute=ne(),this.routes=L(ne),this.notes=L(Q),this.layerName="OSM - Color",this.name="",this.readOnly=!1,ie.set(this,N()),Object.seal(this)}get objId(){return ie.get(this)}get objType(){return re}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:ie.get(this),objType:re.jsonObject}}set jsonObject(e){let t=le(e);this.editedRoute.jsonObject=t.editedRoute,this.layerName=e.layerName||"OSM - Color",this.name=t.name||"",this.readOnly=t.readOnly||!1,this.routes.jsonObject=t.routes||[],this.notes.jsonObject=t.notes||[],ie.set(this,N()),this.validateData()}validateData(){"string"==typeof this.layerName?this.layerName=f.sanitizeToJsString(this.layerName):this.layerName="OSM - Color","string"==typeof this.name?this.name=f.sanitizeToJsString(this.name):this.name="TravelNotes","boolean"!=typeof this.readOnly&&(this.readOnly=!0)}}function de(){return new se}let ce=new Map,ue=new Map,ge=Object.seal({provider:"",transitMode:""}),ve=j.UUID;const he=new class{constructor(){this.map=null,this.travel=de(),this.editedRouteObjId=-1,this.searchData=[],Object.seal(this)}get providers(){return ce}get mapObjects(){return ue}get routing(){return ge}get UUID(){return ve}};const me=new class{constructor(){Object.freeze(this)}getLatLngElevAtDist(e,t){if(e.distance<=t||0>=t)return null;let o=0,a=e.itinerary.itineraryPoints.iterator;for(;o<t&&!a.done;)o+=a.value.distance;let n=a.value;a.done;let r=(n.distance-o+t)/n.distance;return Object.freeze({latLng:[n.lat+(a.value.lat-n.lat)*r,n.lng+(a.value.lng-n.lng)*r],elev:n.elev+(a.value.elev-n.elev)*r,ascent:100*(a.value.elev-n.elev)/n.distance,routeDistance:t})}getClosestLatLngDistance(e,o){if(0===e.itinerary.itineraryPoints.length)return null;let a=e.itinerary.itineraryPoints.iterator;a.done;let n=Number.MAX_VALUE,r=window.L.Projection.SphericalMercator.project(window.L.latLng(o[0],o[1])),i=window.L.Projection.SphericalMercator.project(window.L.latLng(a.value.lat,a.value.lng)),l=null,s=t.defaultValue,d=a.value.distance;for(;!a.done;){let e=window.L.Projection.SphericalMercator.project(window.L.latLng(a.value.lat,a.value.lng)),t=window.L.LineUtil.pointToSegmentDistance(r,i,e);t<n&&(n=t,l=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(r,i,e)),s=d-l.distanceTo(window.L.latLng(a.value.lat,a.value.lng))),d+=a.value.distance,i=e}return Object.freeze({latLng:[l.lat,l.lng],distance:s})}getLatLngBounds(e){let t=window.L.latLng([r.maxLat,r.maxLng]),o=window.L.latLng([r.minLat,r.minLng]);return e.forEach(e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),o.lat=Math.max(o.lat,e[0]),o.lng=Math.max(o.lng,e[1])}),window.L.latLngBounds(t,o)}getSquareBoundingBox(e,t){let o=t/6371e3*d.fromRadians,a=e[0]*d.toRadians,n=Math.acos((Math.cos(t/6371e3)-Math.sin(a)**2)/Math.cos(a)**2)*d.fromRadians;return window.L.latLngBounds(window.L.latLng([e[0]-o,e[1]-n]),window.L.latLng([e[0]+o,e[1]+n]))}project(e,t){let o=he.map.project(window.L.latLng(e),t);return[o.x,o.y]}screenCoordToLatLng(e,t){let o=he.map.containerPointToLatLng(window.L.point(e,t));return[o.lat,o.lng]}addPoints(e,t){return[e[0]+t[0],e[1]+t[1]]}subtrackPoints(e,t){return[e[0]-t[0],e[1]-t[1]]}};function pe(){let e=0,t=0,o=0,a=0,n=0,r=0,i=!1,l=he.map.getCenter(),s=0,d=0,c=null,u=null,g=null,v=null,h=null,m=null,p=null,b=null,y=null,T=null,N=null,x=null,L=null,I=!0,j=null,P=null,D=null;function C(e){I&&("Escape"===e.key||"Esc"===e.key?x.click():"Enter"===e.key&&N.click())}function R(i){o+=i.screenX-e,a+=i.screenY-t,o=Math.min(Math.max(o,20),n-g.clientWidth-20),a=Math.max(a,20);let l=r-Math.max(a,0)-20;g.style.top=String(a)+"px",g.style.left=String(o)+"px",g.style["max-height"]=String(l)+"px"}function M(o){try{o.dataTransfer.setData("Text","1")}catch(e){e instanceof Error&&console.error(e)}e=o.screenX,t=o.screenY}function S(){document.removeEventListener("keydown",C,!0),document.querySelector("body").removeChild(c)}function A(){S(),D("Canceled by user")}function O(){let e=null;L&&(e=L(),!e)||(N.removeEventListener("click",O,!1),S(),P(e))}function k(e){"TravelNotes-Background"===e.target.id&&(i=!0,s=e.screenX,d=e.screenY,l=he.map.getCenter())}function U(e){if(i){e.preventDefault(),e.stopPropagation();let t=me.screenCoordToLatLng(s,d),o=me.screenCoordToLatLng(e.screenX,e.screenY);he.map.panTo([l.lat+t[0]-o[0],l.lng+t[1]-o[1]])}}function B(e){"TravelNotes-Background"===e.target.id&&(U(e),i=!1)}function H(e){if("TravelNotes-Background"!==e.target.id)return;let t=he.map.getZoom()-Math.round(e.deltaY/100);t=Math.min(he.map.getMaxZoom(),t),t=Math.max(he.map.getMinZoom(),t),he.map.setZoomAround(window.L.point(e.clientX,e.clientY),t)}function z(e){e.preventDefault()}function V(e,t){P=e,D=t,document.querySelector("body").appendChild(c),document.addEventListener("keydown",C,!0),n=c.clientWidth,r=c.clientHeight,function(){o=(n-g.clientWidth)/2,a=(r-g.clientHeight)/2,o=Math.min(Math.max(o,20),n-g.clientWidth-20),a=Math.max(a,20);let e=r-Math.max(a,0)-20;g.style.top=String(a)+"px",g.style.left=String(o)+"px",g.style["max-height"]=String(e)+"px"}(),j&&j()}c=w.create("div",{id:"TravelNotes-Background",className:"TravelNotes-Background"}),c.addEventListener("dragover",()=>null,!1),c.addEventListener("drop",()=>null,!1),c.addEventListener("mousedown",k,!1),c.addEventListener("mouseup",B,!1),c.addEventListener("mousemove",U,!1),c.addEventListener("wheel",H,!1),c.addEventListener("contextmenu",z,!1),g=w.create("div",{className:"TravelNotes-BaseDialog-Container"},c),u=w.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},g),u.addEventListener("dragstart",M,!1),u.addEventListener("dragend",R,!1),x=w.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:E.getText("BaseDialog - Cancel")},u),x.addEventListener("click",A,!1),v=w.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},g),h=w.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},g),m=w.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},g),p=w.create("div",{className:"TravelNotes-BaseDialog-WaitDiv"},g),T=w.create("div",{className:"TravelNotes-WaitAnimationBullet TravelNotes-Hidden"},y=w.create("div",{className:"TravelNotes-WaitAnimation TravelNotes-Hidden"},p)),b=w.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},g),N=w.create("div",{textContent:"🆗",className:"TravelNotes-BaseDialog-Button"},b),N.addEventListener("click",O,!1);return new class{constructor(){Object.freeze(this)}set okButtonListener(e){L=e}set keyboardEventListenerEnabled(e){I=e}set onShow(e){j=e}set title(e){v.textContent=e}get content(){return h}get footer(){return b}get okButton(){return N}get cancelButton(){return x}showError(e){m.textContent="",f.sanitizeToHtmlElement(e,m),m.classList.remove("TravelNotes-Hidden")}hideError(){m.textContent="",m.classList.add("TravelNotes-Hidden")}showWait(){T.classList.remove("TravelNotes-Hidden"),y.classList.remove("TravelNotes-Hidden"),N.classList.add("TravelNotes-Hidden")}hideWait(){T.classList.add("TravelNotes-Hidden"),y.classList.add("TravelNotes-Hidden"),N.classList.remove("TravelNotes-Hidden")}show(){return new Promise(V)}}}function fe(e){let t=null,o=null,a=null;function n(){return t.hideError(),!e||!(a.value.length<12)&&a.value.match(RegExp("[0-9]+"))&&a.value.match(RegExp("[a-z]+"))&&a.value.match(RegExp("[A-Z]+"))&&a.value.match(RegExp("[^0-9a-zA-Z]"))?(new window.TextEncoder).encode(a.value):(t.showError("<p>"+E.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+E.getText("PasswordDialog - Password rules2")+"</li><li>"+E.getText("PasswordDialog - Password rules3")+"</li><li>"+E.getText("PasswordDialog - Password rules4")+"</li><li>"+E.getText("PasswordDialog - Password rules5")+"</li><li>"+E.getText("PasswordDialog - Password rules6")+"</li></ul>"),void a.focus())}return t=pe(),t.title=E.getText("PasswordDialog - password"),t.okButtonListener=n,o=w.create("div",null,t.content),a=w.create("input",{type:"password"},o),t.onShow=function(){a.focus()},t}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function be(){function e(e){return window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"])}function t(e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode("Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."),iterations:1e6,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}return new class{constructor(){Object.freeze(this)}encryptData(o,a,n,r){!function(o,a,n,r){let i=window.crypto.getRandomValues(new Uint8Array(16));r.then(e).then(t).then((function(e){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},e,o)})).then((function(e){a(new Blob([i,new Uint8Array(e)],{type:"application/octet-stream"}))})).catch(n)}(o,a,n,r)}decryptData(o,a,n,r){!function(o,a,n,r){r.then(e).then(t).then((function(e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(o.slice(0,16))},e,new Uint8Array(o.slice(16)))})).then(a).catch(n)}(o,a,n,r)}}}let ye=null,we=null,Te=null,Ne=null,xe=y.errorUI.showHelp;function Le(){xe=!Te.checked}function Ie(){we&&(clearTimeout(we),we=null),ye.classList.remove("TravelNotes-ErrorsUI-Error"),ye.classList.remove("TravelNotes-ErrorsUI-Warning"),ye.classList.remove("TravelNotes-ErrorsUI-Info"),ye.classList.remove("TravelNotes-ErrorsUI-Help"),ye.classList.add("TravelNotes-ErrorsUI-Hidden"),Te&&(Te.removeEventListener("change",Le,!1),Te=null,Ne=null),ye.textContent=""}function Ee(e,t){if("Error"===t&&!y.errorUI.showError||"Warning"===t&&!y.errorUI.showWarning||"Info"===t&&!y.errorUI.showInfo||"Help"===t&&!y.errorUI.showHelp||"Help"===t&&!xe)return;we&&Ie();let o=w.create("div",{id:"TravelNotes-ErrorsUI-Header"},ye);w.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},o).addEventListener("click",Ie,!1),f.sanitizeToHtmlElement(e,w.create("div",{id:"TravelNotes-ErrorsUI-Message"},ye)),ye.classList.add("TravelNotes-ErrorsUI-"+t);let a=y.errorUI.timeOut;"Help"===t&&(Ne=w.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv"},ye),Te=w.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},Ne),Te.addEventListener("change",Le,!1),w.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",for:"TravelNotes-ErrorsUI-HelpInput",textContent:E.getText("ErrorUI - Dont show again")},Ne),a=y.errorUI.helpTimeOut),ye.classList.remove("TravelNotes-ErrorsUI-Hidden"),we=setTimeout(Ie,a)}const je=new class{constructor(){Object.freeze(this)}createUI(){ye||(ye=w.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-ErrorsUI-Hidden"},document.querySelector("body")))}showError(e){Ee(e,"Error")}showWarning(e){Ee(e,"Warning")}showInfo(e){Ee(e,"Info")}showHelp(e){Ee(e,"Help")}};function Pe(e,t){let o=null,a=null,n=null,r=null,i=null,l=null,s=null,d=null,c=null,u=null,g=null;function v(){let e=[],t=n.childNodes;for(let o=0;o<t.length;o++)e.push({providerName:t[o].childNodes[0].value,providerKey:t[o].childNodes[1].value});return e}function h(){let e=!0;o.hideError();let t=n.childNodes;for(let o=0;o<t.length;o++)e=e&&""!==t[o].childNodes[0].value,e=e&&""!==t[o].childNodes[1].value;return e||o.showError(E.getText("APIKeysDialog - empty API key name or value")),e}function m(e){e.stopPropagation(),e.target.parentNode.parentNode.removeChild(e.target.parentNode)}function p(e){let t=w.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"},n);w.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:E.getText("APIKeysDialog - provider name")},t),w.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:E.getText("APIKeysDialog - API key"),type:y.APIKeys.showAPIKeysInDialog?"text":"password"},t),w.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:E.getText("APIKeysDialog - delete API key"),textContent:"❌"},t).addEventListener("click",m,!1)}function f(e){o.hideWait(),o.keyboardEventListenerEnabled=!0,e&&"Canceled by user"!==e&&o.showError(E.getText("APIKeysDialog - An error occurs when reading the file"))}function b(e){let t=null;try{t=JSON.parse((new TextDecoder).decode(e))}catch(e){return void f(e)}for(;n.firstChild;)n.removeChild(n.firstChild);t.forEach(e=>p(e)),o.hideWait(),o.hideError(),o.keyboardEventListenerEnabled=!0}function T(e){be().decryptData(e,b,f,fe(!1).show())}function N(e){e.stopPropagation(),o.showWait(),o.keyboardEventListenerEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then(e=>{200===e.status&&e.ok?e.arrayBuffer().then(T):f(new Error("Invalid http status"))}).catch(e=>{f(e),e instanceof Error&&console.error(e)})}function x(){o.showError(E.getText("APIKeysDialog - An error occurs when saving the keys")),o.hideWait(),o.keyboardEventListenerEnabled=!0}function L(e){o.hideError(),o.hideWait();let t=URL.createObjectURL(e),a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download","APIKeys"),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t),o.keyboardEventListenerEnabled=!0}function I(e){e.stopPropagation(),o.hideError(),h()&&(o.showWait(),o.keyboardEventListenerEnabled=!1,be().encryptData((new window.TextEncoder).encode(JSON.stringify(v())),L,x,fe(!0).show()))}function P(e){o.hideError(),o.showWait(),o.keyboardEventListenerEnabled=!1,e.stopPropagation();let t=new FileReader;t.onload=function(){be().decryptData(t.result,b,f,fe(!1).show())},t.readAsArrayBuffer(e.target.files[0])}function D(){r.click()}function C(e){e.stopPropagation(),p({providerName:"",providerKey:""})}function R(e){e.stopPropagation(),o.hideError(),h()&&j.saveFile("APIKeys.json",JSON.stringify(v()))}function M(e){e.stopPropagation(),o.hideError();let t=new FileReader;t.onload=function(){try{let e=JSON.parse(t.result);for(;n.firstChild;)n.removeChild(n.firstChild);e.forEach(e=>p(e))}catch(e){o.showError(e.message),e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}function S(){i.click()}function A(){if(o.hideError(),h())return v()}return o=pe(),o.title=E.getText("APIKeysDialog - API keys"),o.okButtonListener=A,a=w.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"},o.content),window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&(t&&(l=w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("APIKeysDialog - Reload from server"),textContent:"🔄"},a),l.addEventListener("click",N,!1)),s=w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("APIKeysDialog - Save to file"),textContent:"💾"},a),s.addEventListener("click",I,!1),r=w.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},a),r.addEventListener("change",P,!1),d=w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("APIKeysDialog - Open file"),textContent:"📂"},a),d.addEventListener("click",D,!1)),c=w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("APIKeysDialog - new API key"),textContent:"+"},a),c.addEventListener("click",C,!1),y.APIKeys.dialogHaveUnsecureButtons&&(u=w.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:E.getText("APIKeysDialog - Save to json file"),textContent:"💾"},a),u.addEventListener("click",R,!1),i=w.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},a),i.addEventListener("change",M,!1),g=w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("APIKeysDialog - Open json file"),textContent:"📂"},a),g.addEventListener("click",S,!1)),n=w.create("div",{id:"TravelNotes-APIKeysDialog-DataDiv"},o.content),e.forEach(e=>p(e)),je.showHelp("<p>"+E.getText("Help - Complete the APIKeys1")+"</p><p>"+E.getText("Help - Complete the APIKeys2")+"</p><p>"+E.getText("Help - Complete the APIKeys3")+"</p>"),o}const De=new class{constructor(){Object.freeze(this)}dispatch(e,t){let o=function(e){return-1<["showitinerary","updateitinerary","showtravelnotes","updatetravelnotes","showsearch","updatesearch","setrouteslist","setprovider","providersadded","travelnameupdated","settransitmode"].indexOf(e)?document.getElementById("TravelNotes-UI-MainDiv"):-1<["removeobject","removeallobjects","zoomto","additinerarypointmarker","addsearchpointmarker","addrectangle","addwaypoint","layerchange","geolocationstatuschanged","geolocationpositionchanged","routeupdated","routepropertiesupdated","noteupdated","roadbookupdate","profileclosed"].indexOf(e)?document:null}(e);if(o){let a=new Event(e);t&&(a.data=t),o.dispatchEvent(a)}}};let Ce=new Map,Re=!1;function Me(e){return Ce.get(e.toLowerCase())}function Se(e,t){Ce.set(e.toLowerCase(),t)}function Ae(e){sessionStorage.clear(),Ce.clear();let t=j.storageAvailable("sessionStorage")&&y.APIKeys.saveToSessionStorage;e.forEach(e=>{t&&sessionStorage.setItem(e.providerName.toLowerCase()+"ProviderKey",btoa(e.providerKey)),Se(e.providerName,e.providerKey)}),he.providers.forEach(e=>{e.providerKey=Me(e.name)||""}),De.dispatch("providersadded")}function Oe(e){Ae(JSON.parse((new TextDecoder).decode(e)))}function ke(e){e instanceof Error&&console.error(e),e&&"Canceled by user"!==e&&je.showError(E.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}function Ue(e){window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&be().decryptData(e,Oe,ke,fe(!1).show())}const Be=new class{constructor(){Object.freeze(this)}hasKey(e){return Ce.has(e.toLowerCase())}getUrl(e){if(e.providerKeyNeeded){let t=Ce.get(e.providerName.toLowerCase());return t?e.url.replace("{providerKey}",t):null}return e.url}setKeysFromServerFile(){let e=!1;0!==function(){let e=0;for(let t=0;t<sessionStorage.length;t++){let o=sessionStorage.key(t);"ProviderKey"===o.substr(o.length-"ProviderKey".length)&&(Se(o.substr(0,o.length-"ProviderKey".length),atob(sessionStorage.getItem(o))),e++)}return he.providers.forEach(e=>{e.providerKey=Me(e.name)||""}),e}()&&(De.dispatch("providersadded"),e=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then(t=>{200===t.status&&t.ok&&(Re=!0,e||t.arrayBuffer().then(Ue))}).catch(e=>{e instanceof Error&&console.error(e)})}setKeysFromDialog(){let e=[];Ce.forEach((t,o)=>e.push({providerName:o,providerKey:t})),e.sort((e,t)=>e.providerName.localeCompare(t.providerName)),Pe(e,Re).show().then(e=>Ae(e)).catch(e=>{e instanceof Error&&console.error(e)})}addProvider(e){let t=e.name.toLowerCase(),o=Me(t);e.providerKeyNeeded&&!o&&j.storageAvailable("sessionStorage")&&(o=sessionStorage.getItem(t),o&&(o=atob(o))),e.providerKeyNeeded&&o&&(e.providerKey=o),he.providers.set(e.name.toLowerCase(),e)}};const He=new class{constructor(){Object.freeze(this)}getRoute(e){let t=null;return t=he.travel.routes.getAt(e),t||e===he.travel.editedRoute.objId&&(t=he.travel.editedRoute),t}getNoteAndRoute(e){let t=null,o=null;if(t=he.travel.notes.getAt(e),!t){let a=he.travel.routes.iterator;for(;!a.done&&!t;)t=a.value.notes.getAt(e),t&&(o=a.value);t||(t=he.travel.editedRoute.notes.getAt(e),t&&(o=he.travel.editedRoute))}return Object.freeze({note:t,route:o})}getWayPoint(e){let t=he.travel.editedRoute.wayPoints.getAt(e);if(!t){let o=he.travel.routes.iterator;for(;!o.done&&!t;)t=o.value.wayPoints.getAt(e)}return t}};function ze(){let e="",t="",o=null;function a(a){o=He.getRoute(a),o&&(t='time="'+(new Date).toISOString()+'" ',e='<?xml version="1.0"?>\n',e+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="leaflet.TravelNotes">',function(){let a=o.wayPoints.iterator;for(;!a.done;)e+='\n\t<wpt lat="'+a.value.lat+'" lon="'+a.value.lng+'" '+t+"/>"}(),function(){e+="\n\t<rte>";let a=o.itinerary.maneuvers.iterator;for(;!a.done;){let n=o.itinerary.itineraryPoints.getAt(a.value.itineraryPointObjId),r=a.value.instruction.replace("&","&amp;").replace('"',"&apos;").replace('"',"&quote;").replace(">","&gt;").replace("<","&lt;");e+='\n\t\t<rtept lat="'+n.lat+'" lon="'+n.lng+'" '+t+'desc="'+r+'" />'}e+="\n\t</rte>"}(),function(){e+="\n\t<trk>",e+="\n\t\t<trkseg>";let a=o.itinerary.itineraryPoints.iterator;for(;!a.done;)e+='\n\t\t\t<trkpt lat="'+a.value.lat+'" lon="'+a.value.lng+'" '+t+" />";e+="\n\t\t</trkseg>",e+="\n\t</trk>"}(),e+="\n</gpx>",function(){let t=(""===he.travel.name?"":he.travel.name+" - ")+o.computedName;""===t&&(t="TravelNote"),t+=".gpx",j.saveFile(t,e)}())}return new class{constructor(){Object.freeze(this)}routeToGpx(e){a(e)}}}class Ve{constructor(e,t,o){this.red="number"==typeof e&&255>=e?e:255,this.green="number"==typeof t&&255>=t?t:255,this.blue="number"==typeof o&&255>=o?o:255,Object.seal(this)}get cssColor(){return"#"+this.red.toString(16).padStart(2,"0")+this.green.toString(16).padStart(2,"0")+this.blue.toString(16).padStart(2,"0")}set cssColor(e){this.red=parseInt(e.substr(1,2),16),this.green=parseInt(e.substr(3,2),16),this.blue=parseInt(e.substr(5,2),16)}clone(){return new Ve(this.red,this.green,this.blue)}copyTo(e){e.red=this.red,e.green=this.green,e.blue=this.blue}}function Fe(e){let t=null,o=null,a=null,n=null,r=null,i=null;function l(){return e.color=document.getElementById("TravelNotes-ColorDialog-ColorSampleDiv").color.cssColor,e.computedName!==a.value&&(e.name=a.value),e.width=parseInt(n.value),e.chain=r.checked,e.dashArray=i.selectedIndex,e.validateData(),e}return t=function(e){let t=null,o=new Ve;o.cssColor=e;let a=null,n=[],r=null,i=null,l=null,s=null;function d(e){o=e.target.color.clone(),r.value=o.red,i.value=o.green,l.value=o.blue,s.style["background-color"]=o.cssColor,s.color=o}function c(e){for(let t=0;t<6;++t)for(let o=0;o<6;++o){let a=n[6*t+o];a.color.red=e,a.style["background-color"]=a.color.cssColor}}function u(e){c(Math.ceil(2.55*e.target.valueAsNumber))}function g(e){c(255-e.target.color.blue)}function v(){o.red=parseInt(r.value),o.green=parseInt(i.value),o.blue=parseInt(l.value),s.style["background-color"]=o.cssColor,s.color=o}return t=pe(),t.title=E.getText("ColorDialog - Colors"),a=w.create("div",{id:"TravelNotes-ColorDialog-ColorDiv"},t.content),function(){let e=w.create("div",null,a),t=new Ve(y.colorDialog.initialRed,0,0);for(let o=0;o<6;++o){let o=w.create("div",{className:"TravelNotes-ColorDialog-RowColorDiv"},e);t.green=0;for(let e=0;e<6;++e){let e=w.create("div",{className:"TravelNotes-ColorDialog-CellColorDiv"},o);e.color=t.clone(),e.style["background-color"]=t.cssColor,e.addEventListener("click",d,!1),t.green+=51,n.push(e)}t.blue+=51}}(),y.colorDialog.haveSlider?function(){let e=w.create("div",null,a),t=Math.ceil(y.colorDialog.initialRed*(100/255)),o=w.create("input",{type:"range",className:"TravelNotes-ColorDialog-SliderInput",value:t,min:0,max:100,step:20},e);o.addEventListener("input",u,!1),o.focus()}():function(){let e=w.create("div",null,a),t=new Ve(255,0,0),o=w.create("div",{className:"TravelNotes-ColorDialog-RowColorDiv",id:"TravelNotes-ColorDialog-RedButtonsRowDiv"},e);for(let e=0;e<6;++e){let e=w.create("div",{className:"TravelNotes-ColorDialog-CellColorDiv"},o);e.color=t.clone(),e.style["background-color"]=e.color.cssColor,e.addEventListener("click",g,!1),t.green+=51,t.blue+=51}}(),function(){let e=w.create("div",null,a);w.create("text",{value:E.getText("ColorDialog - Red")},e),r=w.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:o.red,min:0,max:255},e),r.addEventListener("input",v,!1),w.create("text",{value:E.getText("ColorDialog - Green")},e),i=w.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:o.green,min:0,max:255},e),i.addEventListener("input",v,!1),w.create("text",{value:E.getText("ColorDialog - Blue")},e),l=w.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:o.blue,min:0,max:255},e),l.addEventListener("input",v,!1)}(),s=w.create("div",{id:"TravelNotes-ColorDialog-ColorSampleDiv"},a),s.style["background-color"]=o.cssColor,s.color=o,t}(e.color),t.title=E.getText("RoutePropertiesDialog - Route properties"),t.okButtonListener=l,o=w.create("div",{id:"TravelNotes-RoutePropertiesDialog-MainDataDiv"}),t.content.insertBefore(o,t.content.firstChild),function(){let t=w.create("div",null,o);w.create("div",{textContent:E.getText("RoutePropertiesDialog - Name")},t);let n=w.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"},t);a=w.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:e.computedName},n)}(),function(){let t=w.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"},o);w.create("text",{value:E.getText("RoutePropertiesDialog - Width")},w.create("span",null,t)),n=w.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:e.width,min:1,max:40},t)}(),function(){let t=w.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"},o);w.create("text",{value:E.getText("RoutePropertiesDialog - Linetype")},w.create("span",null,t)),i=w.create("select",null,t);let a=y.route.dashChoices;for(let e=0;e<a.length;e++)i.add(w.create("option",{text:a[e].text}));i.selectedIndex=e.dashArray<a.length?e.dashArray:0}(),function(){let t=w.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"},o);w.create("text",{value:E.getText("RoutePropertiesDialog - Chained route")},w.create("span",null,t)),r=w.create("input",{type:"checkbox",checked:e.chain},t)}(),w.create("div",{textContent:E.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"},o),t}function We(e){return(e+d.d540)%d.d360-d.d180}const Ke=new class{constructor(){Object.freeze(this)}arcFromSummitArcArc(e,t,o){return Math.acos(Math.cos(t)*Math.cos(o)+Math.sin(t)*Math.sin(o)*Math.cos(e))}summitFromArcArcArc(e,t,o){return Math.acos((Math.cos(o)-Math.cos(e)*Math.cos(t))/(Math.sin(e)*Math.sin(t)))}pointsDistance(e,t){if(e[0]===t[0]&&e[1]===t[1])return 0;let o=e[0]*d.toRadians,a=t[0]*d.toRadians,n=(We(t[1])-We(e[1]))*d.toRadians;return 6371e3*Math.acos(Math.sin(o)*Math.sin(a)+Math.cos(o)*Math.cos(a)*Math.cos(n))}};function _e(){let e=[];function t(t){e.push(t.latLng),e.push(t.iconLatLng)}function o(o){o.itinerary.itineraryPoints.forEach(t=>e.push(t.latLng)),o.notes.forEach(e=>t(e))}return new class{constructor(){Object.freeze(this)}zoomToLatLng(e){De.dispatch("zoomto",{latLng:e})}zoomToManeuver(e){let t=he.travel.editedRoute.itinerary.maneuvers.getAt(e).itineraryPointObjId,o=he.travel.editedRoute.itinerary.itineraryPoints.getAt(t).latLng;De.dispatch("zoomto",{latLng:o})}zoomToNote(o){e=[],t(He.getNoteAndRoute(o).note),De.dispatch("zoomto",{geometry:[e]})}zoomToRoute(t){e=[],o(He.getRoute(t)),De.dispatch("zoomto",{geometry:[e]})}zoomToTravel(){e=[],he.travel.routes.forEach(e=>o(e)),-1!==he.travel.editedRouteObjId&&o(he.travel.editedRoute),he.travel.notes.forEach(e=>t(e)),De.dispatch("zoomto",{geometry:[e]})}zoomToPoi(e){De.dispatch("zoomto",e)}}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file FloatWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
function Ze(){let e=null,t=null,o=null,a=0,n=0,r=0,i=0,l=0,s=0,d=null,c=null;function u(e){try{e.dataTransfer.setData("Text","1")}catch(e){e instanceof Error&&console.error(e)}a=e.screenX,n=e.screenY}function g(t){r+=t.screenX-a,i+=t.screenY-n,r=Math.min(Math.max(r,20),l-e.clientWidth-20),i=Math.max(i,20);let o=s-Math.max(i,0)-20;e.style.top=String(i)+"px",e.style.left=String(r)+"px",e.style["max-height"]=String(o)+"px"}function v(){d&&d(),document.querySelector("body").removeChild(e)}return new class{constructor(){Object.freeze(this)}createWindow(){l=he.map.getContainer().clientWidth,s=he.map.getContainer().clientHeight,e=w.create("div",{className:"TravelNotes-FloatWindow-Container"},document.querySelector("body")),function(){let t=w.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},e);t.addEventListener("dragstart",u,!1),t.addEventListener("dragend",g,!1),w.create("div",{textContent:"❌",className:"TravelNotes-FloatWindow-CancelButton",title:E.getText("FloatWindow - Close")},t).addEventListener("click",v,!1)}(),t=w.create("div",{className:"TravelNotes-FloatWindow-HeaderDiv"},e),o=w.create("div",{className:"TravelNotes-FloatWindow-ContentDiv"},e)}close(){v()}set onClose(e){d=e}update(...e){!function(e){c&&c(e)}(e)}set onUpdate(e){c=e}get header(){return t}get content(){return o}}}let Xe=null,qe=r.defaultValue,Ge=r.defaultValue,Je=null,Ye=null,$e=-1,Qe=-1,et=-1,tt=[],ot=null,at=null;function nt(e){-1!==et&&Je.childNodes[et+1].firstChild.classList.remove("TravelNotes-ContextMenu-ItemSelected"),e?(Je.childNodes[$e+1].firstChild.classList.add("TravelNotes-ContextMenu-ItemSelected"),et=$e):(Je.childNodes[Qe+1].firstChild.classList.add("TravelNotes-ContextMenu-ItemSelected"),et=Qe,$e=Qe)}function rt(e){Je&&("Escape"===e.key||"Esc"===e.key?(e.stopPropagation(),ot.click()):"ArrowDown"===e.key||"ArrowRight"===e.key||"Tab"===e.key?(e.stopPropagation(),$e=-1===$e||tt.length-1===$e?0:++$e,nt(!0)):"ArrowUp"===e.key||"ArrowLeft"===e.key?(e.stopPropagation(),$e=-1===$e||0===$e?tt.length-1:--$e,nt(!0)):"Home"===e.key?(e.stopPropagation(),$e=0,nt(!0)):"End"===e.key?(e.stopPropagation(),$e=tt.length-1,nt(!0)):"Enter"===e.key&&$e>=0&&tt[$e].action&&(e.stopPropagation(),nt(!0),Je.childNodes[et+1].firstChild.click()))}function it(e){e.stopPropagation();let t=tt[e.target.menuItem];ot.click(),t.param?t.action.call(t.context,t.param):t.action.call(t.context)}function lt(e){Qe=e.target.objId,nt(!1)}function st(){Ye&&(clearTimeout(Ye),Ye=null),document.removeEventListener("keydown",rt,!0),at.removeChild(Je),Xe=null,qe=r.defaultValue,Ge=r.defaultValue,Je=null,$e=-1,Qe=-1,et=-1,tt=[],ot=null,at=null}function dt(e,t,o){function a(){if(Xe=e,Xe.fromUI||Xe.latlng.lat!==qe||Xe.latlng.lng!==Ge){if(qe=Xe.latlng.lat,Ge=Xe.latlng.lng,Je)return Ye&&(clearTimeout(Ye),Ye=null),void st();Je=null,$e=-1,Qe=-1,et=-1,ot=null,at=o||document.querySelector("body"),tt=t,Je=w.create("div",{id:"TravelNotes-ContextMenu-Container",className:"TravelNotes-ContextMenu-Container"},at),0<y.contextMenu.timeout&&(Je.addEventListener("mouseenter",()=>{Ye&&(clearTimeout(Ye),Ye=null)},!1),Je.addEventListener("mouseleave",()=>{Ye=setTimeout(st,y.contextMenu.timeout)},!1)),ot=w.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CloseButton",title:E.getText("ContextMenu - Close")},Je),ot.addEventListener("click",st,!1),function(){let e=0;tt.forEach(t=>{let o=w.create("div",{className:"TravelNotes-ContextMenu-ItemContainer"},Je),a=w.create("div",{textContent:t.name,id:"TravelNotes-ContextMenu-Item"+e,objId:e,className:t.action?"TravelNotes-ContextMenu-Item":"TravelNotes-ContextMenu-Item TravelNotes-ContextMenu-ItemDisabled"},o);a.addEventListener("mouseenter",lt,!1),t.action&&a.addEventListener("click",it,!1),a.menuItem=e,++e})}(),function(){let e=document.querySelector("body"),t=w.create("div",{className:"TravelNotes-ContextMenu-DummyDiv"},e),a=t.clientWidth,n=t.clientHeight;e.removeChild(t);let r=Math.min(Xe.originalEvent.clientY,n-Je.clientHeight-20),i=Math.min(Xe.originalEvent.clientX,a-Je.clientWidth-20);o?(Je.style.top=String(r)+"px",Je.style.right=String(20)+"px"):(Je.style.top=String(r)+"px",Je.style.left=String(i)+"px")}(),document.addEventListener("keydown",rt,!0)}}return new class{constructor(){Object.freeze(this)}show(){a()}}}let ct=!1;const ut=Math.max(y.note.svgHamletDistance,y.note.svgVillageDistance,y.note.svgCityDistance,y.note.svgTownDistance),gt=Object.freeze({atStart:-1,onRoute:0,atEnd:1});function vt(){let e=y.note.osmCityAdminLevel.DEFAULT,o=Object.seal({latLng:[r.defaultValue,r.defaultValue],distance:t.defaultValue}),a=null,n=null,i=new Map,l=new Map,c=[],g={},v=null,h=null,m=null,p=gt.onRoute,f=[0,0],b=0,w=null,T=y.note.svgZoom,N=y.note.svgAngleDistance,x=" ",L="",I="",j="";function P(e){let t=!1;return n.wayPoints.forEach(o=>{Math.abs(e.lat-o.lat)<5e-6&&Math.abs(e.lng-o.lng)<5e-6&&(t=!0)}),!t&&(a.lat!==e.lat||a.lng!==e.lng)}function D(r,D){!function(t){i.clear(),l.clear(),c=[],g={hamlet:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgHamletDistance},village:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgVillageDistance},city:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgCityDistance},town:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgTownDistance}},t.elements.forEach(t=>{switch(t.type){case"area":{let o=t.tags.name;y.nominatim.language&&"*"!==y.nominatim.language&&t.tags["name:"+y.nominatim.language]&&(o=t.tags["name:"+y.nominatim.language]),c[Number.parseInt(t.tags.admin_level)]=o,"2"===t.tags.admin_level&&(e=y.note.osmCityAdminLevel[t.tags["ISO3166-1"]]||e)}break;case"way":t.nodesIds=t.nodes,delete t.nodes,i.set(t.id,t);break;case"node":if(l.set(t.id,t),t.tags&&t.tags.place&&g[t.tags.place]&&t.tags.name){let e=Ke.pointsDistance(o.latLng,[t.lat,t.lon]),a=g[t.tags.place];a.maxDistance>e&&a.distance>e&&(a.distance=e,a.name=t.tags.name)}}})}(r),m=document.createElementNS(u,"svg"),m.setAttributeNS(null,"viewBox",String(s.svgViewboxDim/4)+" "+s.svgViewboxDim/4+" "+s.svgViewboxDim/2+" "+s.svgViewboxDim/2),m.setAttributeNS(null,"class","TravelNotes-SvgIcon"),function(){h=null;let t=null;for(let o=2;o<c.length;o++)void 0!==c[o]&&(e>=o?h=c[o]:t=c[o]);v=null;let o=Number.MAX_VALUE;Object.values(g).forEach(e=>{e.distance<o&&(o=e.distance,v=e.name)}),v=t||v,v===h&&(v=null)}(),f=me.subtrackPoints([s.svgViewboxDim/2,s.svgViewboxDim/2],me.project(o.latLng,T)),function(){let e=t.defaultValue,r=n.itinerary.itineraryPoints.first,i=n.itinerary.itineraryPoints.last,l=!1;n.itinerary.itineraryPoints.forEach(t=>{o.distance-e>N&&(r=t),e-o.distance>N&&!l&&(i=t,l=!0),e+=t.distance});let s=me.addPoints(me.project(o.latLng,T),f);if(a.objId!==n.itinerary.itineraryPoints.first.objId){let e=me.addPoints(me.project(r.latLng,T),f);b=Math.atan((s[1]-e[1])/(e[0]-s[0]))*d.d180/Math.PI,0>b&&(b+=d.d360),b-=d.d270,0>e[0]-s[0]&&(b+=d.d180)}if(a.objId!==n.itinerary.itineraryPoints.last.objId){let e=me.addPoints(me.project(i.latLng,T),f);for(w=Math.atan((s[1]-e[1])/(e[0]-s[0]))*d.d180/Math.PI,0>e[0]-s[0]&&(w+=d.d180),w-=b;d.d0>w;)w+=d.d360;for(;d.d360<w;)w-=d.d360}a.objId===n.itinerary.itineraryPoints.first.objId&&(b=-w-d.d90,w=null,p=gt.atStart),o.latLng[0]===n.itinerary.itineraryPoints.last.lat&&o.latLng[1]===n.itinerary.itineraryPoints.last.lng&&(w=null,p=gt.atEnd)}(),null!==w&&(w<y.note.svgAnleMaxDirection.right?(L=E.getText("SvgIconFromOsmFactory - Turn right"),x="🢂"):w<y.note.svgAnleMaxDirection.slightRight?(L=E.getText("SvgIconFromOsmFactory - Turn slight right"),x="🢅"):w<y.note.svgAnleMaxDirection.continue?(L=E.getText("SvgIconFromOsmFactory - Continue"),x="🢁"):w<y.note.svgAnleMaxDirection.slightLeft?(L=E.getText("SvgIconFromOsmFactory - Turn slight left"),x="🢄"):w<y.note.svgAnleMaxDirection.left?(L=E.getText("SvgIconFromOsmFactory - Turn left"),x="🢀"):w<y.note.svgAnleMaxDirection.sharpLeft?(L=E.getText("SvgIconFromOsmFactory - Turn sharp left"),x="🢇"):w<y.note.svgAnleMaxDirection.sharpRight?(L=E.getText("SvgIconFromOsmFactory - Turn sharp right"),x="🢆"):(L=E.getText("SvgIconFromOsmFactory - Turn right"),x="🢂")),gt.atStart===p?L=E.getText("SvgIconFromOsmFactory - Start"):gt.atEnd===p&&(L=E.getText("SvgIconFromOsmFactory - Stop")),function(){let e=n.itinerary.itineraryPoints.previous(a.objId,P),o=n.itinerary.itineraryPoints.next(a.objId,P),r=-1,s=-1,d=-1,c=Number.MAX_VALUE,u=Number.MAX_VALUE,g=Number.MAX_VALUE,v=t.defaultValue,h=null;l.forEach(t=>{"bike"===n.itinerary.transitMode&&t.tags&&t.tags.rcn_ref&&(h=t),a&&(v=Ke.pointsDistance([t.lat,t.lon],a.latLng),v<c&&(r=t.id,c=v)),e&&(v=Ke.pointsDistance([t.lat,t.lon],e.latLng),v<u&&(s=t.id,u=v)),o&&(v=Ke.pointsDistance([t.lat,t.lon],o.latLng),v<g&&(d=t.id,g=v))});let m=l.get(r);if(h){let e=Ke.pointsDistance([h.lat,h.lon],[m.lat,m.lon]);y.note.svgRcnRefDistance>e&&(m=h)}let f=m&&m.tags&&m.tags.highway&&"mini_roundabout"===m.tags.highway;"bike"===n.itinerary.transitMode&&m&&m.tags&&m.tags.rcn_ref&&m.tags["network:type"]&&"node_network"===m.tags["network:type"]&&(j=m.tags.rcn_ref,L+=E.getText("SvgIconFromOsmFactory - rcnRef",{rcnRef:j}));let b="",w="",T=!1,N=!1;i.forEach(e=>{if(!e.nodesIds.includes(r))return;let t=function(e){return(e.tags.name?e.tags.name:"")+(e.tags.name&&e.tags.ref?" ":"")+(e.tags.ref?"["+e.tags.ref+"]":"")}(e),o=""!==t,a=e.nodesIds.includes(s),n=e.nodesIds.includes(d),i=2*e.nodesIds.filter(e=>e===r).length;if(e.nodesIds[0]===r&&i--,e.nodesIds[e.nodesIds.length-1]===r&&i--,a&&(b=o?t:"???",i--,e.tags.junction&&"roundabout"===e.tags.junction&&(N=!0)),0!==i&&(n&&(w=o?t:"???",i--,e.tags.junction&&"roundabout"===e.tags.junction&&(T=!0)),0!==i&&o))for(;0!==i;)I=""===I?t:I+" ⪥  "+t,i--}),I=gt.atStart===p?"🟢 "+w:gt.atEnd===p?b+" 🔴 ":b+(""===I?"":" ⪥  "+I)+" "+x+" "+w,T&&!N?L+=E.getText("SvgIconFromOsmFactory - entry roundabout"):!T&&N?L+=E.getText("SvgIconFromOsmFactory - exit roundabout"):T&&N&&(L+=E.getText("SvgIconFromOsmFactory - continue roundabout")),f&&(L+=E.getText("SvgIconFromOsmFactory - at the small roundabout on the ground"))}(),function(){let e=-1,t=-1,o=-1,a=[];if(n.itinerary.itineraryPoints.forEach(n=>{e++;let r=me.addPoints(me.project(n.latLng,T),f);a.push(r),r[0]>=0&&r[1]>=0&&r[0]<=s.svgViewboxDim&&r[1]<=s.svgViewboxDim&&(-1===t&&(t=e),o=e)}),-1!==t&&-1!==o){0<t&&t--,n.itinerary.itineraryPoints.length-1>o&&o++;let r="";for(e=t;e<=o;e++)r+=a[e][0].toFixed(0)+","+a[e][1].toFixed(0)+" ";let i=document.createElementNS(u,"polyline");i.setAttributeNS(null,"points",r),i.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),i.setAttributeNS(null,"transform","rotate("+b+","+s.svgViewboxDim/2+","+s.svgViewboxDim/2+")"),m.appendChild(i)}}(),i.forEach(e=>{let t=-1,o=-1,a=-1,n=[];if(e.nodesIds.forEach(e=>{a++;let r=l.get(e),i=me.addPoints(me.project([r.lat,r.lon],T),f);n.push(i),i[0]>=0&&i[1]>=0&&i[0]<=s.svgViewboxDim&&i[1]<=s.svgViewboxDim&&(-1===t&&(t=a),o=a)}),-1!==t&&-1!==o){0<t&&t--,e.nodesIds.length-1>o&&o++;let r="";for(a=t;a<=o;a++)r+=n[a][0].toFixed(0)+","+n[a][1].toFixed(0)+" ";let i=document.createElementNS(u,"polyline");i.setAttributeNS(null,"points",r),i.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),i.setAttributeNS(null,"transform","rotate("+b+","+s.svgViewboxDim/2+","+s.svgViewboxDim/2+")"),m.appendChild(i)}}),function(){if(""===j)return;let e=document.createElementNS(u,"text");e.textContent=j,e.setAttributeNS(null,"x",String(s.svgViewboxDim/2)),e.setAttributeNS(null,"y",String(.6*s.svgViewboxDim)),e.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),m.appendChild(e)}(),ct=!1,D(Object.freeze({svg:m,tooltip:L,city:h,place:v,streets:I,latLng:a.latLng}))}function C(e,i){ct?i("A request is already running"):(ct=!0,m=null,h=null,v=null,x=" ",L="",I="",function(){let e=Number.MAX_VALUE,r=t.defaultValue;n.itinerary.itineraryPoints.forEach(t=>{let n=Ke.pointsDistance(o.latLng,t.latLng);e>n&&(e=n,a=t,o.distance=r),r+=t.distance}),o.latLng=a.latLng}(),fetch(function(){let e=o.latLng[0].toFixed(r.fixed)+","+o.latLng[1].toFixed(r.fixed);return y.overpassApi.url+"?data=[out:json][timeout:"+y.note.svgTimeOut+"];way[highway](around:"+(1.5*s.svgViewboxDim).toFixed(0)+","+e+")->.a;(.a >;.a;)->.a;.a out;is_in("+e+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+ut+","+e+")[place];out;"}()).then(t=>{200===t.status&&t.ok?t.json().then(t=>D(t,e)).catch(e=>{ct=!1,i(e)}):(ct=!1,i(new Error("An error occurs when callin OverpassAPI")))}))}return new class{constructor(){Object.freeze(this)}getPromiseIconAndAdress(e,t){return o.latLng=e,n=He.getRoute(t),new Promise(C)}}}const ht=Math.max(y.note.svgHamletDistance,y.note.svgVillageDistance,y.note.svgCityDistance,y.note.svgTownDistance);function mt(){let e=null;async function t(t,o,a){let n=t[0].value,r=t[1].value;"fulfilled"===t[0].status&&"fulfilled"===t[1].status&&200===n.status&&n.ok&&200===r.status&&r.ok||a(new Error("error when calling Nominatim or OverpassAPI"));let i=function(e){let t="";return e.error?{street:null,nameDetails:null,country:null}:(e.address.house_number&&(t+=e.address.house_number+" "),e.address.road?t+=e.address.road+" ":e.address.pedestrian&&(t+=e.address.pedestrian+" "),{street:t,nameDetails:e.namedetails.name,country:e.address.country})}(await n.json()),l=function(t){let o=y.note.osmCityAdminLevel.DEFAULT,a=[],n={hamlet:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgHamletDistance},village:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgVillageDistance},city:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgCityDistance},town:{name:null,distance:Number.MAX_VALUE,maxDistance:y.note.svgTownDistance}};t.elements.forEach(t=>{if("area"===t.type){let e=t.tags.name;y.nominatim.language&&"*"!==y.nominatim.language&&t.tags["name:"+y.nominatim.language]&&(e=t.tags["name:"+y.nominatim.language]),a[Number.parseInt(t.tags.admin_level)]=e,"2"===t.tags.admin_level&&(o=y.note.osmCityAdminLevel[t.tags["ISO3166-1"]]||o)}if("node"===t.type&&t.tags&&t.tags.place&&n[t.tags.place]&&t.tags.name){let o=Ke.pointsDistance(e,[t.lat,t.lon]),a=n[t.tags.place];a.maxDistance>o&&a.distance>o&&(a.distance=o,a.name=t.tags.name)}});let r=null,i=null;for(let e=2;e<a.length;e++)void 0!==a[e]&&(o>=e?r=a[e]:i=a[e]);let l=null,s=Number.MAX_VALUE;return Object.values(n).forEach(e=>{e.distance<s&&(s=e.distance,l=e.name)}),l=i||l,l===r&&(l=null),{city:r,place:l,country:a[2]}}(await r.json()),s=null;l&&(s=l.city,l.place&&(s+=" ("+l.place+")"),s||(s=l.country));let d=null,c=null;i&&(d=i.street,c=i.nameDetails||"",s||(s=i.country)),s=s||"",d=d||"",c=c||"",(d.includes(c)||s.includes(c))&&(c=""),o(Object.freeze({name:f.sanitizeToJsString(c),street:f.sanitizeToJsString(d),city:f.sanitizeToJsString(s)}))}function o(o,a){(function(){let t=y.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1]+"&zoom=18&addressdetails=1&namedetails=1",o=y.nominatim.language;o&&"*"!==o&&(t+="&accept-language="+o);let a=new Headers;o&&"*"===o&&a.append("accept-language","");let n=y.overpassApi.url+"?data=[out:json][timeout:"+y.note.svgTimeOut+"];is_in("+e[0]+","+e[1]+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+ht+","+e[0]+","+e[1]+")[place];out;";return Promise.allSettled([fetch(t,{headers:a}),fetch(n)])})().then(e=>t(e,o,a))}return new class{constructor(){Object.freeze(this)}getPromiseAddress(t){return e=t,new Promise(o)}}}let pt=[],ft=[],bt=null,yt=null,wt=null,Tt=null;function Nt(){ft.forEach(e=>yt.add(w.create("option",{text:f.sanitizeToJsString(e.name)}))),yt.selectedIndex=-1}function xt(){pt.forEach(e=>{let t=w.create("button",{type:"button",htmlBefore:e.htmlBefore||"",htmlAfter:e.htmlAfter||"",className:"TravelNotes-NoteDialog-EditorButton"},bt);f.sanitizeToHtmlElement(e.title||"?",t),t.addEventListener("click",Tt.onButtonClickEventListener,!1)})}function Lt(e){let t=new FileReader;t.onload=function(){try{let e=JSON.parse(t.result);pt=pt.concat(e.editionButtons),ft=ft.concat(e.preDefinedIconsList),ft.sort((e,t)=>e.name.localeCompare(t.name)),document.querySelectorAll(".TravelNotes-NoteDialog-EditorButton").forEach(e=>{e.removeEventListener("click",Tt.onButtonClickEventListener,!1),bt.removeChild(e)}),xt();for(let e=yt.length-1;e>=0;e--)yt.remove(e);Nt(),Tt.hideError()}catch(e){e instanceof Error&&console.error(e),Tt.showError(E.getText("NoteDialogToolbar - An error was found in the json file",{error:e.message}))}},t.readAsText(e.target.files[0])}function It(){wt.click()}function Et(e){Tt.toggleContents(),e.target.textContent="▼"===e.target.textContent?"▶":"▼"}const jt=new class{constructor(){Object.freeze(this)}set selectOptions(e){ft=ft.concat(e),ft.sort((e,t)=>e.name.localeCompare(t.name))}set buttons(e){pt=pt.concat(e)}getIconData(e){return ft[e]}getIconDataFromName(e){let t=ft.find(t=>t.name===e);return t?t.icon:null}createToolbar(e){return Tt=e,bt=w.create("div",{className:"TravelNotes-NoteDialog-ToolbarDiv",id:"TravelNotes-NoteDialog-ToolbarDiv"}),yt=w.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},bt),yt.addEventListener("change",Tt.onSelectEventListener,!1),Nt(),wt=w.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},bt),wt.addEventListener("change",Lt,!1),w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("NoteDialog - show hidden contents"),textContent:"▼"},bt).addEventListener("click",Et,!1),w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("NoteDialog - Open a configuration file"),textContent:"📂"},bt).addEventListener("click",It,!1),xt(),bt}},Pt=l.margin.toFixed(0),Dt=(l.margin+l.height).toFixed(0),Ct=(l.margin+l.width).toFixed(0),Rt=l.margin.toFixed(0),Mt=(l.margin+l.width+l.xDeltaText).toFixed(0),St=(l.margin-l.xDeltaText).toFixed(0),At=l.margin+l.height+l.margin/2;function Ot(){let e=null,o=1,a=1,n=Number.MAX_VALUE,r=0,i=0,s=null,d=0,c=y.route.elev.smoothCoefficient,g=y.route.elev.smoothPoints;function v(){let e=function(){let e=0,t=0,o=[],a=s.itinerary.itineraryPoints.iterator,n=0,r=a.done;for(o.push({distance:e,elev:a.value.elev}),n+=a.value.distance,r=a.done;!r;){for(e+=d;e>=n&&!r;)n+=a.value.distance,r=a.done;if(!r){let r=(a.value.elev-a.previous.elev)/a.previous.distance;t=a.value.elev-(n-e)*r,o.push({distance:e,elev:t})}}return o.push({distance:n,elev:s.itinerary.itineraryPoints.last.elev}),o}(),t=new Map,o=(e[g].elev-e[0].elev)/g,a=0;for(a=0;a<g;a++)t.set(a*d,{distance:a*d,elev:e[0].elev+o*a});for(a=g;a<e.length-g;a++){let o=0;for(let t=a-g;a+g>=t;t++)o+=e[t].elev;t.set(e[a].distance,{distance:e[a].distance,elev:o/(2*g+1)})}return a--,o=d*(e[e.length-1].elev-e[e.length-1-g].elev)/(e[e.length-1].distance-e[e.length-1-g].distance),t.set(e[a].distance+d,{distance:e[a].distance+d,elev:e[a].elev+o}),t.set(e[a].distance+2*d,{distance:e[a].distance+2*d,elev:e[a].elev+2*o}),t}function h(d){return s=d,n=Number.MAX_VALUE,r=0,s.itinerary.itineraryPoints.forEach(e=>{r=Math.max(r,e.elev),n=Math.min(n,e.elev)}),i=r-n,o=l.height/i,a=l.width/s.distance,e=document.createElementNS(u,"svg"),e.setAttributeNS(null,"viewBox","0 0 "+(l.width+2*l.margin)+" "+(l.height+2*l.margin)),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile"),function(){let t="",n=0,i=0,d=0;s.itinerary.itineraryPoints.forEach(e=>{i=(l.margin+a*n).toFixed(0),d=(l.margin+o*(r-e.elev)).toFixed(0),t+=i+","+d+" ",n+=e.distance});let c=document.createElementNS(u,"polyline");c.setAttributeNS(null,"points",t),c.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),e.appendChild(c)}(),function(){let t=Pt+","+Rt+" "+Pt+","+Dt+" "+Ct+","+Dt+" "+Ct+","+Rt,o=document.createElementNS(u,"polyline");o.setAttributeNS(null,"points",t),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),e.appendChild(o)}(),function(){let t=Number.MAX_VALUE,a=0;l.vScales.forEach(e=>{let o=Math.abs(i/4-e);o<t&&(t=o,a=e)});let s=Math.ceil(n/a)*a;for(;s<r;){let t=l.margin+(r-s)*o,n=document.createElementNS(u,"text");n.appendChild(document.createTextNode(s.toFixed(0))),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),n.setAttributeNS(null,"x",Mt),n.setAttributeNS(null,"y",t),n.setAttributeNS(null,"text-anchor","start"),e.appendChild(n);let i=document.createElementNS(u,"text");i.appendChild(document.createTextNode(s.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",St),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","end"),e.appendChild(i),s+=a}}(),function(){let o=Number.MAX_VALUE,n=0;l.hScales.forEach(e=>{let t=Math.abs(s.distance/8-e);t<o&&(o=t,n=e)});let r=Math.ceil(s.chainedDistance/n)*n;for(;r<s.distance+s.chainedDistance;){let o=document.createElementNS(u,"text");o.appendChild(document.createTextNode(t.metersInKm<n||0<s.chainedDistance?r/t.metersInKm+" km":r+" m ")),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),o.setAttributeNS(null,"x",l.margin+(r-s.chainedDistance)*a),o.setAttributeNS(null,"y",At),o.setAttributeNS(null,"text-anchor","start"),e.appendChild(o),r+=n}}(),e}return new class{constructor(){Object.freeze(this)}smooth(e){!function(e){s=e;let t=s.itinerary.itineraryPoints.iterator,o=0,a=0;for(;!t.done;)o+=t.value.distance,a+=t.next?Math.abs(t.value.elev-t.next.elev):0;if(d=10*Math.floor(c/(a/o)),o<=2*g*d)return;let n=v();t=s.itinerary.itineraryPoints.iterator,t.done;let r=t.value.distance;for(;!t.done;){let e=n.get(Math.floor(r/d)*d),o=n.get(Math.ceil(r/d)*d);if(e&&o){let a=r-e.distance,n=(o.elev-e.elev)/(o.distance-e.distance);t.value.elev=e.elev+a*n}r+=t.value.distance}}(e)}createSvg(e){return h(e)}}}function kt(e,t){let o=t.note,a=w.create("div");if(0!==o.tooltipContent.length&&f.sanitizeToHtmlElement(o.tooltipContent,w.create("div",{className:e+"NoteHtml-TooltipContent"},a)),0!==o.popupContent.length&&f.sanitizeToHtmlElement(o.popupContent,w.create("div",{className:e+"NoteHtml-PopupContent"},a)),0!==o.address.length&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Address")+"</span> : "+o.address,w.create("div",{className:e+"NoteHtml-Address"},a)),0!==o.url.length&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substr(0,40)+"...</a>",w.create("div",{className:e+"NoteHtml-Url"},a)),0!==o.phone.length){let t=o.phone;if(o.phone.match(/^\+[0-9, ,*,#]*$/)){let e=o.phone.replaceAll(/\u0020/g,""),a=o.phone.replaceAll(/\u0020/g," ");t=E.getText("HTMLViewsFactory - Phone")+" : "+E.getText("HTMLViewsFactory - call")+'<a target="_blank" href="tel:'+e+'" >'+a+"</a>"+E.getText("HTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+e+'" >'+a+"</a>"}else t=E.getText("HTMLViewsFactory - Phone")+" : "+o.phone;f.sanitizeToHtmlElement(t,w.create("div",{className:e+"NoteHtml-Phone"},a))}if(f.sanitizeToHtmlElement(j.formatLatLng(o.latLng),w.create("div",{className:e+"NoteHtml-LatLng"},a)),t.route){t.route.chain&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Distance from start of travel")+"</span> : "+j.formatDistance(o.chainedDistance+o.distance),w.create("div",{className:e+"NoteHtml-Distance"},a)),f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Distance from start of route")+"</span> : "+j.formatDistance(o.distance),w.create("div",{className:e+"NoteHtml-Distance"},a));let n=t.route.notes.next(o.objId);if(n){let t=n.distance-o.distance;9<t&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Next note after")+"</span> : "+j.formatDistance(t),w.create("div",{className:e+"NoteHtml-NextDistance"},a))}}return a}function Ut(e,t){let o=w.create("div"),a=w.create("div",{className:e+(t.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},o),n=1;f.sanitizeToHtmlElement(t.note.iconContent,a),"TravelNotes-Roadbook-"===e&&a.firstChild?("svg"===a.firstChild.tagName?(a.firstChild.setAttributeNS(null,"viewBox","0 0 "+s.svgViewboxDim+" "+s.svgViewboxDim),n=y.note.svgRoadbookDimCoef):a.firstChild.classList.contains("TravelNotes-MapNoteCategory-0073")&&(n=y.note.svgRoadbookDimCoef),a.setAttribute("tanwidth",String(t.note.iconWidth*n)+"px"),a.setAttribute("tanheight",String(t.note.iconWidth*n)+"px")):(a.style.width=String(t.note.iconWidth)+"px",a.style.height=String(t.note.iconHeight)+"px");let r=kt(e,t);return r.className=e+(t.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),o.appendChild(r),o.noteObjId=t.note.objId,o}function Bt(e){let t=w.create("div",{className:e+"Travel-Notes"}),o=he.travel.notes.iterator;for(;!o.done;){let a=Ut(e,{note:o.value,route:null});a.className=e+"Travel-Notes-Row",t.appendChild(a)}return t}function Ht(e,t){let o=w.create("div",{className:e+"Route-Header",id:"route"+t.objId});return f.sanitizeToHtmlElement(t.computedName,w.create("div",{className:e+"Route-Header-Name"},o)),0!==t.distance&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Route distance")+"</span> : "+j.formatDistance(t.distance),w.create("div",{className:e+"Route-Header-Distance"},o)),he.travel.readOnly||"bike"===t.itinerary.transitMode||f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Duration")+"</span> : "+j.formatTime(t.duration),w.create("div",{className:e+"Route-Header-Duration"},o)),t.itinerary.hasProfile&&(f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Ascent")+"</span> : "+String(t.itinerary.ascent.toFixed(0))+" m.",w.create("div",{className:e+"Route-Header-Ascent"},o)),f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Descent")+"</span> : "+String(t.itinerary.descent.toFixed(0))+" m.",w.create("div",{className:e+"Route-Header-Descent"},o))),o}function zt(e,o){let a=w.create("div");w.create("div",{className:e+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+o.maneuver.iconName},a);let n=w.create("div",{className:e+"Route-ManeuversAndNotes-Cell"},a);return f.sanitizeToHtmlElement(o.maneuver.instruction,w.create("div",null,n)),o.route.chain&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Distance from start of travel")+"</span> : "+j.formatDistance(o.route.chainedDistance+o.maneuverDistance),w.create("div",{className:e+"Route-Maneuver-Distance"},n)),f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Distance from start of route")+"</span> : "+j.formatDistance(o.maneuverDistance),w.create("div",{className:e+"Route-Maneuver-Distance"},n)),t.defaultValue<o.maneuver.distance&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Next maneuver after")+"</span> : "+j.formatDistance(o.maneuver.distance),w.create("div",{className:e+"Route-Maneuver-Distance"},n)),a}function Vt(e,t){let o=[],a=t.notes.iterator;for(;!a.done;){let n=Ut(e,{note:a.value,route:t});n.className=e+"Route-Notes-Row",n.objId=N(),n.latLng=a.value.latLng,n.noteObjId=a.value.objId,n.distance=a.value.distance,o.push(n)}let n=t.itinerary.maneuvers.iterator,r=0;for(;!n.done;){let a=zt(e,{route:t,maneuver:n.value,maneuverDistance:r});a.className=e+"Route-Maneuvers-Row",a.objId=N(),a.latLng=t.itinerary.itineraryPoints.getAt(n.value.itineraryPointObjId).latLng,a.maneuverObjId=n.value.objId,a.distance=r,o.push(a),r+=n.value.distance}o.sort((e,t)=>e.distance-t.distance);let i=w.create("div",{className:e+"Route-ManeuversAndNotes"});return o.forEach(e=>i.appendChild(e)),i}function Ft(e,t){let o="";""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(o=E.getText("HTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:E.getText("HTMLViewsFactory - TransitMode "+t.itinerary.transitMode)}));let a=w.create("div",{className:e+"RouteFooter"});return f.sanitizeToHtmlElement(o,a),a}function Wt(e,t){let o=w.create("div",{className:e+"RouteProfile"});return f.sanitizeToHtmlElement(E.getText("HTMLViewsFactory - Profile"),o),o.appendChild(Ot().createSvg(t)),o}function Kt(e){let o=w.create("div",{className:e+"Travel"});o.appendChild(function(e){let o=w.create("div",{className:e+"Travel-Header"});f.sanitizeToHtmlElement(he.travel.name,w.create("div",{className:e+"Travel-Header-Name"},o));let a=t.defaultValue,n=0,r=0,i=he.travel.routes.iterator;for(;!i.done;){let t=i.value.objId===he.editedRouteObjId&&y.routeEditor.displayEditionInHTMLPage?he.travel.editedRoute:i.value;f.sanitizeToHtmlElement('<a href="#route'+t.objId+'" >'+t.computedName+"</a> : "+j.formatDistance(t.distance)+".",w.create("div",{className:e+"Travel-Header-RouteName"},o)),t.chain&&(a+=t.distance,n+=t.itinerary.ascent,r+=t.itinerary.descent)}return f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Travel distance")+"</span> : "+j.formatDistance(a),w.create("div",{className:e+"Travel-Header-TravelDistance"},o)),0!==n&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Travel ascent")+"</span> : "+String(n.toFixed(0))+" m.",w.create("div",{className:e+"Travel-Header-TravelAscent"},o)),0!==r&&f.sanitizeToHtmlElement("<span>"+E.getText("HTMLViewsFactory - Travel descent")+"</span> : "+String(r.toFixed(0))+" m.",w.create("div",{className:e+"Travel-Header-TravelDescent"},o)),o}(e)),o.appendChild(Bt(e));let a=he.travel.routes.iterator;for(;!a.done;){let t=y.routeEditor.displayEditionInHTMLPage&&a.value.objId===he.editedRouteObjId?he.travel.editedRoute:a.value;o.appendChild(Ht(e,t)),t.itinerary.hasProfile&&o.appendChild(Wt(e,t)),o.appendChild(Vt(e,t)),o.appendChild(Ft(e,t))}return o.appendChild(function(e){let t=E.getText("HTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/leaflet.TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 2021</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+E.getText("HTMLViewsFactory - OpenStreetMap contributors")+"</a>",o=w.create("div",{className:e+"TravelFooter"});return f.sanitizeToHtmlElement(t,o),o}(e)),o}const _t=new class{constructor(){Object.freeze(this)}getTravelHTML(e){return Kt(e)}getNoteTextAndIconHTML(e,t){return Ut(e,t)}getNoteTextHTML(e,t){return kt(e,t)}getEditedRouteManeuversAndNotesHTML(e){return Vt(e,he.travel.editedRoute)}getTravelNotesHTML(e){return Bt(e)}getRouteHeaderHTML(e,t){return Ht(e,t)}};function Zt(e,t,o){let a=null,n=mt(),i=e.latLng,l=null,d=null,c=null,u=null,g=null,v=null,h=null,m=null,p=null,b=null,T=null,N=null,x=null,L=null,I=null,j=null,P=null,D=null,C=null,R=null,M=null,S=null;function A(){if(""!==L.value){if(""===R.value||""!==f.sanitizeToUrl(R.value).url)return e.iconWidth=Number.parseInt(I.value),e.iconHeight=Number.parseInt(j.value),e.iconContent=L.value,e.popupContent=P.value,e.tooltipContent=D.value,e.address=C.value,e.url=R.value,e.phone=M.value,e.latLng=i,e.validateData(),e;N.showError(E.getText("Notedialog - invalidUrl"))}else N.showError(E.getText("Notedialog - The icon content cannot be empty"))}function O(){""===L.value?l.iconContent="?????":l.iconContent=L.value,l.popupContent=P.value,l.tooltipContent=D.value,l.address=C.value,l.url=R.value,l.phone=M.value,l.iconWidth=I.value,l.iconHeight=j.value,S.textContent="",S.appendChild(_t.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:l,route:null}))}function k(e){let t=e.street;""!==e.city&&(t+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"),C.value=t,N.okButton.classList.remove("TravelNotes-Hidden"),O()}function U(e){N.showError(E.getText("Notedialog - an error occurs when searching the adress")),e instanceof Error&&console.error(e),N.okButton.classList.remove("TravelNotes-Hidden"),O()}function B(){N.okButton.classList.add("TravelNotes-Hidden"),n.getPromiseAddress(e.latLng).then(k).catch(U)}function H(e){L.value=e.svg.outerHTML,D.value=e.tooltip;let t=e.streets;""!==e.city&&(t+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"),e.place&&e.place!==e.city&&(t+=" ("+e.place+")"),C.value=t,i=e.latLng,N.hideWait(),O()}function z(e){N.hideWait(),N.showError(E.getText("Notedialog - an error occurs when creating the SVG icon")),e instanceof Error&&console.error(e),O()}function V(o){let a=jt.getIconData(o.target.selectedIndex);"SvgIcon"===a.icon?-1===t?N.showError(E.getText("Notedialog - not possible to create a SVG icon for a travel note")):(N.showWait(),vt().getPromiseIconAndAdress(e.latLng,t).then(H).catch(z)):(N.hideError(),I.value=a.width,j.value=a.height,L.value=a.icon,D.value=a.tooltip,O())}function F(e){if(!a)return;let t=e.target;for(;!t.htmlBefore;)t=t.parentNode;let o=a.selectionStart,n=a.selectionEnd;a.value=a.value.slice(0,o)+t.htmlBefore+(0===t.htmlAfter.length?"":a.value.slice(o,n))+t.htmlAfter+a.value.slice(n),o===n||0===t.htmlAfter.length?(o+=t.htmlBefore.length,n=o):n+=t.htmlBefore.length+t.htmlAfter.length,a.setSelectionRange(o,n),a.focus(),O()}function W(e){a=e.target}function K(e){if(""===e.target.value)return;let t=f.sanitizeToUrl(e.target.value);""===t.errorsString?N.hideError():N.showError(t.errorsString)}function _(){y.noteDialog.toggleIconDimension&&d.classList.toggle("TravelNotes-Hidden"),y.noteDialog.toggleIconTextArea&&c.classList.toggle("TravelNotes-Hidden"),y.noteDialog.togglePopupContent&&u.classList.toggle("TravelNotes-Hidden"),y.noteDialog.toggleTooltip&&g.classList.toggle("TravelNotes-Hidden"),y.noteDialog.toggleAddress&&(v.classList.toggle("TravelNotes-Hidden"),h.classList.toggle("TravelNotes-Hidden")),y.noteDialog.toggleLink&&(m.classList.toggle("TravelNotes-Hidden"),p.classList.toggle("TravelNotes-Hidden")),y.noteDialog.togglePhone&&(b.classList.toggle("TravelNotes-Hidden"),T.classList.toggle("TravelNotes-Hidden"))}return l=Q(),l.jsonObject=e.jsonObject,""===l.iconContent&&(l.iconContent="?????"),N=pe(),N.title=E.getText("NoteDialog - Note"),N.okButtonListener=A,x=w.create("div",{id:"TravelNotes-NoteDialog-MainDataDiv"},N.content),x.appendChild(jt.createToolbar({onButtonClickEventListener:F,onSelectEventListener:V,hideError:N.hideError,showError:N.showError,toggleContents:_})),d=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),w.create("text",{value:E.getText("NoteDialog - Icon width")},d),I=w.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:0===e.iconWidth?s.width:e.iconWidth},d),I.addEventListener("input",O,!1),w.create("text",{value:E.getText("NoteDialog - Icon height")},d),j=w.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:0===e.iconHeight?s.height:e.iconHeight},d),j.addEventListener("input",O,!1),c=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:E.getText("NoteDialog - Icon content")},x),L=w.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",value:e.iconContent,placeholder:"?????",rows:y.noteDialog.iconAreaHeight},c),L.addEventListener("focus",W,!1),L.addEventListener("input",O,!1),g=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:E.getText("NoteDialog - Tooltip content")},x),D=w.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.tooltipContent},g),D.addEventListener("focus",W,!1),D.addEventListener("input",O,!1),u=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:E.getText("NoteDialog - Text")},x),P=w.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",value:e.popupContent,rows:y.noteDialog.popupAreaHeigth},u),P.addEventListener("focus",W,!1),P.addEventListener("input",O,!1),v=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("NoteDialog - Reset address"),textContent:"🔄"},v).addEventListener("click",B,!1),w.create("text",{value:E.getText("NoteDialog - Address")},v),h=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),C=w.create("input",{type:"text",value:e.address,className:"TravelNotes-NoteDialog-InputText"},h),C.addEventListener("focus",W,!1),C.addEventListener("input",O,!1),m=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),y.noteDialog.theDevil.addButton&&w.create("text",{value:"👿"},w.create("a",{href:"https://www.google.com/maps/@"+e.lat.toFixed(r.fixed)+","+e.lng.toFixed(r.fixed)+","+y.noteDialog.theDevil.noteZoom+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},w.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},m))),w.create("text",{value:E.getText("NoteDialog - Link")},m),p=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),R=w.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.url},p),R.addEventListener("focus",()=>{a=null},!1),R.addEventListener("blur",K,!1),R.addEventListener("input",O,!1),b=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),w.create("text",{value:" "+E.getText("NoteDialog - Phone")},b),T=w.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},x),M=w.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.phone},T),M.addEventListener("focus",W,!1),M.addEventListener("input",O,!1),S=w.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"},N.footer),S.appendChild(_t.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:l,route:null})),o&&y.note.reverseGeocoding&&B(),_(),N}function Xt(){let e=null,t=null;return new class{constructor(){Object.freeze(this)}createUI(){if(document.getElementById("TravelNotes-WaitUI"))return;e=w.create("div",{className:"TravelNotes-Background"},document.querySelector("body"));let o=w.create("div",{id:"TravelNotes-WaitUI"},e);t=w.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},o),w.create("div",{className:"TravelNotes-WaitAnimationBullet"},w.create("div",{className:"TravelNotes-WaitAnimation"},o))}showInfo(e){t.textContent=e}close(){document.querySelector("body").removeChild(e),e=null}}}let qt=null,Gt=0,Jt=0,Yt=y.note.osmSearchNoteDialog;function $t(e,t){let o=Q();o.iconContent=e.svg.outerHTML,o.popupContent="",o.iconWidth=s.width,o.iconHeight=s.height,o.tooltipContent=e.tooltip,o.address=e.streets,""!==e.city&&(o.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"),e.place&&e.place!==e.city&&(o.address+=" ("+e.place+")"),o.latLng=e.latLng,o.iconLatLng=e.latLng,o.distance=me.getClosestLatLngDistance(t,o.latLng).distance,o.chainedDistance=t.chainedDistance,t.notes.add(o),De.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:o.objId}),De.dispatch("roadbookupdate")}function Qt(e,t,o){if(o)if(-1===t)he.travel.notes.add(e),De.dispatch("showtravelnotes");else{let o=He.getRoute(t);o.notes.add(e),e.chainedDistance=o.chainedDistance,o.notes.sort((e,t)=>e.distance-t.distance),De.dispatch("showitinerary")}else-1===t?De.dispatch("updatetravelnotes"):De.dispatch("updateitinerary");De.dispatch("noteupdated",{removedNoteObjId:e.objId,addedNoteObjId:e.objId}),De.dispatch("roadbookupdate")}function eo(e,t,o){Zt(e,t,o).show().then(()=>{Qt(e,t,o)}).catch(e=>{e instanceof Error&&console.error(e)})}function to(e){let t=Q();return t.latLng=e,t.iconLatLng=e,t}const oo=new class{constructor(){Object.freeze(this)}get osmSearchNoteDialog(){return Yt}changeOsmSearchNoteDialog(){Yt=!Yt}addAllManeuverNotes(e){let t=He.getRoute(e),o=t.itinerary.maneuvers.iterator;for(Jt=0;!o.done;)"kDepartDefault"===o.value.iconName&&!o.first||"kArriveDefault"===o.value.iconName&&!o.last||Jt++;y.note.maxManeuversNotes<Jt?je.showError(E.getText("NoteEditor - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:Jt,maxManeuversNotes:y.note.maxManeuversNotes})):function(e){let t=null;return function(){if(t=pe(),t.footer.classList.add("TravelNotes-TwoButtonsDialog-FooterDiv"),t.title=e.title||"",t.okButton.classList.add("TravelNotes-TwoButtonsDialog-Button"),e.okButtonContent&&(t.okButton.textContent=e.okButtonContent),e.secondButtonContent){w.create("div",{textContent:e.secondButtonContent,className:"TravelNotes-BaseDialog-Button TravelNotes-TwoButtonsDialog-Button"},t.footer).addEventListener("click",()=>t.cancelButton.click(),!0)}e.textContent&&w.create("div",{id:"TravelNotes-TwoButtonsDialog-MessageDiv",textContent:e.textContent},t.content)}(),t}({title:E.getText("NoteEditor - Add a note for each maneuver"),textContent:E.getText("NoteEditor - Add a note for each maneuver. Are you sure?",{noteLength:Jt}),secondButtonContent:"❌"}).show().then(()=>{o=t.itinerary.maneuvers.iterator,o.done||(qt=Xt(),qt.createUI(),Gt=1,function e(t,o){function a(){t.done?(o.notes.sort((e,t)=>e.distance-t.distance),De.dispatch("updateitinerary"),De.dispatch("roadbookupdate"),qt.close(),qt=null):e(t,o)}if(qt.showInfo(E.getText("NoteEditor - Creating note",{noteNumber:Gt,notesLength:Jt})),"kDepartDefault"===t.value.iconName&&!t.first||"kArriveDefault"===t.value.iconName&&!t.last)a();else{Gt++;let e=o.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId).latLng;vt().getPromiseIconAndAdress(e,o.objId).then(e=>{$t(e,o),a()}).catch(e=>{e instanceof Error&&console.error(e),a()})}}(o,t))}).catch(e=>{e instanceof Error&&console.error(e)})}newRouteNote(e){let t=He.getRoute(e.routeObjId),o=me.getClosestLatLngDistance(t,[e.lat,e.lng]),a=to(o.latLng);a.distance=o.distance,eo(a,t.objId,!0)}newSearchNote(e){let t=[e.osmElement.lat,e.osmElement.lon],o=[e.osmElement.lat,e.osmElement.lon],a=-1,n=Number.MAX_VALUE;function r(e){if(e.objId!==he.editedRouteObjId){let r=me.getClosestLatLngDistance(e,t);if(r){let i=Ke.pointsDistance(t,r.latLng);i<n&&(a=e.objId,n=i,o=r.latLng)}}}e.isTravelNote||(he.travel.routes.forEach(r),-1!==he.editedRouteObjId&&r(he.travel.editedRoute));let i=Q();i.latLng=o,i.iconLatLng=t,i.iconHeight=s.height,i.iconWidth=s.width,e.osmElement.tags.rcn_ref?i.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+e.osmElement.tags.rcn_ref+"</text></svg></div>":i.iconContent=jt.getIconDataFromName(e.osmElement.description)||"",i.address=(e.osmElement.tags["addr:housenumber"]?e.osmElement.tags["addr:housenumber"]+" ":"")+(e.osmElement.tags["addr:street"]?e.osmElement.tags["addr:street"]+" ":"")+(e.osmElement.tags["addr:postcode"]?e.osmElement.tags["addr:postcode"]+" ":"")+(e.osmElement.tags["addr:city"]?e.osmElement.tags["addr:city"]+" ":""),i.url=e.osmElement.tags.website||"",i.phone=e.osmElement.tags.phone||"",i.tooltipContent=e.osmElement.description||"",i.popupContent=e.osmElement.tags.name||"",e.isTravelNote||-1!==a?Yt||""===i.iconContent?eo(i,a,!0):Qt(i,a,!0):je.showError(E.getText("NoteEditor - No route was found"))}newManeuverNote(e){qt=Xt(),qt.createUI();let t=he.travel.editedRoute,o=t.itinerary.maneuvers.getAt(e),a=t.itinerary.itineraryPoints.getAt(o.itineraryPointObjId).latLng;vt().getPromiseIconAndAdress(a,t.objId).then(o=>{$t(o,t),t.notes.sort((e,t)=>e.distance-t.distance),t.itinerary.maneuvers.remove(e),De.dispatch("showitinerary"),De.dispatch("roadbookupdate"),qt.close(),qt=null}).catch(e=>{e instanceof Error&&console.error(e),qt.close(),qt=null})}newTravelNote(e){eo(to(e),-1,!0)}editNote(e){let t=He.getNoteAndRoute(e),o=null===t.route?-1:t.route.objId;eo(t.note,o,!1)}removeNote(e){let t=He.getNoteAndRoute(e);t.route?(t.route.notes.remove(e),De.dispatch("updateitinerary")):(he.travel.notes.remove(e),De.dispatch("updatetravelnotes")),De.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:-1}),De.dispatch("roadbookupdate")}hideNotes(){let e=he.travel.notes.iterator;for(;!e.done;)De.dispatch("removeobject",{objId:e.value.objId});let t=he.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)De.dispatch("removeobject",{objId:e.value.objId});if(-1!==he.editedRouteObjId)for(e=he.travel.editedRoute.notes.iterator;!e.done;)De.dispatch("removeobject",{objId:e.value.objId})}showNotes(){this.hideNotes();let e=he.travel.notes.iterator;for(;!e.done;)De.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:e.value.objId});let t=he.travel.routes.iterator;for(;!t.done;)t.value.hidden||De.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:t.value.objId})}attachNoteToRoute(e){let t=He.getNoteAndRoute(e),o=Number.MAX_VALUE,a=null,n=null,r=null;he.travel.routes.forEach(e=>{let i=me.getClosestLatLngDistance(e,t.note.latLng);if(i){let l=Ke.pointsDistance(t.note.latLng,i.latLng);l<o&&(o=l,a=e,n=i.latLng,r=i.distance)}}),a&&(he.travel.notes.remove(e),t.note.distance=r,t.note.latLng=n,t.note.chainedDistance=a.chainedDistance,a.notes.add(t.note),a.notes.sort((e,t)=>e.distance-t.distance),De.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:e}),De.dispatch("updateitinerary"),De.dispatch("updatetravelnotes"),De.dispatch("roadbookupdate"))}detachNoteFromRoute(e){let o=He.getNoteAndRoute(e);o.route.notes.remove(e),o.note.distance=t.invalid,o.note.chainedDistance=t.defaultValue,he.travel.notes.add(o.note),De.dispatch("updateitinerary"),De.dispatch("updatetravelnotes"),De.dispatch("roadbookupdate")}travelNoteDropped(e,t,o){he.travel.notes.moveTo(e,t,o),De.dispatch("updatetravelnotes"),De.dispatch("roadbookupdate")}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file ProfileWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
function ao(){let e=N(),t=null,o=null,a=null,n=null,r=null,i=null,s=null,d=null;function c(e){let o=t.getBoundingClientRect(),a=(e.clientX-o.x-l.margin/(2*l.margin+l.width)*o.width)/(l.width/(2*l.margin+l.width)*o.width)*d.distance;return me.getLatLngElevAtDist(d,a)}function g(e){e.preventDefault(),e.stopPropagation();let t=c(e);t&&(e.routeObjId=d.objId,e.latlng={lat:t.latLng[0],lng:t.latLng[1]},e.originalEvent={clientX:e.clientX,clientY:e.clientY},function(e){let t=_e();return dt(e,[{context:oo,name:E.getText("ProfileContextMenu - Add a note to the route at this point"),action:oo.newRouteNote,param:{routeObjId:e.routeObjId,lat:e.latlng.lat,lng:e.latlng.lng}},{context:t,name:E.getText("ProfileContextMenu - Zoom to this point"),action:t.zoomToLatLng,param:[e.latlng.lat,e.latlng.lng]}])}(e).show())}function v(){De.dispatch("removeobject",{objId:e})}function h(i){let s=t.getBoundingClientRect(),g=c(i);if(g){De.dispatch("removeobject",{objId:e}),De.dispatch("additinerarypointmarker",{objId:e,latLng:g.latLng}),o&&(t.removeChild(o),t.removeChild(r),t.removeChild(a),t.removeChild(n));let c=(2*l.margin+l.width)*(i.clientX-s.x)/s.width,v=l.margin+l.height;o=document.createElementNS(u,"polyline"),o.setAttributeNS(null,"points",String(c)+","+l.margin+" "+c+","+v),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),t.appendChild(o);let h=g.routeDistance>d.distance/2?"end":"start",m=g.routeDistance>d.distance/2?-l.xDeltaText:l.xDeltaText;r=document.createElementNS(u,"text"),r.appendChild(document.createTextNode(j.formatDistance(g.routeDistance))),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),r.setAttributeNS(null,"x",c+m),r.setAttributeNS(null,"y",l.margin+l.yDeltaText),r.setAttributeNS(null,"text-anchor",h),t.appendChild(r),a=document.createElementNS(u,"text"),a.appendChild(document.createTextNode("Alt. "+g.elev.toFixed(0)+" m.")),a.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),a.setAttributeNS(null,"x",c+m),a.setAttributeNS(null,"y",l.margin+2*l.yDeltaText),a.setAttributeNS(null,"text-anchor",h),t.appendChild(a),n=document.createElementNS(u,"text"),n.appendChild(document.createTextNode("Pente "+g.ascent.toFixed(0)+" % ")),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),n.setAttributeNS(null,"x",c+m),n.setAttributeNS(null,"y",l.margin+3*l.yDeltaText),n.setAttributeNS(null,"text-anchor",h),t.appendChild(n)}}function m(){t&&(t.removeEventListener("contextmenu",g,!1),t.removeEventListener("mousemove",h,!1),t.removeEventListener("mouseleave",v,!1),De.dispatch("removeobject",{objId:e}),i.content.removeChild(s),i.content.removeChild(t)),t=null,o=null,n=null,r=null,a=null,s=null}return i=Ze(),i.createWindow(),i.onClose=function(){m(),De.dispatch("profileclosed",{objId:d.objId})},i.onUpdate=function(e){m(),d=e[0],t=Ot().createSvg(d),i.header.textContent=E.getText("ProfileWindow - Profile {name}",{name:d.computedName}),i.content.appendChild(t),t.addEventListener("contextmenu",g,!1),t.addEventListener("mousemove",h,!1),t.addEventListener("mouseleave",v,!1),s=w.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:E.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:d.itinerary.ascent.toFixed(0),descent:d.itinerary.descent.toFixed(0),distance:j.formatDistance(d.distance)})}),i.content.appendChild(s)},i}let no=new Map,ro=Ot();const io=new class{constructor(){Object.freeze(this)}createProfile(e){let t=no.get(e.objId);if(e.itinerary.hasProfile){y.route.elev.smooth&&ro.smooth(e),e.itinerary.ascent=0,e.itinerary.descent=0;let o=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach(t=>{let a=t.elev-o;0>a?e.itinerary.descent-=a:e.itinerary.ascent+=a,o=t.elev}),t&&t.update(e)}else t&&t.close()}updateProfile(e,t){let o=no.get(e);o&&(no.delete(e),t&&t.itinerary.hasProfile?(o.update(t),no.set(t.objId,o)):o.close())}deleteProfile(e){let t=no.get(e);t&&t.close()}deleteAllProfiles(){no.forEach(e=>e.close())}showProfile(e){let t=no.get(e);t||(t=ao());let o=He.getRoute(e);t.update(o),no.set(e,t)}onProfileClosed(e){no.delete(e)}};const lo=new class{constructor(){Object.freeze(this)}createUI(){w.create("div",{id:"TravelNotes-AttributionsUI"},document.querySelector("body")),this.attributions=""}set attributions(e){let t='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>',o=document.getElementById("TravelNotes-AttributionsUI");for(;o.firstChild;)o.removeChild(o.firstChild);f.sanitizeToHtmlElement(t,o)}};class so{constructor(e){if(!e.name||"string"!=typeof e.name)throw new Error("invalid name for layer");if(this.name=f.sanitizeToJsString(e.name),!e.service||"wms"!==e.service&&"wmts"!==e.service)throw new Error("invalid service for layer "+this.name);if(this.service=e.service,!e.url||"string"!=typeof e.url)throw new Error("invalid url for layer "+this.name);if(this.url=e.url,"wms"===this.service){if(!(e.wmsOptions&&e.wmsOptions.layers&&"string"==typeof e.wmsOptions.layers&&e.wmsOptions.format&&"string"==typeof e.wmsOptions.format&&e.wmsOptions.transparent&&"boolean"==typeof e.wmsOptions.transparent))throw new Error("invalid wmsOptions for layer "+this.name);this.wmsOptions=e.wmsOptions,this.wmsOptions.layers=f.sanitizeToJsString(this.wmsOptions.layers),this.wmsOptions.format=f.sanitizeToJsString(this.wmsOptions.format)}try{e.bounds&&"number"==typeof e.bounds[0][0]&&"number"==typeof e.bounds[0][1]&&"number"==typeof e.bounds[1][0]&&"number"==typeof e.bounds[1][1]&&(this.bounds=e.bounds)}catch(e){throw new Error("invalid bounds for layer "+this.name)}if(e.minZoom&&"number"==typeof e.minZoom&&(this.minZoom=e.minZoom),e.maxZoom&&"number"==typeof e.maxZoom&&(this.maxZoom=e.maxZoom),!(e.toolbar&&e.toolbar.text&&"string"==typeof e.toolbar.text&&e.toolbar.color&&"string"==typeof e.toolbar.color&&e.toolbar.backgroundColor&&"string"==typeof e.toolbar.backgroundColor))throw new Error("invalid toolbar for layer "+this.name);if(this.toolbar=e.toolbar,this.toolbar.text=f.sanitizeToJsString(this.toolbar.text),this.toolbar.color=f.sanitizeToColor(this.toolbar.color)||"#000000",this.toolbar.backgroundColor=f.sanitizeToColor(this.toolbar.backgroundColor)||"#ffffff",!e.providerName||"string"!=typeof e.providerName)throw new Error("invalid providerName for layer "+this.name);if(this.providerName=f.sanitizeToJsString(e.providerName),"boolean"!=typeof e.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.name);if(this.providerKeyNeeded=e.providerKeyNeeded,""===e.attribution)this.attribution="";else{if(!e.attribution||"string"!=typeof e.attribution)throw new Error("invalid attribution for layer "+this.name);this.attribution=f.sanitizeToHtmlString(e.attribution).htmlString}if(e.getCapabilitiesUrl&&"string"==typeof e.getCapabilitiesUrl&&(this.getCapabilitiesUrl=f.sanitizeToUrl(e.getCapabilitiesUrl).url,""===this.getCapabilitiesUrl))throw new Error("invalid getCapabilitiesUrl for layer "+this.name);Object.freeze(this)}}function co(e){return new so(e)}let uo=[co({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""})],go=null,vo=null,ho=null,mo=0,po=0,fo=0,bo=0;function yo(e){e.target.style.color=e.target.layer.toolbar.backgroundColor,e.target.style["background-color"]=e.target.layer.toolbar.color}function wo(e){e.target.style.color=e.target.layer.toolbar.color,e.target.style["background-color"]=e.target.layer.toolbar.backgroundColor}function To(e){e.target.classList.add("TravelNotes-LayersToolbarUI-LinkButton-Enter"),e.target.classList.remove("TravelNotes-LayersToolbarUI-LinkButton-Leave")}function No(e){De.dispatch("layerchange",{layer:e.target.layer}),lo.attributions=e.target.layer.attribution,he.travel.layerName=e.target.layer.name}function xo(e){e.target.classList.add("TravelNotes-LayersToolbarUI-LinkButton-Leave"),e.target.classList.remove("TravelNotes-LayersToolbarUI-LinkButton-Enter")}function Lo(e){e.deltaY&&(mo-=e.deltaY*c[e.deltaMode],mo=mo>bo?bo:mo,mo=mo<bo-fo+3*po?bo-fo+3*po:mo,ho.style.marginTop=String(mo)+"px"),e.stopPropagation()}function Io(){let e=ho.childNodes;for(let t=0;t<e.length;t++)"layer"===e[t].type?(e[t].removeEventListener("mouseenter",yo,!1),e[t].removeEventListener("mouseleave",wo,!1),e[t].removeEventListener("click",No,!1)):(e[t].removeEventListener("mouseenter",To,!1),e[t].removeEventListener("mouseleave",To,!1));ho.removeEventListener("wheel",Lo,!1),vo.removeChild(ho),go=null}function Eo(){go=setTimeout(Io,y.layersToolbarUI.toolbarTimeOut)}function jo(){if(go)return clearTimeout(go),void(go=null);ho=w.create("div",{id:"TravelNotes-LayersToolbarUI-Buttons"},vo),bo=vo.clientHeight,fo=0,uo.forEach(e=>function(e){if(e.providerKeyNeeded&&!Be.hasKey(e.providerName.toLowerCase()))return;let t=w.create("div",{type:"layer",className:"TravelNotes-LayersToolbarUI-Button",title:e.name,layer:e,textContent:e.toolbar.text,style:"color:"+e.toolbar.color+";background-color:"+e.toolbar.backgroundColor},ho);t.addEventListener("mouseenter",yo,!1),t.addEventListener("mouseleave",wo,!1),t.addEventListener("click",No,!1),po=t.clientHeight,fo+=po}(e)),y.layersToolbarUI.theDevil&&y.layersToolbarUI.theDevil.addButton&&function(e,t,o){let a=w.create("div",{type:"link",className:"TravelNotes-LayersToolbarUI-Button TravelNotes-LayersToolbarUI-LinkButton-Leave"},ho);w.create("a",{href:e,title:t,textContent:o,target:"_blank"},a),a.addEventListener("mouseenter",To,!1),a.addEventListener("mouseleave",xo,!1),fo+=a.clientHeight}("https://www.google.com/maps/@"+he.map.getCenter().lat+","+he.map.getCenter().lng+","+he.map.getZoom()+"z","Reminder! The devil will know everything about you","👿"),bo+=po,mo=bo,ho.style.marginTop=String(mo)+"px",ho.addEventListener("wheel",Lo,!1)}const Po=new class{constructor(){Object.freeze(this)}createUI(){vo=w.create("div",{id:"TravelNotes-LayersToolbarUI"},document.querySelector("body")),w.create("div",{id:"TravelNotes-LayersToolbarUI-Header",textContent:E.getText("LayersToolbarUI - Layers")},vo),vo.addEventListener("mouseenter",jo,!1),vo.addEventListener("mouseleave",Eo,!1),De.dispatch("layerchange",{layer:uo[0]}),lo.attributions=uo[0].attribution}getLayer(e){let t=uo.find(t=>t.name===e)||uo[0];return t.providerKeyNeeded&&(Be.hasKey(t.providerName.toLowerCase())||(t=uo[0])),t}setLayer(e){let t=uo.find(t=>t.name===e)||uo[0];t.providerKeyNeeded&&(Be.hasKey(t.providerName.toLowerCase())||(t=uo[0])),De.dispatch("layerchange",{layer:t}),lo.attributions=t.attribution,he.travel.layerName=t.name}addLayers(e){e.forEach(e=>{uo.push(co(e))})}};function Do(){let e=null,t=null,o=null,a=[],n=0,r=null,i=document.querySelector("body"),l=0;function s(){for(;0<document.getElementsByClassName("TravelNotes-routeViewDiv").length;)i.removeChild(document.getElementsByClassName("TravelNotes-routeViewDiv")[0]);document.getElementById("TravelNotes-PrintToolbar-PrintButton").removeEventListener("click",()=>window.print(),!1),document.getElementById("TravelNotes-PrintToolbar-CancelButton").removeEventListener("click",s,!1),i.removeChild(document.getElementById("TravelNotes-PrintToolbar"));let e=i.children;for(let t=0;t<e.length;t++)e.item(t).classList.remove("TravelNotes-Hidden");he.map.invalidateSize(!1),window.removeEventListener("afterprint",s,!0),document.title="Travel & Notes"+(""===he.travel.name?"":" - "+he.travel.name)}function d(e,t,a){let n=function(e,t,a){if(e.bottomLeft.lat===e.upperRight.lat&&e.bottomLeft.lng===e.upperRight.lng){let e=Math.min(Math.abs(o[0]/(a.lat-t.lat)),Math.abs(o[1]/(a.lng-t.lng)));return{lat:t.lat+e*(a.lat-t.lat),lng:t.lng+e*(a.lng-t.lng)}}return null}(e,t,a);if(n)return n;if(n=function(e,t){return t.lat-e.bottomLeft.lat<1e-6||e.upperRight.lat-t.lat<1e-6||t.lng-e.bottomLeft.lng<1e-6||e.upperRight.lng-t.lng<1e-6?{lat:t.lat,lng:t.lng}:null}(e,t),n)return n;if(n=function(e,t,o){return t.lng===o.lng?{lat:t.lat>o.lat?e.bottomLeft.lat:e.upperRight.lat,lng:t.lng}:t.lat===o.lat?{lat:t.lat,lng:t.lng<o.lng?e.upperRight.lng:e.bottomLeft.lng}:null}(e,t,a),n)return n;let r=(t.lat-a.lat)/(t.lng-a.lng),i=t.lat-r*t.lng;if(n={lat:r*e.upperRight.lng+i,lng:e.upperRight.lng},n.lat<=e.upperRight.lat&&n.lat>=e.bottomLeft.lat&&n.lng<a.lng)return n;if(n={lat:e.upperRight.lat,lng:(e.upperRight.lat-i)/r},n.lng>=e.bottomLeft.lng&&n.lng<=e.upperRight.lng&&n.lat<a.lat)return n;if(n={lat:r*e.bottomLeft.lng+i,lng:e.bottomLeft.lng},n.lat<=e.upperRight.lat&&n.lat>=e.bottomLeft.lat&&n.lng>a.lng)return n;if(n={lat:e.bottomLeft.lat,lng:(e.bottomLeft.lat-i)/r},n.lng>=e.bottomLeft.lng&&n.lng<=e.upperRight.lng&&n.lat>a.lat)return n;throw new Error("intermediate point not found")}function c(o){n++;let a="TravelNotes-RouteViewDiv"+n,l=w.create("div",{className:"TravelNotes-routeViewDiv",id:a},i);e.pageBreak&&l.classList.add("TravelNotes-PrintPageBreak"),l.style.width=String(e.paperWidth)+"mm",l.style.height=String(e.paperHeight)+"mm";let s=e.printNotes?function(){let e=[];return t.notes.forEach(t=>{let o=window.L.divIcon({iconSize:[t.iconWidth,t.iconHeight],iconAnchor:[t.iconWidth/2,t.iconHeight/2],popupAnchor:[0,-t.iconHeight/2],html:t.iconContent,className:"TravelNotes-Map-AllNotes "}),a=window.L.marker(t.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});e.push(a)}),e}():[];s.push(function(){let e=Po.getLayer(he.travel.layerName),t=Be.getUrl(e),o=null;return o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),o.options.attribution=' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ',o}()),s.push(window.L.circleMarker([o.entryPoint.lat,o.entryPoint.lng],y.printRouteMap.entryPointMarker)),s.push(window.L.circleMarker([o.exitPoint.lat,o.exitPoint.lng],y.printRouteMap.exitPointMarker)),s.push(r),window.L.map(a,{attributionControl:!0,zoomControl:!1,center:[(o.bottomLeft.lat+o.upperRight.lat)/2,(o.bottomLeft.lng+o.upperRight.lng)/2],zoom:e.zoomFactor,minZoom:e.zoomFactor,maxZoom:e.zoomFactor,layers:s})}function u(){let e=i.children;for(let t=0;t<e.length;t++)e.item(t).classList.add("TravelNotes-Hidden");document.title=""===he.travel.name?"maps":he.travel.name+" - "+t.computedName+" - maps",function(){let e=w.create("div",{id:"TravelNotes-PrintToolbar"},i);w.create("div",{id:"TravelNotes-PrintToolbar-PrintButton",className:"TravelNotes-UI-Button",title:E.getText("PrintFactory - Print"),textContent:"🖨️"},e).addEventListener("click",()=>window.print(),!1),w.create("div",{id:"TravelNotes-PrintToolbar-CancelButton",className:"TravelNotes-UI-Button",title:E.getText("PrintFactory - Cancel print"),textContent:"❌"},e).addEventListener("click",s,!1)}(),window.addEventListener("afterprint",s,!0);let o=[],l=t.itinerary.itineraryPoints.iterator;for(;!l.done;)o.push(l.value.latLng);r=window.L.polyline(o,{color:t.color,weight:t.width}),n=0,a.forEach(c)}return new class{constructor(){Object.freeze(this)}print(n,r){t=He.getRoute(r),t&&(e=n,function(){let t=document.querySelector("body"),a=w.create("div",{},t);a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width=String(e.paperWidth-2*e.borderWidth)+"mm",a.style.height=String(e.paperHeight-2*e.borderWidth)+"mm",l=Math.ceil(a.clientWidth/256)*Math.ceil(a.clientHeight/256);let n=me.screenCoordToLatLng(0,0),r=me.screenCoordToLatLng(a.clientWidth,a.clientHeight);t.removeChild(a);let i=he.map.getZoomScale(he.map.getZoom(),e.zoomFactor);o=[Math.abs(n[0]-r[0])*i,Math.abs(n[1]-r[1])*i]}(),function(){a=[];let e=t.itinerary.itineraryPoints.iterator,n=e.done,r={bottomLeft:{lat:e.value.lat,lng:e.value.lng},upperRight:{lat:e.value.lat,lng:e.value.lng}},i={lat:e.value.lat,lng:e.value.lng},s=e.value;n=e.done;let c=e.value;for(;!n;){let t={bottomLeft:{lat:Math.min(r.bottomLeft.lat,c.lat),lng:Math.min(r.bottomLeft.lng,c.lng)},upperRight:{lat:Math.max(r.upperRight.lat,c.lat),lng:Math.max(r.upperRight.lng,c.lng)}},u=[t.upperRight.lat-t.bottomLeft.lat,t.upperRight.lng-t.bottomLeft.lng];o[0]>u[0]&&o[1]>u[1]?(r=t,s=e.value,n=e.done,c=e.value,n&&(r.entryPoint=i,r.exitPoint=s,a.push(r))):(s=d(r,s,c),r.bottomLeft={lat:Math.min(r.bottomLeft.lat,s.lat),lng:Math.min(r.bottomLeft.lng,s.lng)},r.upperRight={lat:Math.max(r.upperRight.lat,s.lat),lng:Math.max(r.upperRight.lng,s.lng)},r.entryPoint=i,r.exitPoint=s,a.push(r),r={bottomLeft:{lat:s.lat,lng:s.lng},upperRight:{lat:s.lat,lng:s.lng}},i={lat:s.lat,lng:s.lng}),y.printRouteMap.maxTiles<a.length*l&&(n=!0)}}(),y.printRouteMap.maxTiles<a.length*l?je.showError(E.getText("PrintFactory - The maximum of allowed pages is reached.")):u())}}}let Co=!1,Ro=!1;function Mo(){let e=he.travel.routes.iterator,o=t.defaultValue;for(;!e.done;){e.value.chain?(e.value.chainedDistance=o,o+=e.value.distance):e.value.chainedDistance=t.defaultValue;let a=e.value.notes.iterator;for(;!a.done;)a.value.chainedDistance=e.value.chainedDistance}}function So(e){let t=!0;return e.wayPoints.forEach(e=>{t=t&&r.defaultValue!==e.lat&&r.defaultValue!==e.lng}),t}function Ao(e){Ro=!1,je.showError(e),e instanceof Error&&console.error(e)}function Oo(){Ro=!1,he.travel.editedRoute.itinerary.validateData();let e=he.travel.editedRoute.itinerary.maneuvers.iterator;for(;!e.done;)e.value.validateData();let o=he.travel.editedRoute.itinerary.itineraryPoints.iterator;for(;!o.done;)o.value.validateData();if(function(e){let o=e.itinerary.itineraryPoints.iterator,a=e.itinerary.maneuvers.iterator;for(o.done,a.done,a.value.distance=t.defaultValue,a.done,e.distance=t.defaultValue,e.duration=t.defaultValue;!o.done;)o.previous.distance=Ke.pointsDistance(o.previous.latLng,o.value.latLng),e.distance+=o.previous.distance,a.previous.distance+=o.previous.distance,a.value.itineraryPointObjId===o.value.objId&&(e.duration+=a.previous.duration,a.value.distance=t.defaultValue,a.next&&a.value.itineraryPointObjId===a.next.itineraryPointObjId&&(a.done,a.value.distance=t.defaultValue),a.done)}(he.travel.editedRoute),"circle"!==he.travel.editedRoute.itinerary.transitMode){let e=he.travel.editedRoute.wayPoints.iterator;for(;!e.done;)e.first?e.value.latLng=he.travel.editedRoute.itinerary.itineraryPoints.first.latLng:e.last?e.value.latLng=he.travel.editedRoute.itinerary.itineraryPoints.last.latLng:e.value.latLng=me.getClosestLatLngDistance(he.travel.editedRoute,e.value.latLng).latLng}let a=he.travel.editedRoute.notes.iterator;for(;!a.done;){let e=me.getClosestLatLngDistance(he.travel.editedRoute,a.value.latLng);a.value.latLng=e.latLng,a.value.distance=e.distance}Mo(),he.travel.editedRoute.notes.sort((e,t)=>e.distance-t.distance),Co&&_e().zoomToRoute(he.travel.editedRoute.objId),io.createProfile(he.travel.editedRoute),De.dispatch("routeupdated",{removedRouteObjId:he.travel.editedRoute.objId,addedRouteObjId:he.travel.editedRoute.objId}),De.dispatch("roadbookupdate"),De.dispatch("showitinerary"),De.dispatch("setrouteslist")}const ko=new class{constructor(){Object.freeze(this)}addRoute(){let e=ne();he.travel.routes.add(e),i.editedChanged===he.travel.editedRoute.editionStatus?(Mo(),De.dispatch("setrouteslist"),De.dispatch("roadbookupdate")):this.editRoute(e.objId)}editRoute(e){if(i.editedChanged===he.travel.editedRoute.editionStatus)return void je.showError(E.getText("RouteEditor - Not possible to edit a route without a save or cancel"));let t=He.getRoute(e),o=t.itinerary.provider,a=he.providers.get(o.toLowerCase());if(o&&""!==o&&(!a||a.providerKeyNeeded&&!Be.hasKey(o)))return void je.showError(E.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));-1!==he.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&De.dispatch("setprovider",{provider:o});let n=t.itinerary.transitMode;n&&""!==n&&De.dispatch("settransitmode",{transitMode:n}),he.travel.editedRoute=ne(),t.editionStatus=i.editedNoChange,he.travel.editedRoute.jsonObject=t.jsonObject,he.editedRouteObjId=t.objId,he.travel.editedRoute.hidden=!1,t.hidden=!1,io.updateProfile(he.editedRouteObjId,he.travel.editedRoute),Mo(),De.dispatch("routeupdated",{removedRouteObjId:t.objId,addedRouteObjId:he.travel.editedRoute.objId}),De.dispatch("roadbookupdate"),De.dispatch("showitinerary"),De.dispatch("setrouteslist")}removeRoute(e){let t=e;if(t===he.editedRouteObjId||t===he.travel.editedRoute.objId){if(i.editedChanged===he.travel.editedRoute.editionStatus)return void je.showError(E.getText("TravelEditor - Cannot remove an edited route"));t=he.editedRouteObjId,this.cancelEdition()}De.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:-1}),he.travel.routes.remove(t),io.deleteProfile(t),Mo(),De.dispatch("roadbookupdate"),De.dispatch("setrouteslist")}removeManeuver(e){(he.travel.editedRoute.itinerary.maneuvers.previous(e,e=>t.defaultValue<e.distance)||he.travel.editedRoute.itinerary.maneuvers.first).distance+=he.travel.editedRoute.itinerary.maneuvers.getAt(e).distance,he.travel.editedRoute.itinerary.maneuvers.remove(e),De.dispatch("showitinerary"),De.dispatch("roadbookupdate")}saveGpx(e){ze().routeToGpx(e)}chainRoutes(){Mo()}startRouting(){if(!Ro&&So(he.travel.editedRoute)){Co=0===he.travel.editedRoute.itinerary.itineraryPoints.length,Ro=!0;let e=he.providers.get(he.routing.provider.toLowerCase());he.travel.editedRoute.itinerary.provider=e.name,he.travel.editedRoute.itinerary.transitMode=he.routing.transitMode,e.getPromiseRoute(he.travel.editedRoute,null).then(Oo).catch(Ao)}}saveEdition(){let e=ne();e.jsonObject=he.travel.editedRoute.jsonObject,he.travel.routes.replace(he.editedRouteObjId,e),he.editedRouteObjId=e.objId,this.cancelEdition()}cancelEdition(){let e=He.getRoute(he.editedRouteObjId);e.editionStatus=i.notEdited,io.updateProfile(he.travel.editedRoute.objId,e),De.dispatch("routeupdated",{removedRouteObjId:he.travel.editedRoute.objId,addedRouteObjId:he.editedRouteObjId}),he.editedRouteObjId=-1,he.travel.editedRoute=ne(),Mo(),De.dispatch("roadbookupdate"),De.dispatch("setrouteslist"),De.dispatch("showitinerary")}routeProperties(e){let t=He.getRoute(e);Fe(t).show().then(()=>{Mo(),So(t)&&De.dispatch("routepropertiesupdated",{routeObjId:t.objId}),De.dispatch("roadbookupdate"),De.dispatch("setrouteslist"),De.dispatch("updateitinerary")}).catch(e=>{e instanceof Error&&console.error(e)})}printRouteMap(e){(function(){let e=null,t=null,o=null,a=null,n=null,r=null,i=null,l=null;function s(){return Object.freeze({paperWidth:parseInt(o.value),paperHeight:parseInt(a.value),borderWidth:parseInt(n.value),zoomFactor:parseInt(l.value),pageBreak:r.checked,printNotes:i.checked})}return e=pe(),e.title=E.getText("PrintRouteMapDialog - Print"),e.okButtonListener=s,t=w.create("div",{id:"TravelNotes-PrintRouteMapDialog-MainDataDiv"},e.content),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},t);w.create("text",{value:E.getText("PrintRouteMapDialog - Paper width")},e),o=w.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),o.value=y.printRouteMap.paperWidth,w.create("text",{value:E.getText("PrintRouteMapDialog - Paper width units")},e)}(),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},t);w.create("text",{value:E.getText("PrintRouteMapDialog - Paper height")},e),a=w.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:y.printRouteMap.paperHeight},e),w.create("text",{value:E.getText("PrintRouteMapDialog - Paper height units")},e)}(),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},t);w.create("text",{value:E.getText("PrintRouteMapDialog - Border width")},e),n=w.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",id:"TravelNotes-PrintRouteMapDialog-BorderWidthNumberInput",value:y.printRouteMap.borderWidth},e),w.create("text",{value:E.getText("PrintRouteMapDialog - Border width units")},e)}(),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-ZoomFactorDataDiv"},t);w.create("text",{value:E.getText("PrintRouteMapDialog - Zoom factor")},e),l=w.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(y.printRouteMap.zoomFactor,15),min:he.map.getMinZoom(),max:Math.min(he.map.getMaxZoom(),15)},e)}(),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-PageBreakDataDiv"},t);r=w.create("input",{type:"checkbox",id:"TravelNotes-PrintRouteMapDialog-PageBreakInput",checked:y.printRouteMap.pageBreak},e),w.create("text",{value:E.getText("PrintRouteMapDialog - Page break")},e)}(),function(){let e=w.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-PrintNotesDataDiv"},t);i=w.create("input",{type:"checkbox",id:"TravelNotes-PrintRouteMapDialog-PrintNotesInput",checked:y.printRouteMap.printNotes},e),w.create("text",{value:E.getText("PrintRouteMapDialog - Print notes")},e)}(),e})().show().then(t=>Do().print(t,e)).catch(e=>{e instanceof Error&&console.error(e)})}showRoute(e){He.getRoute(e).hidden=!1,De.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e}),De.dispatch("setrouteslist")}hideRoute(e){He.getRoute(e).hidden=!0,De.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:-1}),De.dispatch("setrouteslist")}showRoutes(){let e=he.travel.routes.iterator;for(;!e.done;)e.value.hidden&&(e.value.hidden=!1,De.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e.value.objId}));De.dispatch("setrouteslist")}hideRoutes(){let e=he.travel.routes.iterator;for(;!e.done;)e.value.hidden||e.value.objId===he.editedRouteObjId||(e.value.hidden=!0,De.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:-1}));De.dispatch("setrouteslist")}};function Uo(e,t){if(!y.wayPoint.reverseGeocoding)return De.dispatch("setrouteslist"),De.dispatch("showitinerary"),void De.dispatch("roadbookupdate");mt().getPromiseAddress(e).then(e=>{let o=e.street;""!==e.city&&(o+=" "+e.city),function(e,t){he.travel.editedRoute.editionStatus=i.editedChanged;let o=he.travel.editedRoute.wayPoints.getAt(t);o.name=e.name,o.address=e.address,De.dispatch("setrouteslist"),De.dispatch("showitinerary"),De.dispatch("roadbookupdate")}(Object.seal({name:e.name,address:o}),t)}).catch(e=>{e instanceof Error&&console.error(e)})}const Bo=new class{constructor(){Object.freeze(this)}addWayPoint(e){he.travel.editedRoute.editionStatus=i.editedChanged;let t=M();t.latLng=e,he.travel.editedRoute.wayPoints.add(t),Uo(e,t.objId),De.dispatch("addwaypoint",{wayPoint:he.travel.editedRoute.wayPoints.last,letter:he.travel.editedRoute.wayPoints.length-2}),he.travel.editedRoute.wayPoints.swap(t.objId,!0),ko.startRouting()}addWayPointOnRoute(e,t){let o=me.getClosestLatLngDistance(he.travel.editedRoute,e).distance;he.travel.editedRoute.editionStatus=i.editedChanged;let a=M();a.latLng=t,he.travel.editedRoute.wayPoints.add(a),Uo(t,a.objId),De.dispatch("addwaypoint",{wayPoint:he.travel.editedRoute.wayPoints.last,letter:he.travel.editedRoute.wayPoints.length-2});let n=he.travel.editedRoute.wayPoints.iterator;for(;!n.done;){if(o<me.getClosestLatLngDistance(he.travel.editedRoute,n.value.latLng).distance){he.travel.editedRoute.wayPoints.moveTo(a.objId,n.value.objId,!0);break}}ko.startRouting()}reverseWayPoints(){he.travel.editedRoute.editionStatus=i.editedChanged;let e=he.travel.editedRoute.wayPoints.iterator;for(;!e.done;)De.dispatch("removeobject",{objId:e.value.objId});for(he.travel.editedRoute.wayPoints.reverse(),e=he.travel.editedRoute.wayPoints.iterator;!e.done;)De.dispatch("addwaypoint",{wayPoint:e.value,letter:e.first?"A":e.last?"B":e.index});De.dispatch("setrouteslist"),De.dispatch("showitinerary"),De.dispatch("roadbookupdate"),ko.startRouting()}removeWayPoint(e){he.travel.editedRoute.editionStatus=i.editedChanged,De.dispatch("removeobject",{objId:e}),he.travel.editedRoute.wayPoints.remove(e),ko.startRouting()}setStartPoint(e){he.travel.editedRoute.editionStatus=i.editedChanged,r.defaultValue!==he.travel.editedRoute.wayPoints.first.lat&&De.dispatch("removeobject",{objId:he.travel.editedRoute.wayPoints.first.objId}),he.travel.editedRoute.wayPoints.first.latLng=e,Uo(e,he.travel.editedRoute.wayPoints.first.objId),De.dispatch("addwaypoint",{wayPoint:he.travel.editedRoute.wayPoints.first,letter:"A"}),ko.startRouting()}setEndPoint(e){he.travel.editedRoute.editionStatus=i.editedChanged,r.defaultValue!==he.travel.editedRoute.wayPoints.last.lat&&De.dispatch("removeobject",{objId:he.travel.editedRoute.wayPoints.last.objId}),he.travel.editedRoute.wayPoints.last.latLng=e,Uo(e,he.travel.editedRoute.wayPoints.last.objId),De.dispatch("addwaypoint",{wayPoint:he.travel.editedRoute.wayPoints.last,letter:"B"}),ko.startRouting()}wayPointDragEnd(e){he.travel.editedRoute.editionStatus=i.editedChanged,Uo(he.travel.editedRoute.wayPoints.getAt(e).latLng,e),ko.startRouting()}wayPointProperties(e){(function(e){let t=null,o=null,a=null,n=null;function r(){return e.name=a.value,e.address=n.value,e.validateData(),e}function i(t){if(t.stopPropagation(),!y.wayPoint.reverseGeocoding)return;mt().getPromiseAddress(e.latLng).then(e=>{let t=e.street;""!==e.city&&(t+=" "+e.city),n.value=t}).catch(e=>{e instanceof Error&&console.error(e)})}return t=pe(),t.title=E.getText("WayPointPropertiesDialog - Waypoint properties"),t.okButtonListener=r,o=w.create("div",{id:"TravelNotes-WayPointPropertiesDialog-DataDiv"},t.content),w.create("div",{textContent:E.getText("WayPointPropertiesDialog - Name")},o),a=w.create("input",{type:"text",value:e.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},w.create("div",null,o)),function(){let t=w.create("div",null,o);w.create("div",{className:"TravelNotes-BaseDialog-Button",title:E.getText("WayPointPropertiesDialog - Reset address"),textContent:"🔄"},t).addEventListener("click",i,!1),w.create("text",{value:E.getText("WayPointPropertiesDialog - Address")},t),n=w.create("input",{type:"text",value:e.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},w.create("div",null,o))}(),t})(he.travel.editedRoute.wayPoints.getAt(e)).show().then(()=>{De.dispatch("setrouteslist"),De.dispatch("showitinerary"),De.dispatch("roadbookupdate")}).catch(e=>{e instanceof Error&&console.error(e)})}};function Ho(e,t){let o=e.target.objId,a=He.getRoute(o),n=_e();return dt(e,function(){let t=[{context:ko,name:E.getText("RouteContextMenu - Edit this route"),action:o===he.travel.editedRoute.objId||i.editedChanged===he.travel.editedRoute.editionStatus?null:ko.editRoute,param:o},{context:ko,name:E.getText("RouteContextMenu - Delete this route"),action:o===he.travel.editedRoute.objId&&i.editedChanged===he.travel.editedRoute.editionStatus?null:ko.removeRoute,param:o},a.hidden?{context:ko,name:E.getText("RouteContextMenu - Show this route"),action:ko.showRoute,param:o}:{context:ko,name:E.getText("RouteContextMenu - Hide this route"),action:he.travel.editedRoute.objId===o?null:ko.hideRoute,param:o},{context:ko,name:E.getText("RouteContextMenu - Properties"),action:a.hidden?null:ko.routeProperties,param:o},{context:n,name:E.getText("RouteContextMenu - Zoom to route"),action:n.zoomToRoute,param:o},{context:io,name:E.getText("RouteContextMenu - View the elevation"),action:a.itinerary.hasProfile?io.showProfile:null,param:o}];return y.printRouteMap.isEnabled&&t.push({context:ko,name:E.getText("RouteContextMenu - Print route map"),action:ko.printRouteMap,param:o}),t=t.concat([{context:ko,name:E.getText("RouteContextMenu - Save this route in a GPX file"),action:0<a.itinerary.itineraryPoints.length?ko.saveGpx:null,param:o},{context:Bo,name:E.getText("RouteContextMenu - Invert waypoints"),action:he.travel.editedRoute.objId===o?Bo.reverseWayPoints:null},{context:oo,name:E.getText("RouteContextMenu - Add a note on the route"),action:e.fromUI?null:oo.newRouteNote,param:{routeObjId:o,lat:e.latlng.lat,lng:e.latlng.lng}},{context:oo,name:E.getText("RouteContextMenu - Create a note for each route maneuver"),action:a.hidden?null:oo.addAllManeuverNotes,param:o},{context:ko,name:E.getText("RouteContextMenu - Save modifications on this route"),action:he.travel.editedRoute.objId===o?ko.saveEdition:null},{context:ko,name:E.getText("RouteContextMenu - Cancel modifications on this route"),action:he.travel.editedRoute.objId===o?ko.cancelEdition:null}]),t}(),t)}function zo(e,t){let o=e.noteObjId||e.target.objId,a=_e();return dt(e,function(){let e=He.getNoteAndRoute(o).route;return[{context:oo,name:E.getText("NoteContextMenu - Edit this note"),action:oo.editNote,param:o},{context:oo,name:E.getText("NoteContextMenu - Delete this note"),action:oo.removeNote,param:o},{context:a,name:E.getText("NoteContextMenu - Zoom to note"),action:a.zoomToNote,param:o},{context:oo,name:e?E.getText("NoteContextMenu - Detach note from route"):E.getText("NoteContextMenu - Attach note to route"),action:0!==he.travel.routes.length&&-1===he.editedRouteObjId?e?oo.detachNoteFromRoute:oo.attachNoteToRoute:null,param:o}]}(),t)}let Vo=null,Fo=null;function Wo(e){let t=He.getRoute(e.target.objId),o=me.getClosestLatLngDistance(t,[e.latlng.lat,e.latlng.lng]).distance;o+=t.chainedDistance,o=j.formatDistance(o);let a=he.mapObjects.get(e.target.objId);a.closeTooltip();let n=t.computedName;he.travel.readOnly||(n+=0===n.length?"":" - ",n+=o),a.setTooltipContent(n),a.openTooltip(e.latlng)}function Ko(e,t){t.objId=e,t.addTo(he.map),he.mapObjects.set(e,t)}function _o(e){let t=He.getNoteAndRoute(e).note,o=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[y.note.grip.size,y.note.grip.size],iconAnchor:[y.note.grip.size/2,y.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:y.note.grip.opacity,draggable:!he.travel.readOnly});o.objId=t.objId;let a=window.L.divIcon({iconSize:[t.iconWidth,t.iconHeight],iconAnchor:[t.iconWidth/2,t.iconHeight/2],popupAnchor:[0,-t.iconHeight/2],html:t.iconContent,className:"TravelNotes-Map-AllNotes "}),n=window.L.marker(t.iconLatLng,{zIndexOffset:100,icon:a,draggable:!he.travel.readOnly});n.objId=t.objId,n.bindPopup(e=>_t.getNoteTextHTML("TravelNotes-Map-",He.getNoteAndRoute(e.objId))),0!==t.tooltipContent.length&&(n.bindTooltip(e=>He.getNoteAndRoute(e.objId).note.tooltipContent),n.getTooltip().options.offset[0]=t.iconWidth/2);let r=window.L.polyline([t.latLng,t.iconLatLng],y.note.polyline);r.objId=t.objId;let i=window.L.layerGroup([n,r,o]);return i.markerId=window.L.Util.stamp(n),i.polylineId=window.L.Util.stamp(r),i.bulletId=window.L.Util.stamp(o),Ko(t.objId,i),y.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach(e=>e.classList.add("TravelNotes-Map-Note-Background")),Object.freeze({marker:n,polyline:r,bullet:o})}function Zo(e){e.dashArray>=y.route.dashChoices.length&&(e.dashArray=0);let t=y.route.dashChoices[e.dashArray].iDashArray;if(t){let o="",a=0;for(a=0;a<t.length-1;a++)o+=t[a]*e.width+",";return o+=t[a]*e.width,o}return null}const Xo=new class{constructor(){Object.freeze(this)}addRoute(e){let t=He.getRoute(e),o=[],a=t.itinerary.itineraryPoints.iterator;for(;!a.done;)o.push(a.value.latLng);let n=window.L.polyline(o,{color:t.color,weight:t.width,dashArray:Zo(t)});Ko(t.objId,n),i.notEdited===t.editionStatus&&(n.bindTooltip(t.computedName,{sticky:!0,direction:"right"}),n.on("mouseover",Wo),n.on("mousemove",Wo)),n.bindPopup(e=>{let t=He.getRoute(e.objId);return _t.getRouteHeaderHTML("TravelNotes-Map-",t)}),window.L.DomEvent.on(n,"click",e=>e.target.openPopup(e.latlng));let r=t.notes.iterator;for(;!r.done;)_o(r.value.objId);return t}addNote(e){return _o(e)}getDashArray(e){return Zo(e)}zoomTo(e,t){if(t){let e=[];t.forEach(t=>e=e.concat(t)),he.map.fitBounds(me.getLatLngBounds(e))}else he.map.setView(e,y.itineraryPointZoom)}setLayer(e,t){let o=null;o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),Vo&&he.map.removeLayer(Vo),he.map.addLayer(o),Vo=o,he.travel.readOnly||(he.map.getZoom()<(e.minZoom||0)&&he.map.setZoom(e.minZoom||0),he.map.setMinZoom(e.minZoom||0),he.map.getZoom()>(e.maxZoom||18)&&he.map.setZoom(e.maxZoom||18),he.map.setMaxZoom(e.maxZoom||18),e.bounds?(he.map.getBounds().intersects(e.bounds)&&!he.map.getBounds().contains(e.bounds)||(he.map.setMaxBounds(null),he.map.fitBounds(e.bounds),he.map.setZoom(e.minZoom||0)),he.map.setMaxBounds(e.bounds)):he.map.setMaxBounds(null)),he.map.fire("baselayerchange",o)}onGeolocationStatusChanged(e){o.active!==e&&Fo&&(he.map.removeLayer(Fo),Fo=null)}onGeolocationPositionChanged(e){let t=y.geoLocation.zoomToPosition;Fo&&(he.map.removeLayer(Fo),t=!1),Fo=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),{radius:y.geoLocation.radius,color:y.geoLocation.color}).bindTooltip(j.formatLatLng([e.coords.latitude,e.coords.longitude])).addTo(he.map),t&&he.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),y.geoLocation.zoomFactor)}};let qo=null,Go=null,Jo=1;function Yo(){qo&&(window.L.DomEvent.off(qo),he.map.removeLayer(qo),qo=null)}function $o(){window.L.DomEvent.off(qo,"mouseout",Yo)}function Qo(e){e.latlng.lat=Go[0],e.latlng.lng=Go[1],e.target.objId=he.travel.editedRoute.objId,Ho(e).show()}function ea(e){Bo.addWayPointOnRoute(Go,[e.target.getLatLng().lat,e.target.getLatLng().lng]),qo&&(window.L.DomEvent.off(qo,"dragstart",$o),window.L.DomEvent.off(qo,"dragend",ea),window.L.DomEvent.off(qo,"contextmenu",Qo),he.map.removeLayer(qo),qo=null)}function ta(e){let t=He.getNoteAndRoute(e.target.objId),o=t.note,a=t.route,n=he.mapObjects.get(e.target.objId);if(null===a)o.latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],De.dispatch("updatetravelnotes");else{let t=me.getClosestLatLngDistance(a,[e.target.getLatLng().lat,e.target.getLatLng().lng]);o.latLng=t.latLng,o.distance=t.distance,a.notes.sort((e,t)=>e.distance-t.distance),n.getLayer(n.bulletId).setLatLng(t.latLng),De.dispatch("updateitinerary")}n.getLayer(n.polylineId).setLatLngs([o.latLng,o.iconLatLng]),De.dispatch("roadbookupdate")}function oa(e){let t=He.getNoteAndRoute(e.target.objId).note,o=he.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([[e.latlng.lat,e.latlng.lng],t.iconLatLng])}function aa(e){e.originalEvent.target.style.opacity=y.note.grip.moveOpacity}function na(e){e.originalEvent.target.style.opacity=y.note.grip.opacity}function ra(e){zo(e).show()}function ia(e){let t=He.getNoteAndRoute(e.target.objId).note;t.iconLatLng=[e.target.getLatLng().lat,e.target.getLatLng().lng];let o=he.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,t.iconLatLng])}function la(e){let t=He.getNoteAndRoute(e.target.objId).note,o=he.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,[e.latlng.lat,e.latlng.lng]])}function sa(e){let t=He.getRoute(e.target.objId);if(i.notEdited!==t.editionStatus)if(Go=[e.latlng.lat,e.latlng.lng],qo)qo.setLatLng(e.latlng);else{let t='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>';qo=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[20,20],iconAnchor:[10,20],html:t,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0}),(-1===y.route.showDragTooltip||Jo<=y.route.showDragTooltip)&&(Jo++,qo.bindTooltip(E.getText("MapEditor - Drag and drop to add a waypoint")),qo.getTooltip().options.offset=[0,0]),qo.addTo(he.map),window.L.DomEvent.on(qo,"mouseout",Yo),window.L.DomEvent.on(qo,"dragstart",$o),window.L.DomEvent.on(qo,"dragend",ea),window.L.DomEvent.on(qo,"contextmenu",Qo)}}function da(e){Ho(e).show()}function ca(e){(function(e){let t=e.target.objId;return dt(e,function(){let e=he.travel.editedRoute.wayPoints.first.objId!==t&&he.travel.editedRoute.wayPoints.last.objId!==t;return[{context:Bo,name:E.getText("WayPointContextMenu - Delete this waypoint"),action:e?Bo.removeWayPoint:null,param:t},{context:Bo,name:E.getText("WayPointContextMenu - Modify properties"),action:Bo.wayPointProperties,param:t}]}())})(e).show()}function ua(e){he.travel.editedRoute.wayPoints.getAt(e.target.objId).latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],Bo.wayPointDragEnd(e.target.objId)}function ga(e,t){t.objId=e,t.addTo(he.map),he.mapObjects.set(e,t)}function va(e){let t=he.mapObjects.get(e);t&&(window.L.DomEvent.off(t),he.map.removeLayer(t),he.mapObjects.delete(e))}function ha(e,t){if(r.defaultValue===e.lat&&r.defaultValue===e.lng)return;let o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===t?"Start":"B"===t?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+t+"</div>",a=window.L.marker(e.latLng,{icon:window.L.divIcon({iconSize:[20,20],iconAnchor:[10,20],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});a.bindTooltip(e=>He.getWayPoint(e.objId).fullName),a.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(a,"contextmenu",ca),a.objId=e.objId,ga(e.objId,a),window.L.DomEvent.on(a,"dragend",ua)}const ma=new class{constructor(){Object.freeze(this)}updateRoute(e,t){-1!==e&&function(e){let t=He.getRoute(e);va(t.objId);let o=t.notes.iterator;for(;!o.done;)va(o.value.objId);let a=t.wayPoints.iterator;for(;!a.done;)va(a.value.objId)}(e),-1!==t&&function(e){let t=Xo.addRoute(e),o=he.mapObjects.get(e);if(!he.travel.readOnly){window.L.DomEvent.on(o,"contextmenu",da),window.L.DomEvent.on(o,"mouseover",sa);let e=t.notes.iterator;for(;!e.done;){let t=he.mapObjects.get(e.value.objId),o=t.getLayer(t.markerId),a=t.getLayer(t.bulletId);window.L.DomEvent.on(a,"dragend",ta),window.L.DomEvent.on(a,"drag",oa),window.L.DomEvent.on(a,"mouseenter",aa),window.L.DomEvent.on(a,"mouseleave",na),window.L.DomEvent.on(o,"contextmenu",ra),window.L.DomEvent.on(o,"dragend",ia),window.L.DomEvent.on(o,"drag",la)}}if(!he.travel.readOnly&&i.notEdited!==t.editionStatus){let e=he.travel.editedRoute.wayPoints.iterator;for(;!e.done;)ha(e.value,e.first?"A":e.last?"B":e.index)}}(t)}updateRouteProperties(e){let t=he.mapObjects.get(e),o=He.getRoute(e);t.setStyle({color:o.color,weight:o.width,dashArray:Xo.getDashArray(o)})}updateNote(e,t){let o=!1;if(-1!==e){let t=he.mapObjects.get(e);t&&(o=t.getLayer(t.markerId).isPopupOpen()),va(e)}-1!==t&&function(e,t){let o=Xo.addNote(e);t&&o.marker.openPopup(),he.travel.readOnly||(window.L.DomEvent.on(o.bullet,"dragend",ta),window.L.DomEvent.on(o.bullet,"drag",oa),window.L.DomEvent.on(o.bullet,"mouseenter",aa),window.L.DomEvent.on(o.bullet,"mouseleave",na),window.L.DomEvent.on(o.marker,"contextmenu",ra),window.L.DomEvent.on(o.marker,"dragend",ia),window.L.DomEvent.on(o.marker,"drag",la))}(t,o)}removeObject(e){va(e)}removeAllObjects(){he.mapObjects.forEach(e=>{window.L.DomEvent.off(e),he.map.removeLayer(e)}),he.mapObjects.clear()}addWayPoint(e,t){ha(e,t)}addItineraryPointMarker(e,t){ga(e,window.L.circleMarker(t,y.itineraryPointMarker))}addSearchPointMarker(e,t,o){let a=!1;if(o){let e=[];o.forEach(t=>{e=e.concat(t)});let t=me.getLatLngBounds(e),n=he.map.getBounds();a=(t.getEast()-t.getWest())/(n.getEast()-n.getWest())>.01&&(t.getNorth()-t.getSouth())/(n.getNorth()-n.getSouth())>.01}ga(e,a?window.L.polyline(o,y.searchPointPolyline):window.L.circleMarker(t,y.searchPointMarker))}addRectangle(e,t,o){ga(e,window.L.rectangle(t,o))}setLayer(e){let t=Be.getUrl(e);t&&Xo.setLayer(e,t)}};function pa(e){return Math.floor(Math.abs(e)+.5)*(0<=e?1:-1)}const fa=new class{constructor(){Object.freeze(this)}encode(e,t){if(!e.length)return"";let o=t.length,a=Array.from(t,e=>Math.pow(10,e));function n(e,t,o){let a=pa(e*o),n=pa(t*o),r=a-n;r<<=1,0>a-n&&(r=~r);let i="";for(;32<=r;)i+=String.fromCharCode(63+(32|31&r)),r>>=5;return i+=String.fromCharCode(r+63),i}let r="";for(let t=0;t<o;t++)r+=n(e[0][t],0,a[t]);for(let t=1;t<e.length;t++){let i=e[t],l=e[t-1];for(let e=0;e<o;e++)r+=n(i[e],l[e],a[e])}return r}decode(e,t){let o=t.length;if(!e||0===e.length)return[];let a=0,n=[],r=Array.from(t,e=>Math.pow(10,e)),i=new Array(o).fill(0);function l(){let t=null,o=0,n=0;do{t=e.charCodeAt(a++)-63,n|=(31&t)<<o,o+=5}while(32<=t);return 1&n?~(n>>1):n>>1}for(;a<e.length;){let e=new Array(o).fill(0);for(let t=0;t<o;t++)i[t]+=l(),e[t]=i[t]/r[t];n.push(e)}return n}};function ba(){function e(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let o={values:"",objType:t},a=[];e.itinerary.itineraryPoints.forEach(e=>{a.push([e.lat,e.lng,e.distance,e.elev,e.objId])}),o.values=fa.encode(a,[r.fixed,r.fixed,2,2,0]),e.itinerary.itineraryPoints=o}function o(e){let o=[];if(e.itinerary.itineraryPoints.values)fa.decode(e.itinerary.itineraryPoints.values,[r.fixed,r.fixed,2,2,0]).forEach(a=>{let i={lat:r.defaultValue,lng:r.defaultValue,distance:t.defaultValue,elev:n.defaultValue,objId:-1};[i.lat,i.lng,i.distance,i.elev,i.objId]=a,i.objType=e.itinerary.itineraryPoints.objType,o.push(i)});else{e.itinerary.itineraryPoints.latLngs=fa.decode(e.itinerary.itineraryPoints.latLngs,[r.fixed,r.fixed]);let t=0;e.itinerary.itineraryPoints.latLngs.forEach(a=>{let r={};r.lat=a[0],r.lng=a[1],r.distance=e.itinerary.itineraryPoints.distances[t],e.itinerary.itineraryPoints.elevs?r.elev=e.itinerary.itineraryPoints.elevs[t]:r.elev=n.defaultValue,r.objId=e.itinerary.itineraryPoints.objIds[t],r.objType=e.itinerary.itineraryPoints.objType,o.push(r),t++})}e.itinerary.itineraryPoints=o}function a(e){e.routes.forEach(o),e.editedRoute&&o(e.editedRoute)}return new class{constructor(){Object.freeze(this)}decompress(e){a(e),he.travel.jsonObject=e,he.editedRouteObjId=-1,he.travel.routes.forEach(e=>{i.notEdited!==e.editionStatus&&(he.editedRouteObjId=e.objId)})}decompressMerge(e){a(e);let t=de();t.jsonObject=e;let o=t.routes.iterator;for(;!o.done;)he.travel.routes.add(o.value);let n=t.notes.iterator;for(;!n.done;)he.travel.notes.add(n.value)}compress(){let t=he.travel.jsonObject;return t.routes.forEach(e),e(t.editedRoute),t}}}let ya=null,wa=null,Ta=null,Na=e.saved,xa=null;function La(){ya.textContent=Na+" "+wa+" - Zoom : "+Ta}function Ia(t){e.modified===t&&e.notSaved===Na||(Na=t,e.modified!==t||xa||(xa=setTimeout(Ia,3e5,e.notSaved)),e.saved===t&&xa&&(clearTimeout(xa),xa=null),La())}function Ea(e){wa=j.formatLatLng([e.latlng.lat,e.latlng.lng]),La()}function ja(){Ta=String(he.map.getZoom()),La()}const Pa=new class{constructor(){Object.freeze(this)}set saveStatus(e){Ia(e)}createUI(){Ta=he.map.getZoom(),wa=j.formatLat(y.map.center.lat)+" - "+j.formatLng(y.map.center.lng),ya=w.create("span",null,w.create("div",{id:"TravelNotes-MouseUI"},document.querySelector("body"))),he.map.on("mousemove",Ea),he.map.on("zoomend",ja)}};const Da=new class{constructor(){Object.freeze(this)}routeDropped(e,t,o){he.travel.routes.moveTo(e,t,o),ko.chainRoutes(),De.dispatch("setrouteslist"),De.dispatch("roadbookupdate")}saveTravel(){let t=he.travel.routes.iterator;for(;!t.done;)t.value.hidden=!1;let o=ba().compress(he.travel);j.saveFile(o.name+".trv",JSON.stringify(o)),Pa.saveStatus=e.saved}clear(){window.confirm(E.getText("TravelEditor - This page ask to close; data are perhaps not saved."))&&(io.deleteAllProfiles(),De.dispatch("removeallobjects"),he.travel.editedRoute=ne(),he.editedRouteObjId=-1,he.travel=de(),he.travel.routes.add(ne()),De.dispatch("setrouteslist"),De.dispatch("showitinerary"),De.dispatch("roadbookupdate"),De.dispatch("travelnameupdated"),y.travelEditor.startupRouteEdition&&ko.editRoute(he.travel.routes.first.objId),Pa.saveStatus=e.saved)}};function Ca(){return new class{constructor(){Object.freeze(this)}openDistantFile(e){ba().decompress(e),he.travel.readOnly=!0,this.display()}display(){document.title="Travel & Notes"+(""===he.travel.name?"":" - "+he.travel.name);let e=he.travel.routes.iterator;for(;!e.done;)i.notEdited===e.value.editionStatus&&De.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e.value.objId});-1!==he.editedRouteObjId&&De.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:he.travel.editedRoute.objId});let t=he.travel.notes.iterator;for(;!t.done;)De.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:t.value.objId});_e().zoomToTravel()}}}function Ra(){function t(t,o){let a=new FileReader;a.onload=function(){let t={};try{t=JSON.parse(a.result)}catch(e){return void(e instanceof Error&&console.error(e))}o?ba().decompressMerge(t):(io.deleteAllProfiles(),ba().decompress(t)),function(){if(De.dispatch("removeallobjects"),Ca().display(),Po.setLayer(he.travel.layerName),De.dispatch("setrouteslist"),-1!==he.editedRouteObjId){let e=he.travel.editedRoute.itinerary.provider;if(e&&""!==e&&!he.providers.get(e.toLowerCase()))je.showError(E.getText("FileLoader - Not possible to select as provider",{provider:e}));else{let t=he.travel.editedRoute.itinerary.transitMode;De.dispatch("setprovider",{provider:e}),t&&""!==t&&De.dispatch("settransitmode",{transitMode:t})}}ko.chainRoutes(),De.dispatch("travelnameupdated"),De.dispatch("showitinerary"),De.dispatch("roadbookupdate")}(),o||(Pa.saveStatus=e.saved)},a.readAsText(t.target.files[0])}return new class{constructor(){Object.freeze(this)}openLocalFile(e){t(e,!1)}mergeLocalFile(e){t(e,!0)}}}let Ma=null,Sa=null,Aa=null,Oa=0,ka=null,Ua=null,Ba=null,Ha=null;function za(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*c[e.deltaMode]),e.stopPropagation()}function Va(e){he.travel.name=f.sanitizeToJsString(e.target.value),document.title="Travel & Notes"+(""===he.travel.name?"":" - "+he.travel.name),De.dispatch("roadbookupdate")}function Fa(e){e.stopPropagation(),Da.clear(),document.title="Travel & Notes"+(""===he.travel.name?"":" - "+he.travel.name)}function Wa(e){e.stopPropagation(),""===he.travel.name?je.showError(E.getText("TravelUI - Gives a name to the travel")):Da.saveTravel()}function Ka(e){e.stopPropagation(),Ra().openLocalFile(e)}function _a(){window.confirm(E.getText("TravelEditor - This page ask to close; data are perhaps not saved."))&&Ua.click()}function Za(e){e.stopPropagation(),Ra().mergeLocalFile(e)}function Xa(){-1===he.editedRouteObjId?Ba.click():je.showError(E.getText("TravelUI - Not possible to merge a travel when a route is edited"))}function qa(){ka=w.create("div",{className:"TravelNotes-UI-FlexRowDiv"},Aa),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelUI - Cancel travel"),textContent:"❌"},ka).addEventListener("click",Fa,!1),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelUI - Save travel"),textContent:"💾"},ka).addEventListener("click",Wa,!1),Ua=w.create("input",{className:"TravelNotes-TravelUI-OpenFileInput",type:"file",accept:".trv"},ka),Ua.addEventListener("change",Ka,!1),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelUI - Open travel"),textContent:"📂"},ka).addEventListener("click",_a,!1),Ba=w.create("input",{className:"TravelNotes-TravelUI-OpenFileInput",type:"file",accept:".trv,.map"},ka),Ba.addEventListener("change",Za,!1),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelUI - Import travel"),textContent:"🌏"},ka).addEventListener("click",Xa,!1),w.create("text",{value:"📋"},w.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+y.language+"&page="+he.UUID,target:"_blank"},w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelUI - Open travel roadbook")},ka)))}function Ga(e){e.stopPropagation(),Ma.classList.toggle("TravelNotes-Hidden");let t=Ma.classList.contains("TravelNotes-Hidden");e.target.textContent=t?"▶":"▼",e.target.title=t?E.getText("TravelUI - Show"):E.getText("TravelUI - Hide")}function Ja(e){e.stopPropagation(),ko.addRoute()}function Ya(){Ha=w.create("div",{className:"TravelNotes-UI-FlexRowDiv"},Aa),w.create("div",{textContent:"▼",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},Ha).addEventListener("click",Ga,!1),w.create("span",{textContent:E.getText("TravelUI - Travel routes")},Ha),w.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:E.getText("TravelUI - Add a route"),textContent:"+"},Ha).addEventListener("click",Ja,!1)}function $a(e){e.stopPropagation();try{e.dataTransfer.setData("Text",e.target.objId),e.dataTransfer.dropEffect="move",e.dataTransfer.routeObjId=e.target.objId}catch(e){e instanceof Error&&console.error(e)}Oa=e.target.objId}function Qa(e){e.preventDefault()}function en(e){e.preventDefault();let t=e.target;for(;!t.objId;)t=t.parentElement;let o=t.getBoundingClientRect();Da.routeDropped(Oa,t.objId,e.clientY-o.top<o.bottom-e.clientY)}function tn(e){e.stopPropagation(),e.preventDefault(),e.latlng={lat:r.defaultValue,lng:r.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY},Ho(e,Aa).show()}const on=new class{constructor(){Object.freeze(this)}createUI(e){Aa||(Aa=e,function(){let e=w.create("div",{className:"TravelNotes-UI-FlexRowDiv"},Aa);w.create("span",{textContent:E.getText("TravelUI - Travel")},e),Sa=w.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:he.travel.name},e),Sa.addEventListener("change",Va,!1)}(),qa(),Ya(),Ma=w.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},Aa),Ma.addEventListener("drop",en,!1),Ma.addEventListener("dragover",Qa,!1),Ma.addEventListener("wheel",za,!1))}setRoutesList(){for(;Ma.firstChild;)Ma.firstChild.removeEventListener("dragstart",$a,!1),Ma.firstChild.removeEventListener("contextmenu",tn,!1),Ma.removeChild(Ma.firstChild);let e=he.travel.routes.iterator;for(;!e.done;){let t=e.value.objId===he.editedRouteObjId?he.travel.editedRoute:e.value,o=(e.value.objId===he.editedRouteObjId?"🔴 ":"")+(t.chain?"⛓ ":"")+(e.value.objId===he.editedRouteObjId?he.travel.editedRoute.computedName:t.computedName),a=w.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(e.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),objId:e.value.objId===he.editedRouteObjId?he.travel.editedRoute.objId:e.value.objId,canDrag:!0,textContent:o},Ma);a.addEventListener("dragstart",$a,!1),a.addEventListener("contextmenu",tn,!1)}}setTravelName(){Sa.value=he.travel.name}};let an=a.invalidPane,nn=new Map,rn=null,ln=null;function sn(e){a.invalidPane!==an&&(nn.get(an).remove(),rn.textContent=""),an=e,nn.get(an).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach(e=>{e.paneId===an?e.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):e.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")})}function dn(e){sn(e.target.paneId)}function cn(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*c[e.deltaMode]),e.stopPropagation()}const un=new class{constructor(){Object.freeze(this)}createUI(e){if(rn)return;let t=w.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e);ln=w.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},e),rn=w.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},e),rn.addEventListener("wheel",cn,!1),nn.forEach(e=>{w.create("div",{textContent:e.getButtonText(),className:"TravelNotes-PanesManagerUI-PaneButton",paneId:e.getId()},t).addEventListener("click",dn,!1),e.setPaneDivs(rn,ln)})}addPane(e){nn.set(e.getId(),e)}showPane(e){sn(e)}updatePane(e){e===an&&sn(e)}},gn=["bike","pedestrian","car","train","line","circle"],vn={bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns=\t\t"http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625\t\tH 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5\t\t.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7\t\t346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0\t\t.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7\t\t073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-\t\t2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.\t\t2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.646\t\t3159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999\t\t999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-\t\t2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2\t\t.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /></svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" t\t\transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.\t\t4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1\t\t.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1\t\t.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -\t\t15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.\t\t7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -\t\t4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.\t\t5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 \t\t-0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /></g></svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"><\t\tpath d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9\t\t.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z \t\tm 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01\t\t143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 \t\t0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,\t\t1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"><rect \t\tx="1" y="10" width="2" height="3" /><rect x="11" y="10" width="2" height="3" /></g></g></svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)">\t\t<path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m \t\t-1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 \t\t-1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2=\t\t"11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1=\t\t"16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <\t\tcircle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <cir\t\tcle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'};let hn=null,mn=!1,pn={bike:null,pedestrian:null,car:null,train:null,line:null,circle:null};function fn(e){he.routing.transitMode=e;let t=document.querySelector(".TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton");t&&t.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"),document.getElementById("TravelNotes-ProvidersToolbarUI-"+e+"ImgButton").classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}function bn(e){e.stopPropagation(),fn(e.target.transitMode),ko.startRouting()}function yn(e){he.routing.provider=e;let t=document.querySelector(".TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton");t&&t.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"),document.getElementById("TravelNotes-ProvidersToolbarUI-"+e+"ImgButton").classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton");let o=he.providers.get(e.toLowerCase());if(gn.forEach(e=>{o.transitModes[e]?pn[e].classList.remove("TravelNotes-ProvidersToolbarUI-InactiveImgButton"):pn[e].classList.add("TravelNotes-ProvidersToolbarUI-InactiveImgButton")}),!o.transitModes[he.routing.transitMode]){let e=null;gn.forEach(t=>{o.transitModes[t]&&(e=e||t)}),fn(e)}}function wn(e){e.stopPropagation(),yn(e.target.provider),ko.startRouting()}function Tn(e){if(0===e.providerKey)return;let t=w.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbarUI-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:e.name,provider:e.name},hn);if(t.addEventListener("click",wn,!1),!mn){t.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"),he.routing.provider=t.provider,mn=!0;let o=null;gn.forEach(t=>{e.transitModes[t]&&(o=o||t)}),pn[o].classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"),he.routing.transitMode=o,gn.forEach(t=>{e.transitModes[t]||pn[t].classList.add("TravelNotes-ProvidersToolbarUI-InactiveImgButton")})}}function Nn(){he.providers&&(mn=!1,he.providers.forEach(Tn))}function xn(){gn.forEach(e=>{pn[e]=w.create("img",{src:vn[e],id:"TravelNotes-ProvidersToolbarUI-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:E.getText("ProvidersToolbarUI - "+e),transitMode:e},hn),pn[e].addEventListener("click",bn,!1)})}const Ln=new class{constructor(){Object.freeze(this)}createUI(e){hn=w.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},e),xn(),Nn()}set provider(e){yn(e)}set transitMode(e){fn(e)}providersAdded(){for(;hn.firstChild;)hn.removeChild(hn.firstChild);xn(),Nn()}};let In="geolocation"in navigator?o.inactive:o.disabled,En=null;function jn(e){De.dispatch("geolocationpositionchanged",{position:e})}function Pn(){o.active===In&&(In=o.inactive),De.dispatch("geolocationstatuschanged",{status:In}),navigator.geolocation.clearWatch(En),En=null}function Dn(e){1===e.code&&(In=o.refusedByUser),Pn()}const Cn=new class{constructor(){Object.freeze(this)}get status(){return In}switch(){switch(In){case o.inactive:In=o.active,De.dispatch("geolocationstatuschanged",{status:In}),navigator.geolocation.getCurrentPosition(jn,Dn,y.geoLocation.options),En=navigator.geolocation.watchPosition(jn,Dn,y.geoLocation.options);break;case o.active:Pn()}return In}};let Rn=null,Mn=null,Sn=null;function An(e){e.stopPropagation(),Be.setKeysFromDialog()}function On(e){e.stopPropagation(),Cn.switch()}function kn(e){e.target.textContent="📌"===e.target.textContent?"❌":"📌",Sn.pin()}const Un=new class{constructor(){Object.freeze(this)}createUI(e){Sn=e,Mn=w.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),w.create("text",{value:"🏠"},w.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},w.create("div",{className:"TravelNotes-UI-Button",title:"Home"},Mn))),w.create("text",{value:"?"},w.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://github.com/wwwouaiebe/leaflet.TravelNotes/tree/gh-pages/TravelNotesGuides",target:"_blank"},w.create("div",{className:"TravelNotes-UI-Button",title:"Help"},Mn))),w.create("text",{value:"@"},w.create("a",{className:"TravelNotes-UI-LinkButton",href:y.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},w.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},Mn))),y.APIKeys.showDialogButton&&w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelNotesToolbarUI - API keys"),textContent:"🔑"},Mn).addEventListener("click",An,!1),o.disabled<Cn.status&&(Rn=w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("TravelNotesToolbarUI - Geo location"),textContent:"🌐"},Mn),Rn.addEventListener("click",On,!1)),w.create("div",{textContent:y.travelEditor.startMinimized?"📌":"❌",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},Mn).addEventListener("click",kn,!1)}geoLocationStatusChanged(e){switch(e){case o.inactive:Rn.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case o.active:Rn.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:Rn&&(Rn.parentNode.removeChild(Rn),Rn=null)}}};function Bn(){let e=y.itineraryPane.showNotes,t=y.itineraryPane.showManeuvers,o=null,n=null,i=null,l=null,s=null,d=null;function c(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.latLng;)t=t.parentNode;e.latlng={lat:r.defaultValue,lng:r.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY,latLng:t.latLng},t.maneuverObjId?(e.maneuverObjId=t.maneuverObjId,function(e,t){let o=e.maneuverObjId,a=_e();return dt(e,[{context:a,name:E.getText("ManeuverContextMenu - Zoom to this maneuver"),action:a.zoomToManeuver,param:o}],t)}(e,o.parentNode).show()):t.noteObjId&&(e.noteObjId=t.noteObjId,zo(e,o.parentNode).show())}function u(e){e.stopPropagation(),De.dispatch("additinerarypointmarker",{objId:e.target.objId,latLng:e.target.latLng})}function g(e){e.stopPropagation(),De.dispatch("removeobject",{objId:e.target.objId})}function v(t){e=t.target.checked,document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Notes-Row").forEach(e=>{e.classList.toggle("TravelNotes-Hidden")})}function h(e){t=e.target.checked,document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Maneuvers-Row").forEach(e=>{e.classList.toggle("TravelNotes-Hidden")})}return new class{constructor(){Object.freeze(this)}remove(){!function(){document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Notes-Row, .TravelNotes-ItineraryPaneUI-Route-Maneuvers-Row").forEach(e=>{e.removeEventListener("contextmenu",c,!1),e.removeEventListener("mouseenter",u,!1),e.removeEventListener("mouseleave",g,!1)});let e=document.querySelector(".TravelNotes-ItineraryPaneUI-Route-ManeuversAndNotes");e&&o.removeChild(e)}(),i&&(d&&(d.removeEventListener("click",h,!1),i.removeChild(d),d=null),s&&(s.removeEventListener("click",v,!1),i.removeChild(s),s=null),n.removeChild(i),i=null),l&&(n.removeChild(l),l=null)}add(){-1!==he.editedRouteObjId&&(i=w.create("div",null,n),w.create("text",{value:E.getText("ItineraryPaneUI - Show notes")},i),s=w.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:e},i),s.addEventListener("click",v,!1),w.create("text",{value:E.getText("ItineraryPaneUI - Show maneuvers")},i),d=w.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:t},i),d.addEventListener("click",h,!1),l=_t.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",he.travel.editedRoute),n.appendChild(l),o.appendChild(_t.getEditedRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-")),document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Notes-Row, .TravelNotes-ItineraryPaneUI-Route-Maneuvers-Row").forEach(e=>{e.addEventListener("contextmenu",c,!1),e.addEventListener("mouseenter",u,!1),e.addEventListener("mouseleave",g,!1)}),e||document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Notes-Row").forEach(e=>{e.classList.toggle("TravelNotes-Hidden")}),t||document.querySelectorAll(".TravelNotes-ItineraryPaneUI-Route-Maneuvers-Row").forEach(e=>{e.classList.toggle("TravelNotes-Hidden")}))}getId(){return a.itineraryPane}getButtonText(){return E.getText("PanesManagerUI - Itinerary")}setPaneDivs(e,t){o=e,n=t}}}let Hn=-1,zn=-1,Vn=!1;let Fn=null,Wn=null,Kn=null,_n=[];class Zn{constructor(e,t){this.name=f.sanitizeToJsString(e),this.items=[],this.filterTagsArray=[],this.elementTypes=["node","way","relation"],this.isSelected=!1,this.isExpanded=!1,this.isRoot=!1,t&&(this.isExpanded=!0,this.isRoot=!0)}}function Xn(){-1===zn?zn=N():De.dispatch("removeobject",{objId:zn});let e=he.map.getCenter();Wn=he.map.getBounds();let t=me.getSquareBoundingBox([e.lat,e.lng],5e3);Wn.getSouthWest().lat=Math.max(Wn.getSouthWest().lat,t.getSouthWest().lat),Wn.getSouthWest().lng=Math.max(Wn.getSouthWest().lng,t.getSouthWest().lng),Wn.getNorthEast().lat=Math.min(Wn.getNorthEast().lat,t.getNorthEast().lat),Wn.getNorthEast().lng=Math.min(Wn.getNorthEast().lng,t.getNorthEast().lng),De.dispatch("addrectangle",{objId:zn,bounds:Wn,properties:y.nextSearchLimit})}function qn(e){e.isSelected&&0<e.filterTagsArray.length&&(_n=_n.concat(e)),e.items.forEach(qn)}function Gn(e,t){_n.forEach(o=>{o.filterTagsArray.forEach(a=>{(function(e,t){let o=!0;return t.forEach(t=>{let[a,n]=Object.entries(t)[0];o=o&&e.tags[a]&&(!n||e.tags[a]===n)}),o})(e,a)&&(e.description=o.name,t.set(e.id,e))})})}function Jn(e){let t=new Map,o=new Map,a=new Map,n=new Map;function i(e){e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.nodes.forEach(a=>{let n=o.get(a);e.geometry[0].push([n.lat,n.lon]),e.lat+=n.lat,e.lon+=n.lon,t++}),0!==t&&(e.lat/=t,e.lon/=t)}e.forEach(e=>{switch(e.type){case"node":o.set(e.id,e);break;case"way":a.set(e.id,e);break;case"relation":n.set(e.id,e)}e.tags&&Gn(e,t)}),t.forEach(e=>{switch(e.type){case"way":i(e);break;case"relation":!function(e){e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.members.forEach(o=>{if("way"===o.type){let n=a.get(o.ref);i(n),e.geometry.push(n.geometry[0]),e.lat+=n.lat,e.lon+=n.lon,t++}}),0!==t&&(e.lat/=t,e.lon/=t)}(e)}}),he.searchData=Array.from(t.values()).sort((e,t)=>e.description>t.description?1:e.description<t.description?-1:0),Vn=!1,De.dispatch("showsearch")}async function Yn(e){let t=[];for(let o=0;o<e.length;o++)if("fulfilled"===e[o].status&&200===e[o].value.status&&e[o].value.ok){let a=await e[o].value.json();t=t.concat(a.elements)}Jn(t)}const $n=new class{constructor(){Object.freeze(this)}get dictionary(){return Kn}search(){Vn||(Vn=!0,_n=[],qn(Kn),Promise.allSettled(function(){let e=[];Fn=Wn;let t=new Map;_n.forEach(e=>{e.filterTagsArray.forEach(o=>{let[a,n]=Object.entries(o[0])[0],r=t.get(a);r||(r={values:new Map,elements:new Map},t.set(a,r)),r.values.set(n,n),e.elementTypes.forEach(e=>{r.elements.set(e,e)})})});let o="("+Wn.getSouthWest().lat.toFixed(r.fixed)+","+Wn.getSouthWest().lng.toFixed(r.fixed)+","+Wn.getNorthEast().lat.toFixed(r.fixed)+","+Wn.getNorthEast().lng.toFixed(r.fixed)+")";return t.forEach((t,a)=>{let n='"'+a+'"';if(1===t.values.size){let e=t.values.values().next().value;e&&(n+='="'+e+'"')}else 1<t.values.size&&(n+='~"',t.values.forEach(e=>{n+=e+"|"}),n=n.substr(0,n.length-1)+'"');let r=1===t.elements.size?t.elements.values().next().value:"nwr",i=y.overpassApi.url+"?data=[out:json][timeout:40];"+r+"["+n+"]"+o+";"+("node"===r?"":"(._;>;);")+"out;";e.push(fetch(i))}),e}()).then(Yn))}show(){he.map.on("zoom",Xn),he.map.on("move",Xn),Xn(),Fn&&(-1===Hn?Hn=N():De.dispatch("removeobject",{objId:Hn}),De.dispatch("addrectangle",{objId:Hn,bounds:[[Fn.getSouthWest().lat,Fn.getSouthWest().lng],[Fn.getNorthEast().lat,Fn.getNorthEast().lng]],properties:y.previousSearchLimit}))}hide(){let e=De;he.map.off("zoom",Xn),he.map.off("move",Xn),-1!==zn&&(e.dispatch("removeobject",{objId:zn}),zn=-1),-1!==Hn&&(e.dispatch("removeobject",{objId:Hn}),Hn=-1)}parseDictionary(e){Kn=new Zn("All",!0);let t=[Kn.items],o=null,a=null;e.split(/\r\n|\r|\n/).forEach(e=>{""!==e&&function(e){let n=e.split(";");for(;""===n[n.length-1];)n.pop();let r=0,i=null;n.forEach(e=>{if(""!==e)if(-1===e.indexOf("="))a=new Zn(e),t[r].push(a),t[r+1]=a.items,o=a.filterTagsArray;else{let t=e.split("=");if("element"===t[0])a.elementTypes=[t[1]];else{let e={};e[t[0]]="*"===t[1]?null:t[1],i=i||[],i.push(e)}}r++}),i&&o.push(i)}(e)})}};function Qn(){let e=null,t=null,o=null,n=null,i=null,l=-1,s=0;function d(t){t.stopPropagation(),t.preventDefault();let o=t.target;for(;!o.osmElement;)o=o.parentNode;t.latlng={lat:r.defaultValue,lng:r.defaultValue},t.fromUI=!0,t.originalEvent={clientX:t.clientX,clientY:t.clientY,latLng:[o.osmElement.lat,o.osmElement.lon],osmElement:o.osmElement,geometry:o.osmElement.geometry},function(e,t){let o=_e();return dt(e,function(){let t=e.originalEvent.latLng;return[{context:Bo,name:E.getText("MapContextMenu - Select this point as start point"),action:-1!==he.editedRouteObjId&&r.defaultValue===he.travel.editedRoute.wayPoints.first.lat?Bo.setStartPoint:null,param:t},{context:Bo,name:E.getText("MapContextMenu - Select this point as way point"),action:-1===he.editedRouteObjId?null:Bo.addWayPoint,param:t},{context:Bo,name:E.getText("MapContextMenu - Select this point as end point"),action:-1!==he.editedRouteObjId&&r.defaultValue===he.travel.editedRoute.wayPoints.last.lat?Bo.setEndPoint:null,param:t},{context:oo,name:E.getText("OsmSearchContextMenu - Create a route note with this result"),action:oo.newSearchNote,param:{osmElement:e.originalEvent.osmElement,isTravelNote:!1}},{context:oo,name:E.getText("OsmSearchContextMenu - Create a travel note with this result"),action:oo.newSearchNote,param:{osmElement:e.originalEvent.osmElement,isTravelNote:!0}},{context:oo,name:oo.osmSearchNoteDialog?E.getText("OsmSearchContextMenu - Hide note dialog"):E.getText("OsmSearchContextMenu - Show note dialog"),action:oo.changeOsmSearchNoteDialog},{context:o,name:E.getText("OsmSearchContextMenu - Zoom to this result"),action:o.zoomToPoi,param:{latLng:e.originalEvent.latLng,geometry:e.originalEvent.geometry}}]}(),t)}(t,e).show()}function u(e){e.stopPropagation(),l=e.target.objId,De.dispatch("addsearchpointmarker",{objId:e.target.objId,latLng:[e.target.osmElement.lat,e.target.osmElement.lon],geometry:e.target.osmElement.geometry})}function g(e){e.stopPropagation(),De.dispatch("removeobject",{objId:e.target.objId})}function v(){document.querySelectorAll(".TravelNotes-OsmSearchPaneUI-SearchResult").forEach(t=>{t.removeEventListener("contextmenu",d,!1),t.removeEventListener("mouseenter",u,!1),t.removeEventListener("mouseleave",g,!1),e.removeChild(t)})}function h(e){s++;let t=w.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+s,dictItem:e},i);if(!e.isRoot){w.create("input",{type:"checkbox",checked:e.isSelected},t).addEventListener("change",(function(e){!function e(t,o){t.isSelected=o,t.items.forEach(t=>{e(t,o)})}(e.target.parentNode.dictItem,e.target.checked),i.textContent="",h($n.dictionary)}),!1)}if(0===e.filterTagsArray.length){w.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:e.isExpanded?"▼":"▶"},t).addEventListener("click",(function(e){e.target.parentNode.dictItem.isExpanded=!e.target.parentNode.dictItem.isExpanded,i.textContent="",h($n.dictionary)}),!1)}w.create("text",{value:e.name},t),e.isExpanded&&e.items.forEach(h),s--}function m(){v(),$n.dictionary.isExpanded=!1,i.textContent="",h($n.dictionary),n=w.create("div",{className:"TravelNotes-WaitAnimation"},t),w.create("div",{className:"TravelNotes-WaitAnimationBullet"},n),$n.search()}function p(e){e.items.forEach(p),e.isSelected=!1}function b(){p($n.dictionary),i.textContent="",h($n.dictionary)}function y(e){e.items.forEach(y),e.isExpanded=!0}function T(){y($n.dictionary),i.textContent="",h($n.dictionary)}function x(e){e.items.forEach(x),e.isRoot||(e.isExpanded=!1)}function L(){x($n.dictionary),i.textContent="",h($n.dictionary)}function I(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*c[e.deltaMode]),e.stopPropagation()}function j(e,t){t&&w.create("div",{textContent:t},e)}function P(t){let o=w.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",osmElement:t,objId:N()},e),a="";a=t.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+t.tags.rcn_ref+"</text></svg></div>":jt.getIconDataFromName(t.description)||"";let n=w.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},o);f.sanitizeToHtmlElement(a,n);let r=w.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},o);j(r,t.description),j(r,t.tags.name),j(r,t.tags.rcn_ref),j(r,function(e){let t=(e.tags["addr:street"]?(e.tags["addr:housenumber"]?e.tags["addr:housenumber"]+" ":"")+e.tags["addr:street"]+" ":"")+(e.tags["addr:city"]?(e.tags["addr:postcode"]?e.tags["addr:postcode"]+" ":"")+e.tags["addr:city"]:"");return""===t?null:t}(t)),t.tags.phone&&j(r,"☎️ : "+t.tags.phone),t.tags.email&&w.create("a",{href:"mailto:"+t.tags.email,textContent:t.tags.email},w.create("div",{textContent:"📧 : "},r)),t.tags.website&&w.create("a",{href:t.tags.website,target:"_blank",textContent:t.tags.website},w.create("div",null,r)),o.title="";for(const[e,a]of Object.entries(t.tags))o.title+=e+"="+a+"\n";o.addEventListener("contextmenu",d,!1),o.addEventListener("mouseenter",u,!1),o.addEventListener("mouseleave",g,!1)}return new class{constructor(){Object.freeze(this)}remove(){$n.hide(),v(),i&&(t.removeChild(i),i=null),o&&t.removeChild(o),n&&(t.removeChild(n),n=null),De.dispatch("removeobject",{objId:l})}add(){$n.show(),o=w.create("div",null,t),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("OsmSearchPaneUI - Search OpenStreetMap"),textContent:"🔎"},o).addEventListener("click",m,!1),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("OsmSearchPaneUI - Expand tree"),textContent:"▼"},o).addEventListener("click",T,!1),w.create("div",{className:"TravelNotes-UI-Button",title:E.getText("OsmSearchPaneUI - Collapse tree"),textContent:"▶"},o).addEventListener("click",L,!1),w.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:E.getText("OsmSearchPaneUI - Clear tree"),textContent:"❌"},o).addEventListener("click",b,!1),i=w.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"},t),i.addEventListener("wheel",I,!1),$n.dictionary.name="",h($n.dictionary),he.searchData.forEach(P)}getId(){return a.searchPane}getButtonText(){return E.getText("PanesManagerUI - Search")}setPaneDivs(o,a){e=o,t=a}}}let er=null,tr=!1,or=null,ar=null;function nr(){or&&(clearTimeout(or),or=null),er.classList.remove("TravelNotes-UI-Minimized"),ar.classList.add("TravelNotes-Hidden");let e=er.childNodes;for(let t=1;t<e.length;t++)e[t].classList.remove("TravelNotes-Hidden")}function rr(){er.classList.add("TravelNotes-UI-Minimized"),ar.classList.remove("TravelNotes-Hidden");let e=er.childNodes;for(let t=1;t<e.length;t++)e[t].classList.add("TravelNotes-Hidden")}function ir(){or=setTimeout(rr,y.travelEditor.timeout)}function lr(){tr?(er.addEventListener("mouseenter",nr,!1),er.addEventListener("mouseleave",ir,!1)):(er.removeEventListener("mouseenter",nr,!1),er.removeEventListener("mouseleave",ir,!1)),tr=!tr}const sr=new class{constructor(){Object.freeze(this)}createUI(e){if(!er){if(er=w.create("div",{id:"TravelNotes-UI-MainDiv"},e),er.pin=lr,ar=w.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"Travel & Notes"},er),Un.createUI(er),on.createUI(er),un.addPane(Bn()),un.addPane(function(){let e=0,t=null,o=null;function n(t){t.stopPropagation();try{t.dataTransfer.setData("Text",t.target.dataObjId),t.dataTransfer.dropEffect="move"}catch(e){e instanceof Error&&console.error(e)}e=t.target.noteObjId}function i(e){e.preventDefault()}function l(t){t.preventDefault();let o=t.target;for(;!o.noteObjId;)o=o.parentElement;let a=o.getBoundingClientRect();oo.travelNoteDropped(e,o.noteObjId,t.clientY-a.top<a.bottom-t.clientY)}function s(e){e.stopPropagation(),e.preventDefault();let o=e.target;for(;!o.noteObjId;)o=o.parentNode;e.latlng={lat:r.defaultValue,lng:r.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY,latLng:o.latLng},o.noteObjId&&(e.noteObjId=o.noteObjId,zo(e,t.parentNode).show())}return new class{constructor(){Object.freeze(this)}remove(){o&&(o.childNodes.forEach(e=>{e.removeEventListener("contextmenu",s,!1),e.removeEventListener("dragstart",n,!1)}),t.removeChild(o)),o=null}add(){o=_t.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),o.addEventListener("drop",l,!1),o.addEventListener("dragover",i,!1),t.appendChild(o),o.childNodes.forEach(e=>{e.draggable=!0,e.addEventListener("contextmenu",s,!1),e.addEventListener("dragstart",n,!1),e.classList.add("TravelNotes-UI-MoveCursor")})}getId(){return a.travelNotesPane}getButtonText(){return E.getText("PanesManagerUI - Travel notes")}setPaneDivs(e){t=e}}}()),un.addPane(Qn()),un.createUI(er),Ln.createUI(er),y.travelEditor.startMinimized){er.addEventListener("mouseenter",nr,!1),er.addEventListener("mouseleave",ir,!1),er.classList.add("TravelNotes-UI-Minimized");let e=er.childNodes;for(let t=1;t<e.length;t++)e[t].classList.add("TravelNotes-Hidden")}else ar.classList.add("TravelNotes-Hidden"),tr=!0;er.addEventListener("travelnameupdated",()=>on.setTravelName(),!1),er.addEventListener("setrouteslist",()=>on.setRoutesList(),!1),er.addEventListener("showitinerary",()=>un.showPane(a.itineraryPane),!1),er.addEventListener("updateitinerary",()=>un.updatePane(a.itineraryPane),!1),er.addEventListener("showtravelnotes",()=>un.showPane(a.travelNotesPane),!1),er.addEventListener("updatetravelnotes",()=>un.updatePane(a.travelNotesPane),!1),er.addEventListener("showsearch",()=>un.showPane(a.searchPane),!1),er.addEventListener("updatesearch",()=>un.updatePane(a.searchPane),!1),er.addEventListener("providersadded",()=>Ln.providersAdded(),!1),er.addEventListener("setprovider",e=>{e.data&&e.data.provider&&(Ln.provider=e.data.provider)},!1),er.addEventListener("settransitmode",e=>{e.data&&e.data.provider&&(Ln.transitMode=e.data.transitMode)},!1),document.addEventListener("geolocationstatuschanged",e=>{Un.geoLocationStatusChanged(e.data.status)},!1),er.addEventListener("click",e=>{e.target.id&&"TravelNotes-UI-MainDiv"===e.target.id&&(e.stopPropagation(),e.preventDefault())},!1),er.addEventListener("dblclick",e=>{e.stopPropagation(),e.preventDefault()},!1),er.addEventListener("contextmenu",e=>{e.stopPropagation(),e.preventDefault()},!1),er.addEventListener("wheel",e=>{e.stopPropagation(),e.preventDefault()},!1)}}};function dr(){let e=pe();e.title=E.getText("AboutDialog - About Travel & Notes");f.sanitizeToHtmlElement('<div id="TravelNotes-AboutDialog-AboutDiv"><p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2021 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/blog/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank">https://github.com/wwwouaiebe/leaflet.TravelNotes</a></p><p>Version : 2.2.0.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p></div>',e.content),e.show().then().catch(e=>{e instanceof Error&&console.error(e)})}let cr=null;const ur=new class{constructor(){Object.freeze(this)}getOpenPromise(){return new Promise((function(e,t){if(cr)return void e();let o=window.indexedDB.open("TravelNotesDb",1);o.onerror=function(){cr=null,t(new Error("Not possible to open the db"))},o.onsuccess=function(t){cr=t.target.result,e()},o.onupgradeneeded=function(e){cr=e.target.result,cr.createObjectStore("Travels",{keyPath:"UUID"})}}))}getReadPromise(e){return new Promise((function(t,o){if(!cr)return void o(new Error("Database not opened"));let a=cr.transaction(["Travels"],"readonly");a.onerror=function(){o(new Error("Transaction error"))},a.objectStore("Travels").get(e).onsuccess=function(e){t(e.target.result?e.target.result.data:null)}}))}getWritePromise(e,t){return new Promise((function(o,a){if(!cr)return void a(new Error("Database not opened"));let n=null;try{n=cr.transaction(["Travels"],"readwrite")}catch(e){return void a(e)}n.onerror=function(){a(new Error("Transaction error"))},n.objectStore("Travels").put({UUID:e,data:t}).onsuccess=function(){o()}}))}closeDb(e){if(!cr)return;if(!e)return cr.close(),void(cr=null);let t=cr.transaction(["Travels"],"readwrite");t.onerror=function(){};let o=t.objectStore("Travels").delete(e);o.onerror=function(){cr.close(),cr=null},o.onsuccess=function(){cr.close(),cr=null}}};let gr=!1;function vr(){document.addEventListener("routeupdated",e=>{e.data&&ma.updateRoute(e.data.removedRouteObjId,e.data.addedRouteObjId)},!1),document.addEventListener("routepropertiesupdated",e=>{e.data&&ma.updateRouteProperties(e.data.routeObjId)},!1),document.addEventListener("noteupdated",e=>{e.data&&ma.updateNote(e.data.removedNoteObjId,e.data.addedNoteObjId)},!1),document.addEventListener("removeobject",e=>{e.data&&ma.removeObject(e.data.objId)},!1),document.addEventListener("removeallobjects",()=>ma.removeAllObjects(),!1),document.addEventListener("zoomto",e=>{e.data&&Xo.zoomTo(e.data.latLng,e.data.geometry)},!1),document.addEventListener("additinerarypointmarker",e=>{e.data&&ma.addItineraryPointMarker(e.data.objId,e.data.latLng)},!1),document.addEventListener("addsearchpointmarker",e=>{e.data&&ma.addSearchPointMarker(e.data.objId,e.data.latLng,e.data.geometry)},!1),document.addEventListener("addrectangle",e=>{e.data&&ma.addRectangle(e.data.objId,e.data.bounds,e.data.properties)},!1),document.addEventListener("addwaypoint",e=>{e.data&&ma.addWayPoint(e.data.wayPoint,e.data.letter)},!1),document.addEventListener("layerchange",e=>{e.data&&ma.setLayer(e.data.layer)}),document.addEventListener("geolocationpositionchanged",e=>{e.data&&Xo.onGeolocationPositionChanged(e.data.position)},!1),document.addEventListener("geolocationstatuschanged",e=>{e.data&&Xo.onGeolocationStatusChanged(e.data.status)},!1),document.addEventListener("roadbookupdate",()=>(Pa.saveStatus=e.modified,void(j.storageAvailable("localStorage")&&ur.getOpenPromise().then(()=>{ur.getWritePromise(he.UUID,_t.getTravelHTML("TravelNotes-Roadbook-").outerHTML)}).then(()=>localStorage.setItem(he.UUID,Date.now())).catch(e=>{e instanceof Error&&console.error(e)}))),!1),document.addEventListener("profileclosed",e=>{e.data&&io.onProfileClosed(e.data.objId)},!1)}function hr(e){he.travel.readOnly||function(e){let t=[e.latlng.lat,e.latlng.lng],o=_e();return dt(e,[{context:Bo,name:E.getText("MapContextMenu - Select this point as start point"),action:-1!==he.editedRouteObjId&&r.defaultValue===he.travel.editedRoute.wayPoints.first.lat?Bo.setStartPoint:null,param:t},{context:Bo,name:E.getText("MapContextMenu - Select this point as way point"),action:-1===he.editedRouteObjId?null:Bo.addWayPoint,param:t},{context:Bo,name:E.getText("MapContextMenu - Select this point as end point"),action:-1!==he.editedRouteObjId&&r.defaultValue===he.travel.editedRoute.wayPoints.last.lat?Bo.setEndPoint:null,param:t},{context:ko,name:E.getText("MapContextMenu - Add a route"),action:ko.addRoute},{context:ko,name:E.getText("MapContextMenu - Hide all routes"),action:ko.hideRoutes},{context:ko,name:E.getText("MapContextMenu - Show all routes"),action:ko.showRoutes},{context:oo,name:E.getText("MapContextMenu - New travel note"),action:oo.newTravelNote,param:t},{context:oo,name:E.getText("MapContextMenu - Hide all notes"),action:oo.hideNotes},{context:oo,name:E.getText("MapContextMenu - Show all notes"),action:oo.showNotes},{context:o,name:E.getText("MapContextMenu - Zoom to travel"),action:o.zoomToTravel},{context:null,name:E.getText("MapContextMenu - About Travel & Notes"),action:dr}])}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file IndexedDb.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/(e).show()}const mr=new class{constructor(){Object.freeze(this)}addReadOnlyMap(e,t){gr||(gr=!0,vr(),e&&(he.map=e),lo.createUI(),Po.setLayer("OSM - Color"),async function(e){let t=fetch(e);if(200===t.status&&t.ok){let e=await t.json();Ca().openDistantFile(e)}else he.map.setView([r.defaultValue,r.defaultValue],2),document.title="Travel & Notes"}(t))}addControl(t,o){gr||(gr=!0,vr(),window.addEventListener("unload",()=>{localStorage.removeItem(he.UUID)}),window.addEventListener("beforeunload",e=>(ur.closeDb(he.UUID),e.returnValue="x","x")),t&&(he.map=t,he.map.on("contextmenu",hr)),he.travel=de(),he.travel.routes.add(ne()),sr.createUI(document.getElementById(o)),lo.createUI(),Be.setKeysFromServerFile(),y.layersToolbarUI.haveLayersToolbarUI?Po.createUI():Po.setLayer("OSM - Color"),y.mouseUI.haveMouseUI&&Pa.createUI(),y.travelEditor.startupRouteEdition&&ko.editRoute(he.travel.routes.first.objId),De.dispatch("setrouteslist"),De.dispatch("roadbookupdate"),he.map.setView([y.map.center.lat,y.map.center.lng],y.map.zoom),je.showHelp("<p>"+E.getText("Help - Continue with interface1")+"</p><p>"+E.getText("Help - Continue with interface2")+"</p>"),document.title="Travel & Notes",Pa.saveStatus=e.saved)}addProvider(e){Be.addProvider(e)}showInfo(e){je.showInfo(e)}get baseDialog(){return pe()}get map(){return he.map}get maneuver(){return F()}get itineraryPoint(){return U()}get version(){return"2.2.0"}};!function(){let e=null,t=null,o="",a=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes";async function n(){let t=await Promise.allSettled([fetch(a+e.toUpperCase()+".json"),fetch(a+"EN.json"),fetch(a+"NoteDialog"+e.toUpperCase()+".json"),fetch(a+"NoteDialogEN.json"),fetch(a+"SearchDictionary"+e.toUpperCase()+".csv"),fetch(a+"SearchDictionaryEN.csv"),fetch(a+"Layers.json")]);o=await async function(t,o){return"fulfilled"===t.status&&200===t.value.status&&t.value.ok?(E.setTranslations(await t.value.json()),""):"fulfilled"===o.status&&200===o.value.status&&o.value.ok?(E.setTranslations(await o.value.json()),"Not possible to load the TravelNotes"+e.toUpperCase()+".json file. English will be used. "):"Not possible to load the translations. "}(t[0],t[1]),o+=await async function(t,o){if("fulfilled"===t.status&&200===t.value.status&&t.value.ok){let e=await t.value.json();return jt.selectOptions=e.preDefinedIconsList,e.preDefinedIconsList.forEach(e=>{e.name=f.sanitizeToJsString(e.name)}),jt.buttons=e.editionButtons,""}if("fulfilled"===o.status&&200===o.value.status&&o.value.ok){let t=await o.value.json();return jt.selectOptions=t.preDefinedIconsList,t.preDefinedIconsList.forEach(e=>{e.name=f.sanitizeToJsString(e.name)}),jt.buttons=t.editionButtons,"Not possible to load the TravelNotesNoteDialog"+e.toUpperCase()+".json file. English will be used. "}return"Not possible to load the translations for the note dialog. "}(t[2],t[3]),o+=await async function(t,o){return"fulfilled"===t.status&&200===t.value.status&&t.value.ok?($n.parseDictionary(await t.value.text()),""):"fulfilled"===o.status&&200===o.value.status&&o.value.ok?($n.parseDictionary(await o.value.text()),"Not possible to load the TravelNotesSearchDictionary"+e.toUpperCase()+".csv file. English will be used. "):"Not possible to load the search dictionary. OSM search will not be available."}(t[4],t[5]),o+=await async function(e){return"fulfilled"===e.status&&200===e.value.status&&e.value.ok?(Po.addLayers(await e.value.json()),""):"Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. "}(t[6]),""!==o&&(je.showWarning(o),o="")}!async function(){window.TaN=mr,window.L&&(window.L.travelNotes=window.TaN),function(){let o=new URL(window.location),a=o.searchParams.get("fil");if(a&&0!==a.length)try{if(a=atob(a),a.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");let e=new URL(a);if(!(o.protocol&&e.protocol&&o.protocol===e.protocol&&o.hostname&&e.hostname&&o.hostname===e.hostname))throw new Error("The distant file is not on the same site than the app");t=encodeURI(e.href)}catch(e){e instanceof Error&&console.error(e)}let n=o.searchParams.get("lng");n&&n.match(/^[A-Z,a-z]{2}$/)&&(e=n.toLowerCase())}(),await async function(){let t=await fetch(a+"Config.json");if(200===t.status&&t.ok){let o=await t.json();return o.language=e||o.language,"wwwouaiebe.github.io"===window.location.hostname&&(o.layersToolbarUI.theDevil.addButton=!1,o.noteDialog.theDevil.addButton=!1,o.errorUI.showHelp=!0,o.printRouteMap.maxTiles=120,o.note.maxManeuversNotes=10,o.note.haveBackground=!0,o.APIKeys.dialogHaveUnsecureButtons=!0,o.route.showDragTooltip=-1),y.overload(o),he.providers.forEach(e=>{e.userLanguage=y.language}),!0}return!1}()?(e=e||y.language||"fr",je.createUI(),await n(),function(){if(y.autoLoad&&""===o){w.create("div",{id:"TravelNotes-Map"},document.querySelector("body")),w.create("div",{id:"TravelNotes-UI"},document.querySelector("body"));let e=window.L.map("TravelNotes-Map",{attributionControl:!1,zoomControl:!1}).setView([r.defaultValue,r.defaultValue],0);t?mr.addReadOnlyMap(e,t):mr.addControl(e,"TravelNotes-UI")}}()):je.showError("Not possible to load the TravelNotesConfig.json file. ")}()}()}();